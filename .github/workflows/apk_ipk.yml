name: "æ„å»º Tailscaleï¼ˆAPK + IPK å¹¶è¡Œï¼‰"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

permissions:
  contents: write

jobs:
  # ========================================
  # Job 1: æ£€æŸ¥ç‰ˆæœ¬å¹¶å‡†å¤‡æºç 
  # ========================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: "æ£€æŸ¥ç‰ˆæœ¬"
        id: version
        run: |
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/tags" | jq -r '.[0].name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"
          
          if [ "$upstream" = "$current" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "version=$(echo $upstream | sed 's/^v//')" >> $GITHUB_OUTPUT
            echo "tag=$upstream" >> $GITHUB_OUTPUT
          fi

      - name: "æ‹‰å–å¹¶ä¿®æ”¹æºç "
        if: steps.version.outputs.skip == 'false'
        run: |
          git clone https://github.com/asvow/luci-app-tailscale luci-app-tailscale
          cd luci-app-tailscale
          
          # 1. Makefile
          sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
          
          # 2. é…ç½®
          sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" root/etc/config/tailscale
          
          # 3. init.d
          sed -i 's|/var/lib/tailscale|/var/run/tailscale|g' root/etc/init.d/tailscale
          sed -i '/rm -rf "$CONFIG_PATH"/i\	# åªåˆ é™¤ä¸´æ—¶ç›®å½•' root/etc/init.d/tailscale
          
          # 4. JS
          sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" htdocs/luci-static/resources/view/tailscale/setting.js
          
          # 5. uci-defaults
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          D="/etc/config/tailscale_data"
          [ -f "$D/.initialized" ] && grep -q "config tailscale 'settings'" /etc/config/tailscale 2>/dev/null && grep -q "option config_path '$D'" /etc/config/tailscale && exit 0
          rm -f /etc/config/tailscale-opkg
          [ -f /etc/config/tailscale ] && {
            sed -i "s|^config settings|config tailscale|g;/option state_file/d;s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
            grep -q "option accept_dns" /etc/config/tailscale || sed -i "/option fw_mode/a\\	option accept_dns '1'" /etc/config/tailscale
            [ -f /etc/tailscale/tailscaled.state ] && { mkdir -p "$D"; cp -a /etc/tailscale/tailscaled.state "$D/"; }
          }
          mkdir -p "$D" && touch "$D/.initialized"
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null; uci -q commit ucitrack 2>/dev/null
          rm -f /tmp/luci-indexcache
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - name: "ä¸Šä¼ æºç "
        if: steps.version.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: luci-app-tailscale/
          retention-days: 1

  # ========================================
  # Job 2: å¹¶è¡Œç¼–è¯‘ APK å’Œ IPK
  # ========================================
  build:
    needs: prepare
    if: needs.prepare.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk: SNAPSHOT
            pkg_type: apk
            
          - arch: x86_64
            sdk: openwrt-24.10
            pkg_type: ipk

    name: "${{ matrix.sdk }}-${{ matrix.arch }}-${{ matrix.pkg_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: "ä¸‹è½½æºç "
        uses: actions/download-artifact@v4
        with:
          name: source
          path: luci-app-tailscale

      - name: "æ„å»ºåŒ…"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-immortalwrt-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.pkg_type }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*luci*tailscale*.${{ matrix.pkg_type }}

      - name: "æ‰“åŒ…å¹¶å‘å¸ƒ"
        run: |
          cd bin/packages/${{ matrix.arch }}/packages_ci
          tar -czf ../../../../${{ matrix.pkg_type }}-packages.tar.gz *luci*tailscale*.${{ matrix.pkg_type }}

      - name: "ä¸Šä¼ åˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          name: ${{ needs.prepare.outputs.tag }}
          tag: ${{ needs.prepare.outputs.tag }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "${{ matrix.pkg_type }}-packages.tar.gz"
          body: |
            ## ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `apk-packages.tar.gz` - ImmortalWrt ä¸»çº¿
            - `ipk-packages.tar.gz` - ImmortalWrt 24.10

            ## ğŸ“¥ å®‰è£…
            ```bash
            # APK
            apk add --allow-untrusted luci-app-tailscale*.apk
            
            # IPK
            opkg install luci-app-tailscale*.ipk
            ```

            ## ğŸ”§ é…ç½®ä¿æŠ¤
            - é…ç½®: `/etc/config/tailscale`
            - æ•°æ®: `/etc/config/tailscale_data/`

            ç‰ˆæœ¬: ${{ needs.prepare.outputs.tag }}
