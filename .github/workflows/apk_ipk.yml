name: "æ„å»º Tailscaleï¼ˆAPK + IPK å¹¶è¡Œï¼‰"

on:
  workflow_dispatch:
  #schedule:
    # - cron: '0 23 * * *'

permissions:
  contents: write

jobs:
  # ========================================
  # ä»»åŠ¡ 1: æ£€æŸ¥ç‰ˆæœ¬å¹¶å‡†å¤‡æºç 
  # ========================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      build_time: ${{ steps.build_time.outputs.time }}
    steps:
      - uses: actions/checkout@v4

      - name: "æ£€æŸ¥ç‰ˆæœ¬"
        id: version
        run: |
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/tags" | jq -r '.[0].name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          if [ "$upstream" = "$current" ]; then
            echo "ç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°ç‰ˆæœ¬: $upstream"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "version=$(echo $upstream | sed 's/^v//')" >> $GITHUB_OUTPUT
            echo "tag=$upstream" >> $GITHUB_OUTPUT
          fi

      - name: "ç”Ÿæˆæ„å»ºæ—¶é—´"
        id: build_time
        if: steps.version.outputs.skip == 'false'
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: "æ‹‰å–å¹¶ä¿®æ”¹æºç "
        if: steps.version.outputs.skip == 'false'
        run: |
          git clone https://github.com/asvow/luci-app-tailscale luci-app-tailscale
          cd luci-app-tailscale
          
          # Makefile
          sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
          
          # é…ç½®å’Œè„šæœ¬
          sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" root/etc/config/tailscale root/etc/init.d/tailscale htdocs/luci-static/resources/view/tailscale/setting.js
          sed -i 's|/var/lib/tailscale|/var/run/tailscale|g' root/etc/init.d/tailscale
          sed -i '/rm -rf "$CONFIG_PATH"/i\	# åªåˆ é™¤ä¸´æ—¶ç›®å½•' root/etc/init.d/tailscale
          
          # uci-defaults
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          D="/etc/config/tailscale_data"
          [ -f "$D/.initialized" ] && grep -q "config tailscale 'settings'" /etc/config/tailscale 2>/dev/null && grep -q "option config_path '$D'" /etc/config/tailscale && exit 0
          rm -f /etc/config/tailscale-opkg
          [ -f /etc/config/tailscale ] && {
            sed -i "s|^config settings|config tailscale|g;/option state_file/d;s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
            grep -q "option accept_dns" /etc/config/tailscale || sed -i "/option fw_mode/a\\	option accept_dns '1'" /etc/config/tailscale
            [ -f /etc/tailscale/tailscaled.state ] && { mkdir -p "$D"; cp -a /etc/tailscale/tailscaled.state "$D/"; }
          }
          mkdir -p "$D" && touch "$D/.initialized"
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null; uci -q commit ucitrack 2>/dev/null
          rm -f /tmp/luci-indexcache
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale
          
          echo "æºç ä¿®æ”¹å®Œæˆ"

      - name: "ä¸Šä¼ æºç "
        if: steps.version.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: luci-app-tailscale/

  # ========================================
  # ä»»åŠ¡ 2: å¹¶è¡Œç¼–è¯‘ APK å’Œ IPK
  # ========================================
  build:
    needs: prepare
    if: needs.prepare.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk: SNAPSHOT
            pkg_type: apk
            
          - arch: x86_64
            sdk: openwrt-24.10
            pkg_type: ipk

    name: "${{ matrix.sdk }}-${{ matrix.pkg_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: "ä¸‹è½½æºç "
        uses: actions/download-artifact@v4
        with:
          name: source
          path: luci-app-tailscale

      - name: "ç¼–è¯‘"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "æ”¶é›†äº§ç‰©"
        id: collect
        run: |
          mkdir -p output
          find bin/packages/${{ matrix.arch }}/packages_ci -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp -v {} output/ \;
          
          # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
          FILES=$(ls output/)
          COUNT=$(echo "$FILES" | wc -l)
          SIZE=$(du -sh output | awk '{print $1}')
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.pkg_type }}
          path: output/*

      - name: "å‘å¸ƒåˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare.outputs.tag }}
          name: "luci-app-tailscale ${{ needs.prepare.outputs.version }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "output/*"
          body: |
            ## ğŸ“¦ ä¸‹è½½æ–‡ä»¶
            
            ç›´æ¥ä¸‹è½½ APK æˆ– IPK æ–‡ä»¶å³å¯å®‰è£…ã€‚
            
            ## ğŸ“¥ å®‰è£…æ–¹æ³•
            
            **APK æ ¼å¼ï¼ˆOpenWrt ä¸»çº¿ï¼‰ï¼š**
            ```bash
            # ä¸‹è½½æ–‡ä»¶
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/luci-app-tailscale-*.apk
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/luci-i18n-tailscale-zh-cn-*.apk
            
            # å®‰è£…
            apk add --allow-untrusted luci-app-tailscale-*.apk
            apk add --allow-untrusted luci-i18n-tailscale-zh-cn-*.apk  # å¯é€‰
            ```
            
            **IPK æ ¼å¼ï¼ˆOpenWrt 24.10ï¼‰ï¼š**
            ```bash
            # ä¸‹è½½æ–‡ä»¶
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/luci-app-tailscale_*_all.ipk
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/luci-i18n-tailscale-zh-cn_*_all.ipk
            
            # å®‰è£…
            opkg install luci-app-tailscale_*_all.ipk
            opkg install luci-i18n-tailscale-zh-cn_*_all.ipk  # å¯é€‰
            ```
            
            ## ğŸ”§ é…ç½®è¯´æ˜
            
            - é…ç½®æ–‡ä»¶ï¼š`/etc/config/tailscale`
            - æ•°æ®ç›®å½•ï¼š`/etc/config/tailscale_data/`
            - æˆæƒæ–‡ä»¶ï¼š`/etc/config/tailscale_data/tailscaled.state`
            
            **ç‰¹æ€§ï¼š**
            - âœ… é‡æ–°å®‰è£…æ—¶è‡ªåŠ¨ä¿ç•™é…ç½®
            - âœ… å›ºä»¶å‡çº§æ—¶ä¿ç•™é…ç½®å’Œæˆæƒ
            - âœ… è‡ªåŠ¨ä¿®å¤å®˜æ–¹åŒ…é…ç½®é—®é¢˜
            
            ---
            
            **ç‰ˆæœ¬ï¼š** ${{ needs.prepare.outputs.tag }} | **æ„å»ºæ—¶é—´ï¼š** ${{ needs.prepare.outputs.build_time }} CST

  # ========================================
  # ä»»åŠ¡ 3: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
  # ========================================
  report:
    needs: [prepare, build]
    if: always() && needs.prepare.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è½½äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: packages

      - name: "ç”ŸæˆæŠ¥å‘Š"
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          # æ„å»ºæŠ¥å‘Š
          
          ## åŸºæœ¬ä¿¡æ¯
          
          | é¡¹ç›® | å€¼ |
          |------|-----|
          | ç‰ˆæœ¬ | `${{ needs.prepare.outputs.tag }}` |
          | æ„å»ºæ—¶é—´ | ${{ needs.prepare.outputs.build_time }} CST |
          | å·¥ä½œæµ | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | Release | [${{ needs.prepare.outputs.tag }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}) |
          
          ## ç¼–è¯‘çŠ¶æ€
          
          | åŒ…ç±»å‹ | å¹³å° | çŠ¶æ€ | æ–‡ä»¶æ•° | æ€»å¤§å° |
          |--------|------|------|--------|--------|
          EOF
          
          # APK çŠ¶æ€
          if [ -d "packages/packages-apk" ]; then
            APK_COUNT=$(find packages/packages-apk -type f | wc -l)
            APK_SIZE=$(du -sh packages/packages-apk | awk '{print $1}')
            APK_STATUS="âœ… æˆåŠŸ"
          else
            APK_COUNT="0"
            APK_SIZE="-"
            APK_STATUS="âŒ å¤±è´¥"
          fi
          echo "| APK | OpenWrt ä¸»çº¿ (SNAPSHOT) | $APK_STATUS | $APK_COUNT | $APK_SIZE |" >> $GITHUB_STEP_SUMMARY
          
          # IPK çŠ¶æ€
          if [ -d "packages/packages-ipk" ]; then
            IPK_COUNT=$(find packages/packages-ipk -type f | wc -l)
            IPK_SIZE=$(du -sh packages/packages-ipk | awk '{print $1}')
            IPK_STATUS="âœ… æˆåŠŸ"
          else
            IPK_COUNT="0"
            IPK_SIZE="-"
            IPK_STATUS="âŒ å¤±è´¥"
          fi
          echo "| IPK | OpenWrt 24.10 | $IPK_STATUS | $IPK_COUNT | $IPK_SIZE |" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## æ–‡ä»¶åˆ—è¡¨
          
          ### APK åŒ…
          
          | æ–‡ä»¶å | å¤§å° | ä¸‹è½½ |
          |--------|------|------|
          EOF
          
          if [ -d "packages/packages-apk" ]; then
            find packages/packages-apk -type f | while read file; do
              filename=$(basename "$file")
              filesize=$(ls -lh "$file" | awk '{print $5}')
              download_url="[$filename](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/$filename)"
              echo "| \`$filename\` | $filesize | $download_url |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "| - | - | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### IPK åŒ…
          
          | æ–‡ä»¶å | å¤§å° | ä¸‹è½½ |
          |--------|------|------|
          EOF
          
          if [ -d "packages/packages-ipk" ]; then
            find packages/packages-ipk -type f | while read file; do
              filename=$(basename "$file")
              filesize=$(ls -lh "$file" | awk '{print $5}')
              download_url="[$filename](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag }}/$filename)"
              echo "| \`$filename\` | $filesize | $download_url |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "| - | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

  # ========================================
  # ä»»åŠ¡ 4: åŒæ­¥åˆ° Giteeï¼ˆå¯é€‰ï¼‰
  # ========================================
  gitee:
    needs: [prepare, build]
    if: needs.prepare.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "åŒæ­¥åˆ° Gitee"
        continue-on-error: true
        run: |
          if [ -f .github/scripts/release-gitee.sh ]; then
            chmod +x .github/scripts/release-gitee.sh
            .github/scripts/release-gitee.sh \
              "whzhni/luci-app-tailscale" \
              "${{ secrets.GITEE_TOKEN }}" \
              "${{ needs.prepare.outputs.tag }}" \
              "${{ needs.prepare.outputs.version }}" \
              "${{ needs.prepare.outputs.build_time }}" \
              "${{ github.repository }}" \
              "luci-app-tailscale"
          fi
