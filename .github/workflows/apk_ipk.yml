name: "APK + IPK"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ è®¾ç½®ç‰ˆæœ¬å·å’Œ tag"
        id: version
        run: |
          set -e
          ver="1.2.6"
          base="v${ver}-persistent"
          resp=$(curl -s -o /tmp/tag.json -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$base")
          if [ "$resp" = "200" ]; then
            suffix=$(date -u +%Y%m%d-%H%M%S)
            base="${base}-${suffix}"
          fi
          echo "version=$ver" >> $GITHUB_OUTPUT
          echo "tag=$base" >> $GITHUB_OUTPUT

      - name: "3ï¸âƒ£ æ‹‰å– luci-app-tailscale æºç å¹¶åšæŒä¹…åŒ–æ›¿æ¢"
        run: |
          set -e
          SRC_DIR=$PWD/src/luci-app-tailscale
          mkdir -p src
          git clone https://github.com/asvow/luci-app-tailscale "$SRC_DIR"
          cd "$SRC_DIR"
          sed -i "s|/etc/tailscale|/etc/config/tailscale-data|g" $(grep -rl "/etc/tailscale" .)
          echo "SRC_DIR=$SRC_DIR" >> $GITHUB_ENV

      - name: "4ï¸âƒ£ ä¸‹è½½ ImmortalWrt ä¸»çº¿ SDK"
        run: |
          set -e
          SDK_URL="https://downloads.immortalwrt.org/snapshots/targets/x86/generic/immortalwrt-sdk-x86-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
          curl -LO "$SDK_URL"
          tar --use-compress-program=unzstd -xf "$(basename "$SDK_URL")"
          SDK_DIR=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" -print -quit)
          mv "$SDK_DIR" immortalwrt-sdk
          echo "SDK_DIR=$PWD/immortalwrt-sdk" >> $GITHUB_ENV

      - name: "5ï¸âƒ£ åˆå§‹åŒ– SDK ç¯å¢ƒ"
        run: |
          set -e
          cd "$SDK_DIR"
          
          echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          cp -r "$SRC_DIR" package/luci-app-tailscale

      - name: "6ï¸âƒ£ ç¼–è¯‘ IPK æ ¼å¼"
        run: |
          set -e
          cd "$SDK_DIR"
          
          # é…ç½®ä¸º IPK æ¨¡å¼ï¼ˆä¸å¯ç”¨ APKï¼‰
          cat > .config <<EOF
          CONFIG_PACKAGE_luci-app-tailscale=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y
          EOF
          
          make defconfig
          make package/luci-app-tailscale/compile V=s -j2
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s -j2 || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s -j2 || true
          make package/index V=s
          
          # ä¿å­˜ IPK æ–‡ä»¶
          mkdir -p ../out
          cp -v bin/packages/*/*tailscale*.ipk ../out/ 2>/dev/null || true
          
          echo "=== IPK æ–‡ä»¶å·²æ”¶é›† ==="
          ls -lh ../out/

      - name: "7ï¸âƒ£ åˆ‡æ¢åˆ° APK æ¨¡å¼å¹¶é‡æ–°æ‰“åŒ…"
        run: |
          set -e
          cd "$SDK_DIR"
          
          # é‡æ–°é…ç½®ä¸º APK æ¨¡å¼
          cat > .config <<EOF
          CONFIG_TARGET_PACKAGING_APK=y
          CONFIG_PACKAGE_luci-app-tailscale=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y
          EOF
          
          make defconfig
          
          # æ¸…ç†æ—§çš„åŒ…ç´¢å¼•ï¼Œé‡æ–°ç”Ÿæˆï¼ˆè¿™ä¼šè½¬æ¢ä¸º APKï¼‰
          rm -rf bin/packages/*/base/Packages*
          make package/index V=s
          
          # ä¿å­˜ APK æ–‡ä»¶
          cp -v bin/packages/*/*tailscale*.apk ../out/ 2>/dev/null || true
          
          echo "=== APK æ–‡ä»¶å·²æ”¶é›† ==="
          ls -lh ../out/

      - name: "8ï¸âƒ£ æœ€ç»ˆäº§ç‰©æ£€æŸ¥"
        if: always()
        run: |
          echo "=== æœ€ç»ˆäº§ç‰©åˆ—è¡¨ ==="
          ls -lh out/ || true
          echo ""
          echo "=== IPK æ–‡ä»¶ ==="
          ls -lh out/*.ipk 2>/dev/null || echo "æœªæ‰¾åˆ° IPK"
          echo ""
          echo "=== APK æ–‡ä»¶ ==="
          ls -lh out/*.apk 2>/dev/null || echo "æœªæ‰¾åˆ° APK"

      - name: "9ï¸âƒ£ å‘å¸ƒ Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.version.outputs.tag }}"
          name: "luci-app-tailscale ${{ steps.version.outputs.version }}ï¼ˆImmortalWrt APK + IPKï¼‰"
          files: "out/*"
          body: |
            ## ğŸ“¦ åŒ…å«æ–‡ä»¶
            - **IPK æ ¼å¼**ï¼šé€‚ç”¨äºä¼ ç»Ÿ OpenWrt/ImmortalWrt (opkg)
            - **APK æ ¼å¼**ï¼šé€‚ç”¨äº ImmortalWrt ä¸»çº¿æ–°ç‰ˆ (apk)
            
            ## ğŸ”§ æŒä¹…åŒ–é…ç½®
            - æ•°æ®è·¯å¾„ï¼š`/etc/config/tailscale-data`
            
            ## ğŸ“¥ å®‰è£…æ–¹æ³•
            ```bash
            # IPK æ–¹å¼ï¼ˆä¼ ç»Ÿç³»ç»Ÿï¼‰
            opkg install luci-app-tailscale*.ipk
            
            # APK æ–¹å¼ï¼ˆæ–°ç‰ˆç³»ç»Ÿï¼‰
            apk add --allow-untrusted luci-app-tailscale*.apk
            ```
