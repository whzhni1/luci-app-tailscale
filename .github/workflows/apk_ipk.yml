name: "æž„å»º Tailscaleï¼ˆAPK + IPK å¹¶è¡Œï¼‰"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

permissions:
  contents: write

jobs:
  # ========================================
  # Job 1: æ£€æŸ¥ç‰ˆæœ¬
  # ========================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: "æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬"
        id: version
        run: |
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/tags" | jq -r '.[0].name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"
          
          if [ "$upstream" = "$current" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "version=$(echo $upstream | sed 's/^v//')" >> $GITHUB_OUTPUT
            echo "tag=$upstream" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # Job 2: å¹¶è¡Œç¼–è¯‘
  # ========================================
  build:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    name: "${{ matrix.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ImmortalWrt-ä¸»çº¿(APK)"
            target: "x86/generic"
            sdk_url: "https://downloads.immortalwrt.org/snapshots/targets/x86/generic/immortalwrt-sdk-x86-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            pkg_type: "apk"
            
          - name: "ImmortalWrt-24.10(IPK)"
            target: "x86/64"
            sdk_url: "https://downloads.immortalwrt.org/releases/24.10.0/targets/x86/64/immortalwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            pkg_type: "ipk"

    steps:
      - name: "æ‹‰å–å¹¶ä¿®æ”¹æºç "
        run: |
          git clone https://github.com/asvow/luci-app-tailscale src
          cd src
          
          # 1. Makefile
          sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
          
          # 2. é…ç½®
          sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" root/etc/config/tailscale
          
          # 3. init.d
          sed -i 's|/var/lib/tailscale|/var/run/tailscale|g' root/etc/init.d/tailscale
          
          # 4. JS
          sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" htdocs/luci-static/resources/view/tailscale/setting.js
          
          # 5. uci-defaults
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          DATA_DIR="/etc/config/tailscale_data"
          [ -f "$DATA_DIR/.initialized" ] && grep -q "config tailscale 'settings'" /etc/config/tailscale 2>/dev/null && exit 0
          rm -f /etc/config/tailscale-opkg
          [ -f /etc/config/tailscale ] && {
            sed -i "s|^config settings|config tailscale|g;/option state_file/d;s|'/etc/tailscale'|'$DATA_DIR'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$DATA_DIR'" /etc/config/tailscale
            grep -q "option accept_dns" /etc/config/tailscale || sed -i "/option fw_mode/a\\	option accept_dns '1'" /etc/config/tailscale
            [ -f /etc/tailscale/tailscaled.state ] && { mkdir -p "$DATA_DIR"; cp -a /etc/tailscale/tailscaled.state "$DATA_DIR/"; }
          }
          mkdir -p "$DATA_DIR" && touch "$DATA_DIR/.initialized"
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null; uci -q commit ucitrack 2>/dev/null
          rm -f /tmp/luci-indexcache
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - name: "ä¸‹è½½å¹¶è§£åŽ‹ SDK"
        run: |
          curl -LO "${{ matrix.sdk_url }}"
          tar --use-compress-program=unzstd -xf *.tar.zst
          mv immortalwrt-sdk-* sdk

      - name: "ç¼–è¯‘"
        working-directory: sdk
        run: |
          # é…ç½® feeds
          cat > feeds.conf <<EOF
          src-git packages https://github.com/immortalwrt/packages.git
          src-git luci https://github.com/immortalwrt/luci.git
          EOF
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # å¤åˆ¶æºç 
          cp -r ../src package/luci-app-tailscale
          
          # é…ç½®
          cat > .config <<EOF
          ${{ matrix.pkg_type == 'apk' && 'CONFIG_TARGET_PACKAGING_APK=y' || '' }}
          CONFIG_PACKAGE_luci-app-tailscale=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=m
          EOF
          make defconfig
          
          # ç¼–è¯‘
          make package/luci-app-tailscale/compile V=s -j$(nproc)
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s -j$(nproc) || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s -j$(nproc) || true
          
          # æ”¶é›†
          mkdir -p ../output
          find bin/packages -name "luci-*tailscale*.${{ matrix.pkg_type }}" -exec cp {} ../output/ \;

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.pkg_type }}
          path: output/*

      - name: "æ‰“åŒ…å¹¶ä¸Šä¼ åˆ° Release"
        run: |
          cd output
          tar -czf ../${{ matrix.pkg_type }}-packages.tar.gz *
          
      - name: "å‘å¸ƒåˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.tag }}
          name: "luci-app-tailscale ${{ needs.check-version.outputs.version }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "${{ matrix.pkg_type }}-packages.tar.gz"
          body: |
            ## ðŸ“¦ ä¸‹è½½
            - `apk-packages.tar.gz` - ImmortalWrt ä¸»çº¿
            - `ipk-packages.tar.gz` - ImmortalWrt 24.10
            
            ## ðŸ“¥ å®‰è£…
            ```bash
            # APK
            apk add --allow-untrusted luci-app-tailscale*.apk
            
            # IPK
            opkg install luci-app-tailscale*.ipk
            ```
            
            ## ðŸ”§ é…ç½®ä¿æŠ¤
            - é…ç½®: `/etc/config/tailscale`
            - æ•°æ®: `/etc/config/tailscale_data/`
            - æŽˆæƒ: `/etc/config/tailscale_data/tailscaled.state`

  # ========================================
  # Job 3: åŒæ­¥ Giteeï¼ˆå¯é€‰ï¼‰
  # ========================================
  gitee:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.skip == 'false'
    steps:
      - uses: actions/checkout@v4
      
      - name: "ä¸‹è½½äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          path: packages
          
      - name: "åŒæ­¥åˆ° Gitee"
        continue-on-error: true
        run: |
          [ -f .github/scripts/release-gitee.sh ] && {
            chmod +x .github/scripts/release-gitee.sh
            .github/scripts/release-gitee.sh \
              "whzhni/luci-app-tailscale" \
              "${{ secrets.GITEE_TOKEN }}" \
              "${{ needs.check-version.outputs.tag }}" \
              "${{ needs.check-version.outputs.version }}" \
              "$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" \
              "${{ github.repository }}" \
              "luci-app-tailscale"
          }
