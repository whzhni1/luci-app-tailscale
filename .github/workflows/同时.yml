name: "Tailscaleï¼ˆAPK + IPK å¹¶è¡Œç¼–è¯‘ï¼‰"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

permissions:
  contents: write

jobs:
  # ========================================
  # Job 1: æ£€æŸ¥ç‰ˆæœ¬
  # ========================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.version.outputs.skip }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: "æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°"
        id: version
        run: |
          set -e
          
          echo "ğŸ“¥ è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬..."
          upstream_latest=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/tags" | jq -r '.[0].name // "none"')
          
          if [ "$upstream_latest" = "none" ] || [ "$upstream_latest" = "null" ]; then
            echo "âŒ æ— æ³•è·å–ä¸Šæ¸¸ç‰ˆæœ¬"
            exit 1
          fi
          
          echo "ğŸ“¦ è·å–å½“å‰ä»“åº“ç‰ˆæœ¬..."
          my_latest=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          if [ "$my_latest" = "none" ] || [ "$my_latest" = "null" ]; then
            my_latest="none"
          fi
          
          echo ""
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $upstream_latest"
          echo "å½“å‰ç‰ˆæœ¬: $my_latest"
          echo ""
          
          if [ "$upstream_latest" = "$my_latest" ]; then
            echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œè·³è¿‡æ„å»º"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ†• å‘ç°æ–°ç‰ˆæœ¬ï¼Œå¼€å§‹æ„å»º"
            echo "skip=false" >> $GITHUB_OUTPUT
            version_number=$(echo "$upstream_latest" | sed 's/^v//')
            echo "version=$version_number" >> $GITHUB_OUTPUT
            echo "tag=$upstream_latest" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # Job 2: å‡†å¤‡æºç ï¼ˆå•ç‹¬ jobï¼‰
  # ========================================
  prepare-source:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "æ‹‰å–å¹¶ä¿®æ”¹æºç "
        run: |
          set -e
          
          echo "ğŸ“¥ å…‹éš†æºç ..."
          git clone https://github.com/asvow/luci-app-tailscale src
          cd src
          
          echo "ğŸ”§ å¼€å§‹ä¿®æ”¹..."
          
          # 1. ä¿®æ”¹ Makefile
          if ! grep -q "define Package/luci-app-tailscale/conffiles" Makefile; then
            sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
            echo "âœ… Makefile å·²ä¿®æ”¹"
          fi
          
          # 2. ä¿®æ”¹é»˜è®¤é…ç½®
          sed -i "s|option config_path '/etc/tailscale'|option config_path '/etc/config/tailscale_data'|g" root/etc/config/tailscale
          
          # 3. ä¿®æ”¹ init.d
          sed -i 's|^CONFIG_PATH=/var/lib/tailscale|CONFIG_PATH=/var/run/tailscale|g' root/etc/init.d/tailscale
          sed -i '/rm -rf "$CONFIG_PATH"/i\	# åªåˆ é™¤ä¸´æ—¶ç›®å½•ï¼Œä¿æŠ¤æ•°æ®ç›®å½•' root/etc/init.d/tailscale
          
          # 4. ä¿®æ”¹ JS
          sed -i "s|o.default = '/etc/tailscale';|o.default = '/etc/config/tailscale_data';|g" htdocs/luci-static/resources/view/tailscale/setting.js
          
          # 5. ç”Ÿæˆ uci-defaults
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          DATA_DIR="/etc/config/tailscale_data"
          INIT_FLAG="$DATA_DIR/.initialized"
          
          if [ -f "$INIT_FLAG" ] && [ -f /etc/config/tailscale ]; then
          	if grep -q "^config tailscale 'settings'" /etc/config/tailscale && \
          	   grep -q "option config_path '$DATA_DIR'" /etc/config/tailscale; then
          		rm -f /tmp/luci-indexcache
          		exit 0
          	fi
          fi
          
          rm -f /etc/config/tailscale-opkg
          
          if [ -f /etc/config/tailscale ]; then
          	NEED_FIX=0
          	
          	if grep -q "^config settings 'settings'" /etc/config/tailscale; then
          		sed -i "s|^config settings 'settings'|config tailscale 'settings'|g" /etc/config/tailscale
          		NEED_FIX=1
          	fi
          	
          	if grep -q "option state_file" /etc/config/tailscale; then
          		sed -i "/^\s*option state_file/d" /etc/config/tailscale
          		NEED_FIX=1
          	fi
          	
          	if grep -q "option config_path '/etc/tailscale'" /etc/config/tailscale; then
          		sed -i "s|option config_path '/etc/tailscale'|option config_path '$DATA_DIR'|g" /etc/config/tailscale
          		NEED_FIX=1
          		if [ -d /etc/tailscale ] && [ -f /etc/tailscale/tailscaled.state ]; then
          			mkdir -p "$DATA_DIR"
          			cp -a /etc/tailscale/tailscaled.state "$DATA_DIR/" 2>/dev/null
          		fi
          	fi
          	
          	if ! grep -q "option config_path" /etc/config/tailscale; then
          		sed -i "/option port/a\\	option config_path '$DATA_DIR'" /etc/config/tailscale
          		NEED_FIX=1
          	fi
          	
          	if ! grep -q "option accept_dns" /etc/config/tailscale; then
          		sed -i "/option fw_mode/a\\	option accept_dns '1'" /etc/config/tailscale
          	fi
          fi
          
          mkdir -p "$DATA_DIR"
          touch "$INIT_FLAG"
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null
          uci -q commit ucitrack 2>/dev/null
          rm -f /tmp/luci-indexcache
          exit 0
          EOF
          
          chmod +x root/etc/uci-defaults/40_luci-tailscale
          echo "âœ… æºç ä¿®æ”¹å®Œæˆ"
          
      - name: "ä¸Šä¼ æºç "
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: src/
          retention-days: 1

  # ========================================
  # Job 3: å¹¶è¡Œç¼–è¯‘ APK å’Œ IPK
  # ========================================
  build:
    needs: [check-version, prepare-source]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ImmortalWrt-ä¸»çº¿-APK"
            sdk_url: "https://downloads.immortalwrt.org/snapshots/targets/x86/generic/immortalwrt-sdk-x86-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            pkg_type: "apk"
            config_extra: "CONFIG_TARGET_PACKAGING_APK=y"
            
          - name: "ImmortalWrt-24.10-IPK"
            sdk_url: "https://downloads.immortalwrt.org/releases/24.10.0/targets/x86/64/immortalwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            pkg_type: "ipk"
            config_extra: ""
            
    name: "${{ matrix.name }}"
    
    steps:
      - name: "ä¸‹è½½æºç "
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: luci-app-tailscale
          
      - name: "ä¸‹è½½å¹¶è§£å‹ SDK"
        run: |
          set -e
          echo "ğŸ“¥ ä¸‹è½½ SDK..."
          curl -LO "${{ matrix.sdk_url }}"
          echo "ğŸ“¦ è§£å‹ SDK..."
          tar --use-compress-program=unzstd -xf "$(basename "${{ matrix.sdk_url }}")"
          SDK_DIR=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" -print -quit)
          mv "$SDK_DIR" sdk
          echo "âœ… SDK å‡†å¤‡å®Œæˆ"
          
      - name: "ç¼–è¯‘ ${{ matrix.pkg_type }}"
        run: |
          set -e
          cd sdk
          
          echo "ğŸ“ é…ç½® feeds..."
          cat > feeds.conf <<EOF
          src-git packages https://github.com/immortalwrt/packages.git
          src-git luci https://github.com/immortalwrt/luci.git
          EOF
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "ğŸ“¦ å¤åˆ¶æºç ..."
          cp -r ../luci-app-tailscale package/
          
          echo "âš™ï¸  ç”Ÿæˆé…ç½®..."
          cat > .config <<EOF
          ${{ matrix.config_extra }}
          CONFIG_PACKAGE_luci-app-tailscale=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=m
          EOF
          
          make defconfig
          
          echo "ğŸ”¨ ç¼–è¯‘ ${{ matrix.pkg_type }}..."
          make package/luci-app-tailscale/{clean,compile} V=s -j$(nproc) IGNORE_ERRORS=m
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/{clean,compile} V=s -j$(nproc) IGNORE_ERRORS=m || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/{clean,compile} V=s -j$(nproc) IGNORE_ERRORS=m || true
          
          echo "ğŸ“¦ æ”¶é›†äº§ç‰©..."
          mkdir -p ../output
          find bin/packages -type f -name "*.${MATRIX_PKG_TYPE}" | while read file; do
            basename=$(basename "$file")
            if [[ "$basename" == luci-app-tailscale* ]] || [[ "$basename" == luci-i18n-tailscale* ]]; then
              cp -v "$file" ../output/
            fi
          done
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
        env:
          MATRIX_PKG_TYPE: ${{ matrix.pkg_type }}
          
      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.pkg_type }}
          path: output/*
          retention-days: 1
          if-no-files-found: error

  # ========================================
  # Job 4: å‘å¸ƒ Release
  # ========================================
  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        
      - name: "ä¸‹è½½æ‰€æœ‰äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: artifacts
          merge-multiple: true
          
      - name: "æ£€æŸ¥äº§ç‰©"
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©ï¼š"
          ls -lh artifacts/
          
      - name: "ç”Ÿæˆæ„å»ºæ—¶é—´"
        id: build_time
        run: |
          BUILD_TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
      - name: "å‘å¸ƒåˆ° GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ needs.check-version.outputs.tag }}"
          name: "luci-app-tailscale ${{ needs.check-version.outputs.version }}"
          files: "artifacts/*"
          body: |
            ## ğŸ“¦ åŒ…å«æ–‡ä»¶
            - **APK æ ¼å¼**ï¼šImmortalWrt ä¸»çº¿
            - **IPK æ ¼å¼**ï¼šImmortalWrt 24.10

            ## ğŸ”§ æŒä¹…åŒ–é…ç½®
            - é…ç½®æ–‡ä»¶ï¼š`/etc/config/tailscale`
            - æ•°æ®ç›®å½•ï¼š`/etc/config/tailscale_data/`
            - æˆæƒæ–‡ä»¶ï¼š`/etc/config/tailscale_data/tailscaled.state`

            ## ğŸ“¥ å®‰è£…æ–¹æ³•
            ```bash
            # APK (ä¸»çº¿)
            apk add --allow-untrusted luci-app-tailscale*.apk
            
            # IPK (24.10)
            opkg install luci-app-tailscale*.ipk
            ```

            ## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯
            - ä¸Šæ¸¸ç‰ˆæœ¬: ${{ needs.check-version.outputs.tag }}
            - æ„å»ºæ—¶é—´: ${{ steps.build_time.outputs.time }} CST

      - name: "åŒæ­¥åˆ° Gitee"
        continue-on-error: true
        run: |
          if [ -f .github/scripts/release-gitee.sh ]; then
            chmod +x .github/scripts/release-gitee.sh
            .github/scripts/release-gitee.sh \
              "whzhni/luci-app-tailscale" \
              "${{ secrets.GITEE_TOKEN }}" \
              "${{ needs.check-version.outputs.tag }}" \
              "${{ needs.check-version.outputs.version }}" \
              "${{ steps.build_time.outputs.time }}" \
              "${{ github.repository }}" \
              "luci-app-tailscale"
          fi
