name: 同步代码到 Gitee 和 GitCode

on:
  push:
    branches:
      - main
    paths-ignore:        # 忽略 .github 目录的改动，不触发工作流
      - '.github/**'
  workflow_dispatch:

env:
  BRANCH: main
  USERNAME: whzhni
  REPO: luci-app-tailscale

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: 检出 GitHub 仓库代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 设置 Git 用户信息
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 移除 .github 文件夹
        run: |
          rm -rf .github
          git rm -r --cached .github || true

      - name: 添加 Gitee 远程仓库
        run: |
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.USERNAME }}/${{ env.REPO }}.git

      - name: 推送代码到 Gitee
        run: |
          if git push gitee ${{ env.BRANCH }} --force; then
            echo "✅ 推送到 Gitee 成功"
          else
            echo "❌ 推送到 Gitee 失败"
            exit 1
          fi

      - name: 添加 GitCode 远程仓库
        run: |
          git remote add gitcode https://oauth2:${{ secrets.GITCODE_TOKEN }}@gitcode.com/${{ env.USERNAME }}/${{ env.REPO }}.git

      - name: 推送代码到 GitCode
        run: |
          if git push gitcode ${{ env.BRANCH }} --force; then
            echo "✅ 推送到 GitCode 成功"
          else
            echo "❌ 推送到 GitCode 失败"
            exit 1
          fi
