name: "ÊûÑÂª∫ Tailscale + LuCIÔºàÂÆåÊï¥ÁâàÔºâ"

on:
  workflow_dispatch:
    inputs:
      enable_compression:
        description: 'ÂêØÁî® UPX ÂéãÁº©'
        required: true
        type: boolean
        default: true
  schedule:
    - cron: '0 16 * * *'

permissions:
  contents: write

env:
  TAILSCALE_REPO: "tailscale/tailscale"
  LUCI_REPO: "asvow/luci-app-tailscale"
  ENABLE_COMPRESSION: ${{ github.event_name == 'schedule' || inputs.enable_compression == true }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      version: ${{ steps.check.outputs.version }}
      current_version: ${{ steps.check.outputs.current_version }}
      build_time: ${{ steps.time.outputs.time }}
      luci_version: ${{ steps.luci.outputs.version }}
    steps:
      - name: "Ê£ÄÊü•ÁâàÊú¨"
        id: check
        run: |
          upstream=$(curl -s "https://api.github.com/repos/${{ env.TAILSCALE_REPO }}/releases/latest" | jq -r '.tag_name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          echo "‰∏äÊ∏∏: $upstream | ÂΩìÂâç: $current"
          cat >> $GITHUB_OUTPUT <<EOF
          version=$upstream
          current_version=$current
          skip=$( [ "$upstream" = "$current" ] && echo true || echo false )
          EOF

      - name: "Ëé∑Âèñ LuCI ÁâàÊú¨"
        id: luci
        run: echo "version=$(curl -s "https://api.github.com/repos/${{ env.LUCI_REPO }}/releases/latest" | jq -r '.tag_name // "none"')" >> $GITHUB_OUTPUT

      - name: "ÁîüÊàêÊûÑÂª∫Êó∂Èó¥"
        id: time
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  build-tailscale:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { id: arm, goarch: arm, targets: '["arm_arm1176jzf-s_vfp","arm_arm926ej-s","arm_cortex-a15_neon-vfpv4","arm_cortex-a5_vfpv4","arm_cortex-a7","arm_cortex-a7_neon-vfpv4","arm_cortex-a7_vfpv4","arm_cortex-a8_vfpv3","arm_cortex-a9","arm_cortex-a9_neon","arm_cortex-a9_vfpv3-d16","arm_fa526","arm_xscale","arm_mpcore"]' }
          - { id: arm64, goarch: arm64, targets: '["aarch64_cortex-a53","aarch64_cortex-a72","aarch64_cortex-a76","aarch64_generic"]' }
          - { id: mips, goarch: mips, gomips: softfloat, targets: '["mips_24kc","mips_4kec","mips_mips32"]' }
          - { id: mipsle, goarch: mipsle, gomips: softfloat, targets: '["mipsel_24kc","mipsel_24kc_24kf","mipsel_74kc","mipsel_mips32"]' }
          - { id: mips64, goarch: mips64, gomips: softfloat, targets: '["mips64_mips64r2","mips64_octeonplus"]' }
          - { id: mips64le, goarch: mips64le, gomips: softfloat, targets: '["mips64el_mips64r2"]' }
          - { id: "386", goarch: "386", targets: '["i386_pentium-mmx","i386_pentium4"]' }
          - { id: amd64, goarch: amd64, cgo: "1", cc: musl-gcc, setup: "sudo apt-get update && sudo apt-get install -y musl-tools", targets: '["x86_64"]' }
          - { id: geode, goarch: "386", go386: softfloat, targets: '["i386_geode"]' }
    name: "Tailscale-${{ matrix.id }}"
    steps:
      - name: "ÁéØÂ¢ÉÂáÜÂ§á"
        if: matrix.setup
        run: ${{ matrix.setup }}

      - name: "Ê£ÄÂá∫Ê∫êÁ†Å"
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAILSCALE_REPO }}
          ref: ${{ needs.check-version.outputs.version }}
          path: src

      - name: "ËÆæÁΩÆ Go"
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: "ÂÆâË£Ö UPX"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          VER=$(curl -s https://api.github.com/repos/upx/upx/releases/latest | jq -r '.tag_name')
          wget -q "https://github.com/upx/upx/releases/download/${VER}/upx-${VER#v}-amd64_linux.tar.xz"
          tar -xf upx-*.tar.xz && sudo mv upx-*/upx /usr/local/bin/

      - name: "ÁºñËØë"
        working-directory: src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips || '' }}
          GO386: ${{ matrix.go386 || '' }}
          CGO_ENABLED: ${{ matrix.cgo || '0' }}
          CC: ${{ matrix.cc || '' }}
        run: |
          eval $(CGO_ENABLED=0 GOOS=$(go env GOHOSTOS) GOARCH=$(go env GOHOSTARCH) go run ./cmd/mkversion)
          mkdir -p ../build
          go build -tags "ts_include_cli,ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_completion,ts_omit_ssh,ts_omit_wakeonlan,ts_omit_capture,ts_omit_relayserver,ts_omit_systray,ts_omit_taildrop,ts_omit_tpm,ts_omit_syspolicy,ts_omit_debugeventbus,ts_omit_webclient" \
            -ldflags "-X tailscale.com/version.longStamp=${VERSION_LONG} -X tailscale.com/version.shortStamp=${VERSION_SHORT} -s -w" \
            -trimpath -o "../build/tailscaled-linux-${{ matrix.id }}" ./cmd/tailscaled

      - name: "ÂéãÁº©"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          bin="build/tailscaled-linux-${{ matrix.id }}"
          [[ "${{ matrix.id }}" =~ ^(mips64|mips64le)$ ]] && exit 0
          upx --lzma --best "$bin" || true

      - name: "‰∏ãËΩΩÈÖçÁΩÆ"
        run: |
          mkdir -p config_files
          git clone --depth=1 https://github.com/${{ env.LUCI_REPO }} /tmp/luci-source
          
          cp /tmp/luci-source/root/etc/init.d/tailscale config_files/tailscale.init || exit 1
          cp /tmp/luci-source/root/etc/config/tailscale config_files/tailscale.conf || exit 1
          cp /tmp/luci-source/root/usr/sbin/tailscale_helper config_files/tailscale_helper || exit 1
          
          # Áªü‰∏ÄÊõøÊç¢Ë∑ØÂæÑ
          for f in config_files/*; do
            sed -i "s|/usr/bin/tailscale|/usr/sbin/tailscale|g" "$f"
            sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" "$f"
            sed -i "s|/etc/tailscale|/etc/config/tailscale_data|g" "$f"
          done
          
          # ÂèñÊ∂à 4 ‰∏™ access Ê≥®ÈáäÔºàÂêØÁî®ÈªòËÆ§Èò≤ÁÅ´Â¢ôËßÑÂàôÔºâ
          sed -i "s|#list access 'ts_ac_lan'|list access 'ts_ac_lan'|g" config_files/tailscale.conf
          sed -i "s|#list access 'ts_ac_wan'|list access 'ts_ac_wan'|g" config_files/tailscale.conf
          sed -i "s|#list access 'lan_ac_ts'|list access 'lan_ac_ts'|g" config_files/tailscale.conf
          sed -i "s|#list access 'wan_ac_ts'|list access 'wan_ac_ts'|g" config_files/tailscale.conf
          
          # È™åËØÅ
          grep -q "/usr/sbin/tailscaled" config_files/tailscale.init || exit 1
          grep -q "/etc/config/tailscale_data" config_files/tailscale.conf || exit 1
          grep -q "list access 'ts_ac_lan'" config_files/tailscale.conf || exit 1
          grep -q "list access 'wan_ac_ts'" config_files/tailscale.conf || exit 1
          
          chmod +x config_files/tailscale.init config_files/tailscale_helper

      - name: "ÊâìÂåÖ"
        run: |
          set -e
          VERSION=$(echo "${{ needs.check-version.outputs.version }}" | sed 's/^v//')
          mkdir -p ipk/{usr/{sbin,bin},etc/{config,init.d},CONTROL} output
          
          install -m 0755 "build/tailscaled-linux-${{ matrix.id }}" ipk/usr/sbin/tailscaled
          install -m 0755 config_files/tailscale_helper ipk/usr/sbin/tailscale_helper
          ln -sf tailscaled ipk/usr/sbin/tailscale
          ln -sf ../sbin/tailscaled ipk/usr/bin/tailscaled
          ln -sf ../sbin/tailscale ipk/usr/bin/tailscale
          install -m 0644 config_files/tailscale.conf ipk/etc/config/tailscale
          install -m 0755 config_files/tailscale.init ipk/etc/init.d/tailscale
          
          cat > ipk/CONTROL/prerm <<'EOF'
          #!/bin/sh
          [ "$PKG_UPGRADE" = "1" ] || exit 0
          [ -x /etc/init.d/tailscale ] || exit 0
          /etc/init.d/tailscale enabled && touch /tmp/.tailscale_was_enabled
          pgrep -x tailscaled >/dev/null && touch /tmp/.tailscale_was_running
          exit 0
          EOF
          
          cat > ipk/CONTROL/postinst <<'EOF'
          #!/bin/sh
          [ -x /etc/init.d/tailscale ] || exit 0
          if [ -f /tmp/.tailscale_was_enabled ]; then
            /etc/init.d/tailscale enable
            rm -f /tmp/.tailscale_was_enabled
            [ -f /tmp/.tailscale_was_running ] && /etc/init.d/tailscale start && rm -f /tmp/.tailscale_was_running
          elif [ -d /etc/config/tailscale_data ]; then
            /etc/init.d/tailscale enable
            /etc/init.d/tailscale start
          fi
          exit 0
          EOF
          chmod +x ipk/CONTROL/prerm ipk/CONTROL/postinst
          
          SIZE=$(stat -c%s ipk/usr/sbin/tailscaled)
          echo '2.0' > debian-binary
          
          echo '${{ matrix.targets }}' | jq -r '.[]' | while read ARCH; do
            cat > ipk/CONTROL/control <<EOF
          Package: tailscale
          Version: ${VERSION}
          Depends: ca-bundle, kmod-tun
          Provides: tailscaled
          Source: https://github.com/tailscale/tailscale
          License: BSD-3-Clause
          Section: net
          Architecture: ${ARCH}
          Installed-Size: ${SIZE}
          Maintainer: Automated Build <https://github.com/${{ github.repository }}>
          Description: Tailscale VPN client (LuCI compatible)
          EOF
            echo "/etc/config/tailscale" > ipk/CONTROL/conffiles
            
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/tailscale_${VERSION}_${ARCH}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            mkdir -p apk-build && cp -r ipk/* apk-build/
            cat > apk-build/.PKGINFO <<EOF
          pkgname = tailscale
          pkgver = ${VERSION}
          pkgdesc = Tailscale VPN client
          url = https://tailscale.com
          arch = ${ARCH}
          license = BSD-3-Clause
          size = ${SIZE}
          depend = ca-bundle
          depend = kmod-tun
          provides = tailscaled
          EOF
            tar -czf "output/tailscale-${VERSION}-r1.${ARCH}.apk" -C apk-build .
            rm -rf apk-build control.tar.gz data.tar.gz
          done

      - name: "‰∏ä‰º†"
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.id }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  build-luci:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { sdk: SNAPSHOT, pkg_type: apk }
          - { sdk: openwrt-24.10, pkg_type: ipk }
    name: "LuCI-${{ matrix.pkg_type }}"
    steps:
      - uses: actions/checkout@v4

      - name: "ÂáÜÂ§áÊ∫êÁ†Å"
        run: |
          git clone https://github.com/${{ env.LUCI_REPO }} luci-app-tailscale
          cd luci-app-tailscale
          
          rm -rf root/etc/init.d root/usr/sbin root/etc/config 2>/dev/null || true
          
          find . -type f \( -name "*.js" -o -name "*.lua" -o -name "*.sh" \) | while read f; do
            sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" "$f"
          done
          
          git clone --depth=1 https://github.com/${{ env.LUCI_REPO }} /tmp/luci-orig
          
          # Â§ÑÁêÜËÑöÊú¨Âπ∂ base64 ÁºñÁ†Å
          INIT_SCRIPT=$(sed "s|/usr/bin/tailscale|/usr/sbin/tailscale|g; s|'/etc/tailscale'|'/etc/config/tailscale_data'|g; s|/etc/tailscale|/etc/config/tailscale_data|g" /tmp/luci-orig/root/etc/init.d/tailscale | base64 -w0)
          HELPER_SCRIPT=$(sed "s|/usr/bin/tailscale|/usr/sbin/tailscale|g; s|'/etc/tailscale'|'/etc/config/tailscale_data'|g; s|/etc/tailscale|/etc/config/tailscale_data|g" /tmp/luci-orig/root/usr/sbin/tailscale_helper | base64 -w0)
          CONFIG_FILE=$(sed "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g; s|/etc/tailscale|/etc/config/tailscale_data|g; s|#list access|list access|g" /tmp/luci-orig/root/etc/config/tailscale | base64 -w0)
          
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<EOFSCRIPT
          #!/bin/sh
          
          DATA_DIR="/etc/config/tailscale_data"
          mkdir -p "\$DATA_DIR"
          
          # ========================================
          # ‰øÆÂ§çÈÖçÁΩÆÊñá‰ª∂
          # ========================================
          if [ -f /etc/config/tailscale ]; then
            # IMM Ê†ºÂºèËΩ¨Êç¢
            if grep -q "^config settings" /etc/config/tailscale; then
              sed -i "s|^config settings|config tailscale|g" /etc/config/tailscale
              sed -i "/option state_file/d" /etc/config/tailscale
            fi
            # Ë∑ØÂæÑ‰øÆÂ§ç
            sed -i "s|'/etc/tailscale'|'\$DATA_DIR'|g; s|/etc/tailscale|\$DATA_DIR|g" /etc/config/tailscale
            # config_path ‰øÆÂ§ç
            grep -q "option config_path" /etc/config/tailscale || \
              sed -i "/option port/a\\	option config_path '\$DATA_DIR'" /etc/config/tailscale
            # enabled ‰øÆÂ§çÔºàÁ°Æ‰øùÂ≠òÂú®Ôºâ
            grep -q "option enabled" /etc/config/tailscale || \
              sed -i "/config tailscale/a\\	option enabled '0'" /etc/config/tailscale
            # access ‰øÆÂ§çÔºàÂèñÊ∂àÊ≥®ÈáäÊàñÊ∑ªÂä†Ôºâ
            sed -i "s|#list access|list access|g" /etc/config/tailscale
            grep -q "list access 'ts_ac_lan'" /etc/config/tailscale || \
              echo "	list access 'ts_ac_lan'" >> /etc/config/tailscale
            grep -q "list access 'ts_ac_wan'" /etc/config/tailscale || \
              echo "	list access 'ts_ac_wan'" >> /etc/config/tailscale
            grep -q "list access 'lan_ac_ts'" /etc/config/tailscale || \
              echo "	list access 'lan_ac_ts'" >> /etc/config/tailscale
            grep -q "list access 'wan_ac_ts'" /etc/config/tailscale || \
              echo "	list access 'wan_ac_ts'" >> /etc/config/tailscale
          else
            echo "${CONFIG_FILE}" | base64 -d > /etc/config/tailscale
          fi
          
          # ========================================
          # ‰øÆÂ§ç init.dÔºàÊ£ÄÊµã IMM ÁâàÊú¨Ôºâ
          # ========================================
          if [ -f /etc/init.d/tailscale ]; then
            if ! grep -q "section_enabled" /etc/init.d/tailscale; then
              echo "${INIT_SCRIPT}" | base64 -d > /etc/init.d/tailscale
              chmod +x /etc/init.d/tailscale
            fi
          fi
          
          # ========================================
          # ÂÆâË£Ö tailscale_helper
          # ========================================
          if [ ! -f /usr/sbin/tailscale_helper ]; then
            echo "${HELPER_SCRIPT}" | base64 -d > /usr/sbin/tailscale_helper
            chmod +x /usr/sbin/tailscale_helper
          fi
          
          # ========================================
          # Ê∏ÖÁêÜ
          # ========================================
          uci -q batch <<-EOF >/dev/null
          	delete ucitrack.@tailscale[-1]
          	commit ucitrack
          EOF
          
          rm -f /tmp/luci-indexcache /tmp/luci-modulecache
          exit 0
          EOFSCRIPT
          
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - name: "ÁºñËØë"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: x86_64-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "Êî∂ÈõÜ"
        run: |
          mkdir -p output
          find bin/packages -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp {} output/ \;
          [ -n "$(ls -A output/)" ] || exit 1

      - name: "‰∏ä‰º†"
        uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.pkg_type }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  release:
    needs: [check-version, build-tailscale, build-luci]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "‰∏ãËΩΩ‰∫ßÁâ©"
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: "Êï¥ÁêÜ"
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.apk" -o -name "*.ipk" \) -exec cp {} release/ \;
          [ -n "$(ls -A release/)" ] || exit 1

      - name: "ÂèëÂ∏É"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.version }}
          name: "Tailscale ${{ needs.check-version.outputs.version }} + LuCI ${{ needs.check-version.outputs.luci_version }}"
          body: |
            | ÁªÑ‰ª∂ | ÁâàÊú¨ |
            |------|------|
            | Tailscale | ${{ needs.check-version.outputs.version }} |
            | LuCI | ${{ needs.check-version.outputs.luci_version }} |
            | ÊûÑÂª∫Êó∂Èó¥ | ${{ needs.check-version.outputs.build_time }} CST |
            | UPX ÂéãÁº© | ${{ env.ENABLE_COMPRESSION == 'true' && '‚úÖ' || '‚ùå' }} |
            
            üìñ **ÂÆâË£ÖËØ¥ÊòéËØ∑Êü•Áúã [README](https://github.com/${{ github.repository }}#readme)**
          artifacts: "release/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  report:
    needs: [check-version, build-tailscale, build-luci]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "Êä•Âëä"
        run: |
          if [ "${{ needs.check-version.outputs.skip }}" = "true" ]; then
            echo "# ‚è≠Ô∏è Ë∑≥ËøáÔºàÁâàÊú¨Áõ∏Âêå: ${{ needs.check-version.outputs.version }}Ôºâ" >> $GITHUB_STEP_SUMMARY
          else
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          # üéØ ÊûÑÂª∫Êä•Âëä
          | ÁªÑ‰ª∂ | ÁâàÊú¨ | Áä∂ÊÄÅ |
          |------|------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} | ${{ needs.build-tailscale.result == 'success' && '‚úÖ' || '‚ùå' }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} | ${{ needs.build-luci.result == 'success' && '‚úÖ' || '‚ùå' }} |
          
          **Êó∂Èó¥:** ${{ needs.check-version.outputs.build_time }} CST | **ÂéãÁº©:** ${{ env.ENABLE_COMPRESSION == 'true' && '‚úÖ' || '‚ùå' }}
          EOF
          fi
