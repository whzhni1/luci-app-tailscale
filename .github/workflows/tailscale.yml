name: Update Tailscale

on:
  schedule:
    - cron: '0 8 * * *'  # 每天 UTC 8点检查
  workflow_dispatch:      # 支持手动触发

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check and Update
        run: |
          # 获取版本
          LATEST=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r .tag_name | sed 's/^v//')
          CURRENT=$(sed -n 's/PKG_VERSION:=//p' tailscale/Makefile)
          
          echo "Latest: $LATEST | Current: $CURRENT"
          [ "$LATEST" = "$CURRENT" ] && exit 0
          
          # 计算 hash 并更新
          HASH=$(curl -sL "https://codeload.github.com/tailscale/tailscale/tar.gz/v${LATEST}" | sha256sum | cut -d' ' -f1)
          sed -i "s/PKG_VERSION:=.*/PKG_VERSION:=$LATEST/; s/PKG_HASH:=.*/PKG_HASH:=$HASH/" tailscale/Makefile
          
          # 提交
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -am "tailscale: update to $LATEST"
          git push
