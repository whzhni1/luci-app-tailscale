name: "è‡ªåŠ¨æ„å»º Tailscaleï¼ˆåŒæ ¼å¼ï¼šIPK + APKï¼Œå«è¯­è¨€åŒ…ï¼‰"

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Releases å’Œä¸Šä¼ èµ„äº§

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.check.outputs.need_build }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      release_tag: ${{ steps.tag.outputs.release_tag }}

    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç ï¼ˆç©ºä»“ä¹Ÿå¯ï¼Œåªéœ€ workflowï¼‰"
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬å¹¶ç”Ÿæˆå”¯ä¸€ tag"
        id: check
        run: |
          set -e
          echo "å¼€å§‹æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬..."
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/releases/latest" \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "è·å–å¤±è´¥")
          current=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>/dev/null \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "none")

          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"

          if [ "$upstream" = "è·å–å¤±è´¥" ]; then
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
          elif [ "$upstream" != "$current" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "latest_version=$upstream" >> $GITHUB_OUTPUT
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
          fi

      - name: "3ï¸âƒ£ ç”Ÿæˆå”¯ä¸€ release tagï¼ˆé¿å… 403 é‡å¤ï¼‰"
        id: tag
        run: |
          set -e
          base="${{ steps.check.outputs.latest_version }}-persistent"
          echo "æ‹Ÿç”¨ tag: $base"

          # æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨
          exists=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$base" | grep -c '"ref":')
          if [ "$exists" -gt 0 ]; then
            # æ·»åŠ æ—¶é—´åç¼€ï¼Œé¿å…é‡å¤
            suffix=$(date -u +%Y%m%d-%H%M%S)
            base="${base}-${suffix}"
            echo "tag å·²å­˜åœ¨ï¼Œæ”¹ç”¨: $base"
          fi

          echo "release_tag=$base" >> $GITHUB_OUTPUT

      # =========================
      # IPK æ„å»ºï¼ˆOpenWrt 22.03ï¼‰
      # =========================
      - name: "4ï¸âƒ£ å‡†å¤‡ OpenWrt 22.03 SDKï¼ˆIPKï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          echo "ä¸‹è½½ IPK SDK: $SDK_URL"
          curl -LO "$SDK_URL"
          tar -xJf "$(basename "$SDK_URL")"

          echo "=== å·¥ä½œç›®å½•ç»“æ„ï¼ˆIPKï¼‰ ==="
          ls -l

          SDK_DIR=$(realpath $(find . -maxdepth 1 -type d -name "openwrt-sdk-22.03.5-*"))
          echo "IPK SDK_DIR=$SDK_DIR"
          echo "IPK_SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

          cd "$SDK_DIR"
          echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
          echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
          echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
          echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install luci liblucihttp liblucihttp-ucode

          # æ‹‰å–ä¸Šæ¸¸æºç 
          git clone https://github.com/asvow/luci-app-tailscale package/luci-app-tailscale

          # ç§»é™¤ tailscale åŒ…é‡Œè‡ªå¸¦çš„ init/config å¼•ç”¨ï¼Œé¿å…å†²çªï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f feeds/packages/net/tailscale/Makefile ]; then
            sed -i '/\/etc\/init\.d\/tailscale/d;/\/etc\/config\/tailscale/d;' feeds/packages/net/tailscale/Makefile || true
          fi

          echo "=== IPK package ç›®å½•ç»“æ„ ==="
          ls -l package

      - name: "5ï¸âƒ£ IPKï¼šæŒä¹…åŒ–è·¯å¾„æ›¿æ¢ä¸æ ¡éªŒ"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$IPK_SDK_DIR/package/luci-app-tailscale"

          SOURCE="/etc/tailscale"
          TARGET="/etc/config/tailscale-data"
          echo "æ›¿æ¢ ${SOURCE} -> ${TARGET}ï¼ˆIPKï¼‰"

          find . -type f -exec grep -Il "${SOURCE}" {} \; | while read -r f; do
            echo "ä¿®æ”¹æ–‡ä»¶: $f"
            sed -i "s|${SOURCE}|${TARGET}|g" "$f"
          done

          echo "æ ¡éªŒæ›¿æ¢ï¼ˆIPKï¼‰ï¼š"
          grep -RIl "${TARGET}" . || echo "è­¦å‘Šï¼šæœªå‘ç°æ–°è·¯å¾„"

      - name: "6ï¸âƒ£ IPKï¼šç”Ÿæˆ .config å¹¶ç¼–è¯‘"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$IPK_SDK_DIR"
          {
            echo "CONFIG_ALL_KMODS=y"
            echo "CONFIG_ALL=y"
            # 22.03 ä¸æ”¯æŒ APK
            echo "CONFIG_PACKAGE_luci=y"
            echo "CONFIG_PACKAGE_liblucihttp=y"
            echo "CONFIG_PACKAGE_liblucihttp-ucode=y"
            echo "CONFIG_LUCI_LANG_zh-cn=y"
            echo "CONFIG_LUCI_LANG_zh-tw=y"
            echo "CONFIG_PACKAGE_luci-app-tailscale=y"
            echo "CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y"
            echo "CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y"
          } > .config
          make defconfig

          make package/luci-app-tailscale/compile V=s || make package/luci-app-tailscale/compile V=s
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s || true

      - name: "7ï¸âƒ£ IPKï¼šæ”¶é›†äº§ç‰©"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$IPK_SDK_DIR"
          IPK_OUT="${PWD}/out-ipk"
          mkdir -p "$IPK_OUT"
          find bin -type f -name "luci-app-tailscale_*_all.ipk" -exec cp -v {} "$IPK_OUT/" \;
          find bin -type f -name "luci-i18n-tailscale-zh-cn_*_all.ipk" -exec cp -v {} "$IPK_OUT/" \;
          find bin -type f -name "luci-i18n-tailscale-zh-tw_*_all.ipk" -exec cp -v {} "$IPK_OUT/" \;
          echo "IPK_OUT=$IPK_OUT" >> $GITHUB_ENV
          ls -lh "$IPK_OUT" || true

      # =========================
      # APK æ„å»ºï¼ˆOpenWrt 24.10ï¼‰
      # =========================
      - name: "8ï¸âƒ£ å‡†å¤‡ OpenWrt 24.10 SDKï¼ˆAPKï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          # 24.10 snapshot SDKï¼ˆç¤ºä¾‹ï¼ŒæŒ‰å®é™…ç›®æ ‡æ¶æ„è°ƒæ•´ï¼‰
          SDK_URL="https://downloads.openwrt.org/releases/24.10.0-rc1/targets/x86/64/openwrt-sdk-24.10.0-rc1-x86-64_gcc-13.2.0_musl.Linux-x86_64.tar.xz"
          echo "ä¸‹è½½ APK SDK: $SDK_URL"
          curl -LO "$SDK_URL"
          tar -xJf "$(basename "$SDK_URL")"

          echo "=== å·¥ä½œç›®å½•ç»“æ„ï¼ˆAPKï¼‰ ==="
          ls -l

          SDK_DIR=$(realpath $(find . -maxdepth 1 -type d -name "openwrt-sdk-24.*-x86-64_*"))
          echo "APK SDK_DIR=$SDK_DIR"
          echo "APK_SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

          cd "$SDK_DIR"
          echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
          echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
          echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install luci liblucihttp liblucihttp-ucode

          git clone https://github.com/asvow/luci-app-tailscale package/luci-app-tailscale

          echo "=== APK package ç›®å½•ç»“æ„ ==="
          ls -l package

      - name: "9ï¸âƒ£ APKï¼šæŒä¹…åŒ–è·¯å¾„æ›¿æ¢ä¸æ ¡éªŒ"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$APK_SDK_DIR/package/luci-app-tailscale"

          SOURCE="/etc/tailscale"
          TARGET="/etc/config/tailscale-data"
          echo "æ›¿æ¢ ${SOURCE} -> ${TARGET}ï¼ˆAPKï¼‰"

          find . -type f -exec grep -Il "${SOURCE}" {} \; | while read -r f; do
            echo "ä¿®æ”¹æ–‡ä»¶: $f"
            sed -i "s|${SOURCE}|${TARGET}|g" "$f"
          done

          echo "æ ¡éªŒæ›¿æ¢ï¼ˆAPKï¼‰ï¼š"
          grep -RIl "${TARGET}" . || echo "è­¦å‘Šï¼šæœªå‘ç°æ–°è·¯å¾„"

      - name: "ğŸ”Ÿ APKï¼šç”Ÿæˆ .config å¹¶ç¼–è¯‘"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$APK_SDK_DIR"
          {
            echo "CONFIG_ALL_KMODS=y"
            echo "CONFIG_ALL=y"
            echo "CONFIG_TARGET_PACKAGING_APK=y"
            echo "CONFIG_PACKAGE_luci=y"
            echo "CONFIG_PACKAGE_liblucihttp=y"
            echo "CONFIG_PACKAGE_liblucihttp-ucode=y"
            echo "CONFIG_LUCI_LANG_zh-cn=y"
            echo "CONFIG_LUCI_LANG_zh-tw=y"
            echo "CONFIG_PACKAGE_luci-app-tailscale=y"
            echo "CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y"
            echo "CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y"
          } > .config
          make defconfig

          make package/luci-app-tailscale/compile V=s || make package/luci-app-tailscale/compile V=s
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s || true

      - name: "1ï¸âƒ£1ï¸âƒ£ APKï¼šæ”¶é›†äº§ç‰©å¹¶æ ‡å‡†é‡å‘½å"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$APK_SDK_DIR"
          APK_OUT="${PWD}/out-apk"
          mkdir -p "$APK_OUT"

          VER="${{ steps.check.outputs.latest_version }}"
          # æ”¶é›†ç”Ÿæˆçš„ apkï¼›æœ‰çš„ SDK åç§°å¯èƒ½å·²ç»ç¬¦åˆè§„èŒƒ
          find bin -type f -name "luci-app-tailscale-*-*.apk" -exec cp -v {} "$APK_OUT/luci-app-tailscale-${VER}-r1.apk" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-cn-*-*.apk" -exec cp -v {} "$APK_OUT/luci-i18n-tailscale-zh-cn_${VER}.apk" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-tw-*-*.apk" -exec cp -v {} "$APK_OUT/luci-i18n-tailscale-zh-tw_${VER}.apk" \; || true

          echo "APK_OUT=$APK_OUT" >> $GITHUB_ENV
          ls -lh "$APK_OUT" || true

      # =========================
      # æ±‡æ€»ä¸å‘å¸ƒ
      # =========================
      - name: "1ï¸âƒ£2ï¸âƒ£ æ±‡æ€»æ‰€æœ‰äº§ç‰©"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        id: gather
        run: |
          set -e
          ALL_OUT="${PWD}/out-all"
          mkdir -p "$ALL_OUT"
          echo "ALL_OUT=$ALL_OUT" >> $GITHUB_OUTPUT

          # IPK
          if [ -n "$IPK_OUT" ] && [ -d "$IPK_OUT" ]; then
            cp -v "$IPK_OUT"/* "$ALL_OUT/" || true
          fi
          # APK
          if [ -n "$APK_OUT" ] && [ -d "$APK_OUT" ]; then
            cp -v "$APK_OUT"/* "$ALL_OUT/" || true
          fi

          echo "=== æœ€ç»ˆäº§ç‰©åˆ—è¡¨ ==="
          ls -lh "$ALL_OUT" || true
        env:
          IPK_OUT: ${{ env.IPK_OUT }}
          APK_OUT: ${{ env.APK_OUT }}

      - name: "1ï¸âƒ£3ï¸âƒ£ å‘å¸ƒå‰æ£€æŸ¥"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          OUT="${{ steps.gather.outputs.ALL_OUT }}"
          ls -lh "$OUT" || exit 1
          cnt=$(ls "$OUT" | wc -l)
          echo "äº§ç‰©æ•°é‡: $cnt"
          if [ "$cnt" -eq 0 ]; then
            echo "æœªæ‰¾åˆ°ä»»ä½•äº§ç‰©ï¼Œå–æ¶ˆå‘å¸ƒã€‚"
            exit 1
          fi

      - name: "1ï¸âƒ£4ï¸âƒ£ å‘å¸ƒåˆ° Releasesï¼ˆé¿å… 403ï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.tag.outputs.release_tag }}"
          name: "luci-app-tailscale ${{ steps.check.outputs.latest_version }}ï¼ˆæŒä¹…åŒ–é…ç½®ç‰ˆï¼ŒIPK+APKï¼‰"
          files: "${{ steps.gather.outputs.ALL_OUT }}/*"
          body: |
            - æ„å»ºï¼š
              * OpenWrt 22.03 SDKï¼ˆIPKï¼‰
              * OpenWrt 24.10 SDKï¼ˆAPKï¼‰
            - æŒä¹…åŒ–è·¯å¾„ï¼š/etc/config/tailscale-data
            - åŒ…å«ï¼š
              * luci-app-tailscale_<ver>_all.ipk
              * luci-app-tailscale-<ver>-r1.apk
              * luci-i18n-tailscale-zh-cn_<ver>_all.ipk / .apk
              * luci-i18n-tailscale-zh-tw_<ver>_all.ipk / .apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
