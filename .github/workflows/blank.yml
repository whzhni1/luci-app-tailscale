name: "æ„å»º Tailscaleï¼ˆImmortalWrt ä¸»çº¿ APK + ImmortalWrt 24.10 IPKï¼‰"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°"
        id: version
        run: |
          set -e
          
          echo "::group::ğŸ“¥ è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬"
          upstream_latest=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/tags" | jq -r '.[0].name // "none"')
          
          if [ "$upstream_latest" = "none" ] || [ "$upstream_latest" = "null" ]; then
            echo "::error::âŒ æ— æ³•è·å–ä¸Šæ¸¸ç‰ˆæœ¬"
            exit 1
          fi
          
          echo "  ä¸Šæ¸¸æœ€æ–°: $upstream_latest"
          echo "::endgroup::"
          
          echo "::group::ğŸ“¦ è·å–å½“å‰ä»“åº“ç‰ˆæœ¬"
          my_latest=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          if [ "$my_latest" != "none" ] && [ "$my_latest" != "null" ]; then
            echo "  å½“å‰ç‰ˆæœ¬: $my_latest"
          else
            my_latest="none"
            echo "  âš ï¸  æ— ç‰ˆæœ¬ï¼ˆé¦–æ¬¡æ„å»ºï¼‰"
          fi
          echo "::endgroup::"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ä¸Šæ¸¸ç‰ˆæœ¬: $upstream_latest"
          echo "  å½“å‰ç‰ˆæœ¬: $my_latest"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ "$upstream_latest" = "$my_latest" ]; then
            echo "::notice::âœ… ç‰ˆæœ¬ä¸€è‡´ ($upstream_latest)ï¼Œè·³è¿‡æ„å»º"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::ğŸ†• å‘ç°æ–°ç‰ˆæœ¬ $upstream_latestï¼ˆå½“å‰ $my_latestï¼‰ï¼Œå¼€å§‹æ„å»º"
            echo "skip=false" >> $GITHUB_OUTPUT
            version_number=$(echo "$upstream_latest" | sed 's/^v//')
            echo "version=$version_number" >> $GITHUB_OUTPUT
            echo "tag=$upstream_latest" >> $GITHUB_OUTPUT
          fi

      - name: "âœ… ç‰ˆæœ¬æ— æ›´æ–°ï¼Œç»“æŸå·¥ä½œæµ"
        if: steps.version.outputs.skip == 'true'
        run: |
          echo "::notice::âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€é‡å¤æ„å»º"
          exit 0
          
      - name: "3ï¸âƒ£ æ‹‰å– luci-app-tailscale æºç å¹¶åšæŒä¹…åŒ–ä¿®æ”¹"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          SRC_DIR=$PWD/src/luci-app-tailscale
          mkdir -p src
          
          echo "ğŸ“¥ å…‹éš† luci-app-tailscale æºç ..."
          git clone https://github.com/asvow/luci-app-tailscale "$SRC_DIR"
          cd "$SRC_DIR"
          
          echo ""
          echo "ğŸ”§ å¼€å§‹è¿›è¡ŒæŒä¹…åŒ–ä¿®æ”¹..."
          echo "========================================"
          
          # ===== 1. ä¿®æ”¹ Makefile =====
          echo ""
          echo "1ï¸âƒ£ ä¿®æ”¹ Makefile - æ·»åŠ é…ç½®æ–‡ä»¶ä¿æŠ¤"
          if ! grep -q "define Package/luci-app-tailscale/conffiles" Makefile; then
            sed -i '/^PKG_VERSION:=/a\\n# ä¿æŠ¤é…ç½®æ–‡ä»¶å’Œæ•°æ®ç›®å½•ä¸è¢«è¦†ç›–\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
            echo "âœ… å·²æ·»åŠ  conffiles å®šä¹‰"
          else
            echo "âš ï¸  conffiles å®šä¹‰å·²å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
          echo "ğŸ“„ Makefile ä¿®æ”¹åå†…å®¹ï¼š"
          cat Makefile
          echo "----------------------------------------"
          
          # ===== 2. ä¿®æ”¹é»˜è®¤é…ç½®æ–‡ä»¶ =====
          echo ""
          echo "2ï¸âƒ£ ä¿®æ”¹ root/etc/config/tailscale - æ›´æ”¹é»˜è®¤æ•°æ®ç›®å½•"
          sed -i "s|option config_path '/etc/tailscale'|option config_path '/etc/config/tailscale_data'|g" root/etc/config/tailscale
          echo "âœ… å·²å°† config_path é»˜è®¤å€¼æ”¹ä¸º /etc/config/tailscale_data"
          
          echo "ğŸ“„ ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶å…³é”®è¡Œï¼š"
          grep "config_path" root/etc/config/tailscale
          echo "----------------------------------------"
          
          # ===== 3. ä¿®æ”¹ init.d è„šæœ¬ =====
          echo ""
          echo "3ï¸âƒ£ ä¿®æ”¹ root/etc/init.d/tailscale - åˆ†ç¦»ä¸´æ—¶ç›®å½•å’Œæ•°æ®ç›®å½•"
          
          sed -i 's|^CONFIG_PATH=/var/lib/tailscale|CONFIG_PATH=/var/run/tailscale|g' root/etc/init.d/tailscale
          echo "âœ… å·²å°† CONFIG_PATH æ”¹ä¸º /var/run/tailscaleï¼ˆä¸´æ—¶è¿è¡Œç›®å½•ï¼‰"
          
          sed -i '/rm -rf "$CONFIG_PATH"/i\	# åªåˆ é™¤ä¸´æ—¶è¿è¡Œç›®å½•ï¼Œä¸åˆ é™¤åŒ…å«æˆæƒä¿¡æ¯çš„æ•°æ®ç›®å½• (/etc/config/tailscale_data)' root/etc/init.d/tailscale
          echo "âœ… å·²æ·»åŠ æ•°æ®ç›®å½•ä¿æŠ¤æ³¨é‡Š"
          
          echo "ğŸ“„ ä¿®æ”¹åçš„ init.d è„šæœ¬å…³é”®è¡Œï¼š"
          grep -A 2 "^CONFIG_PATH=" root/etc/init.d/tailscale
          grep -B 1 -A 1 'rm -rf "$CONFIG_PATH"' root/etc/init.d/tailscale
          echo "----------------------------------------"
          
          # ===== 4. ä¿®æ”¹ LuCI ç•Œé¢ JS =====
          echo ""
          echo "4ï¸âƒ£ ä¿®æ”¹ htdocs/luci-static/resources/view/tailscale/setting.js - æ›´æ–°ç•Œé¢é»˜è®¤å€¼"
          sed -i "s|o.default = '/etc/tailscale';|o.default = '/etc/config/tailscale_data';|g" htdocs/luci-static/resources/view/tailscale/setting.js
          echo "âœ… å·²å°†ç•Œé¢é»˜è®¤å·¥ä½œç›®å½•æ”¹ä¸º /etc/config/tailscale_data"
          
          echo "ğŸ“„ ä¿®æ”¹åçš„ JS å…³é”®è¡Œï¼š"
          grep -A 2 "config_path.*Workdir" htdocs/luci-static/resources/view/tailscale/setting.js | head -3
          echo "----------------------------------------"
          
          # ===== 5. é‡å†™ uci-defaults è„šæœ¬ =====
          echo ""
          echo "5ï¸âƒ£ é‡å†™ root/etc/uci-defaults/40_luci-tailscale - æ·»åŠ é…ç½®è¿ç§»é€»è¾‘"
          
          mkdir -p root/etc/uci-defaults
          
          cat > root/etc/uci-defaults/40_luci-tailscale <<'HEREDOC_EOF'
          #!/bin/sh
          
          OLD_DATA_DIR="/etc/tailscale"
          NEW_DATA_DIR="/etc/config/tailscale_data"
          
          # æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨
          if ! uci -q get tailscale.settings > /dev/null 2>&1; then
          	echo "ğŸ“ é¦–æ¬¡å®‰è£…ï¼Œåˆå§‹åŒ–é»˜è®¤é…ç½®..."
          	uci -q batch <<-EOC
          		set tailscale.settings='tailscale'
          		set tailscale.settings.enabled='0'
          		set tailscale.settings.port='41641'
          		set tailscale.settings.config_path='$NEW_DATA_DIR'
          		set tailscale.settings.fw_mode='nftables'
          		set tailscale.settings.log_stdout='1'
          		set tailscale.settings.log_stderr='1'
          		set tailscale.settings.accept_dns='1'
          		commit tailscale
          	EOC
          	echo "âœ… é»˜è®¤é…ç½®å·²åˆ›å»º"
          else
          	echo "âš ï¸  æ£€æµ‹åˆ°å·²æœ‰é…ç½®"
          	
          	# æ£€æŸ¥å¹¶è¿ç§»æ—§è·¯å¾„é…ç½®
          	current_path=$(uci -q get tailscale.settings.config_path)
          	if [ "$current_path" = "$OLD_DATA_DIR" ]; then
          		echo "ğŸ”„ æ£€æµ‹åˆ°æ—§è·¯å¾„é…ç½®ï¼Œå¼€å§‹è¿ç§»..."
          		
          		# æ›´æ–°é…ç½®è·¯å¾„
          		uci set tailscale.settings.config_path="$NEW_DATA_DIR"
          		uci commit tailscale
          		echo "âœ… å·²æ›´æ–° config_path: $OLD_DATA_DIR -> $NEW_DATA_DIR"
          		
          		# è¿ç§»æ•°æ®æ–‡ä»¶
          		if [ -d "$OLD_DATA_DIR" ] && [ ! -d "$NEW_DATA_DIR" ]; then
          			mkdir -p "$NEW_DATA_DIR"
          			echo "ğŸ“ å·²åˆ›å»ºæ–°æ•°æ®ç›®å½• $NEW_DATA_DIR"
          			
          			# è¿ç§»çŠ¶æ€æ–‡ä»¶
          			if [ -f "$OLD_DATA_DIR/tailscaled.state" ]; then
          				cp -a "$OLD_DATA_DIR/tailscaled.state" "$NEW_DATA_DIR/"
          				echo "âœ… å·²è¿ç§»æˆæƒçŠ¶æ€æ–‡ä»¶"
          			fi
          			
          			# è¿ç§»å…¶ä»–å¯èƒ½çš„æ–‡ä»¶
          			if [ -n "$(ls -A $OLD_DATA_DIR 2>/dev/null)" ]; then
          				cp -a "$OLD_DATA_DIR"/* "$NEW_DATA_DIR/" 2>/dev/null || true
          				echo "âœ… å·²è¿ç§»æ‰€æœ‰æ•°æ®æ–‡ä»¶"
          			fi
          		fi
          	else
          		echo "âœ… é…ç½®è·¯å¾„å·²æ˜¯æ–°ç‰ˆæœ¬: $current_path"
          	fi
          fi
          
          # ç¡®ä¿æ–°æ•°æ®ç›®å½•å­˜åœ¨
          if [ ! -d "$NEW_DATA_DIR" ]; then
          	mkdir -p "$NEW_DATA_DIR"
          	echo "ğŸ“ å·²åˆ›å»ºæ•°æ®ç›®å½• $NEW_DATA_DIR"
          else
          	echo "ğŸ“ æ•°æ®ç›®å½• $NEW_DATA_DIR å·²å­˜åœ¨"
          fi
          
          # æ¸…ç† ucitrack é…ç½®
          uci -q batch <<-EOT >/dev/null
          	delete ucitrack.@tailscale[-1]
          	commit ucitrack
          EOT
          
          # æ¸…ç† LuCI ç¼“å­˜
          rm -f /tmp/luci-indexcache
          echo "ğŸ—‘ï¸  å·²æ¸…ç† LuCI ç¼“å­˜"
          
          # å¦‚æœ Tailscale æ­£åœ¨è¿è¡Œï¼Œæç¤ºéœ€è¦é‡å¯
          if /etc/init.d/tailscale status >/dev/null 2>&1; then
          	echo "âš ï¸  æ£€æµ‹åˆ° Tailscale æ­£åœ¨è¿è¡Œï¼Œè¯·é‡å¯æœåŠ¡ä»¥åº”ç”¨æ–°é…ç½®ï¼š"
          	echo "    /etc/init.d/tailscale restart"
          fi
          
          exit 0
          HEREDOC_EOF
          
          chmod +x root/etc/uci-defaults/40_luci-tailscale
          echo "âœ… uci-defaults è„šæœ¬å·²é‡å†™å¹¶è®¾ç½®ä¸ºå¯æ‰§è¡Œ"
          
          echo ""
          echo "ğŸ“„ ç”Ÿæˆçš„ 40_luci-tailscale è„šæœ¬å®Œæ•´å†…å®¹ï¼š"
          echo "========================================"
          cat root/etc/uci-defaults/40_luci-tailscale
          echo "========================================"
          
          # ===== 6. åˆ é™¤åŸå§‹é…ç½®æ–‡ä»¶ =====
          echo ""
          echo "6ï¸âƒ£ åˆ é™¤åŸå§‹é…ç½®æ–‡ä»¶ï¼ˆé¿å…è¦†ç›–ç”¨æˆ·é…ç½®ï¼‰"
          if [ -f root/etc/config/tailscale ]; then
            echo "ğŸ“„ åŸå§‹é…ç½®æ–‡ä»¶å†…å®¹ï¼ˆå¤‡ä»½åˆ°æ—¥å¿—ï¼‰ï¼š"
            cat root/etc/config/tailscale
            rm -f root/etc/config/tailscale
            echo "âœ… å·²åˆ é™¤ root/etc/config/tailscale"
          else
            echo "âš ï¸  åŸå§‹é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          echo "----------------------------------------"
          
          # ===== 7. éªŒè¯ä¿®æ”¹ =====
          echo ""
          echo "ğŸ” éªŒè¯æ‰€æœ‰ä¿®æ”¹..."
          echo "========================================"
          
          echo "âœ… æ£€æŸ¥ç‚¹ 1: Makefile åŒ…å« conffiles"
          grep -A 3 "define Package/luci-app-tailscale/conffiles" Makefile || echo "âŒ æœªæ‰¾åˆ° conffiles å®šä¹‰"
          
          echo ""
          echo "âœ… æ£€æŸ¥ç‚¹ 2: uci-defaults è„šæœ¬å­˜åœ¨ä¸”å¯æ‰§è¡Œ"
          ls -lh root/etc/uci-defaults/40_luci-tailscale
          
          echo ""
          echo "âœ… æ£€æŸ¥ç‚¹ 3: uci-defaults åŒ…å«è¿ç§»é€»è¾‘"
          grep -c "è¿ç§»" root/etc/uci-defaults/40_luci-tailscale || echo "0"
          
          echo ""
          echo "âœ… æ£€æŸ¥ç‚¹ 4: init.d è„šæœ¬ä½¿ç”¨æ­£ç¡®çš„ CONFIG_PATH"
          grep "^CONFIG_PATH=" root/etc/init.d/tailscale
          
          echo ""
          echo "âœ… æ£€æŸ¥ç‚¹ 5: ç¡®è®¤åŸå§‹é…ç½®æ–‡ä»¶å·²åˆ é™¤"
          if [ ! -f root/etc/config/tailscale ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ é™¤ï¼Œä¸ä¼šè¢«æ‰“åŒ…"
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼"
          fi
          
          echo "========================================"
          echo ""
          echo "ğŸ‰ æ‰€æœ‰ä¿®æ”¹å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ ä¿®æ”¹æ‘˜è¦ï¼š"
          echo "  1. âœ… Makefile: æ·»åŠ  conffiles ä¿æŠ¤é…ç½®"
          echo "  2. âœ… é»˜è®¤é…ç½®: config_path = /etc/config/tailscale_data"
          echo "  3. âœ… Initè„šæœ¬: CONFIG_PATH = /var/run/tailscale"
          echo "  4. âœ… LuCIç•Œé¢: é»˜è®¤å·¥ä½œç›®å½• = /etc/config/tailscale_data"
          echo "  5. âœ… UCI-defaults: æ™ºèƒ½é…ç½®åˆå§‹åŒ– + æ—§é…ç½®è¿ç§»"
          echo "  6. âœ… åˆ é™¤åŸå§‹é…ç½®æ–‡ä»¶é¿å…è¦†ç›–"
          echo ""
          echo "ğŸ¯ å®ç°æ•ˆæœï¼š"
          echo "  â€¢ é¦–æ¬¡å®‰è£…ï¼šåˆ›å»ºæ–°é…ç½®ï¼Œä½¿ç”¨æ–°è·¯å¾„"
          echo "  â€¢ é‡æ–°å®‰è£…ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¿ç§»æ—§è·¯å¾„åˆ°æ–°è·¯å¾„"
          echo "  â€¢ è¿ç§»æ•°æ®ï¼šè‡ªåŠ¨å¤åˆ¶æˆæƒçŠ¶æ€æ–‡ä»¶"
          echo "  â€¢ å‡çº§ä¿æŠ¤ï¼šé…ç½®å’Œæ•°æ®å‡ä¸ä¸¢å¤±"
          echo "========================================"
          
          echo "SRC_DIR=$SRC_DIR" >> $GITHUB_ENV
      # =========================
      # ImmortalWrt ä¸»çº¿ SDK (apk)
      # =========================
      - name: "4ï¸âƒ£ ä¸‹è½½ ImmortalWrt ä¸»çº¿ SDK (apk)"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          SDK_URL="https://downloads.immortalwrt.org/snapshots/targets/x86/generic/immortalwrt-sdk-x86-generic_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
          curl -LO "$SDK_URL"
          tar --use-compress-program=unzstd -xf "$(basename "$SDK_URL")"
          SDK_DIR=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" -print -quit)
          mv "$SDK_DIR" immortalwrt-sdk-apk
          echo "SDK_DIR_APK=$PWD/immortalwrt-sdk-apk" >> $GITHUB_ENV
          
      - name: "5ï¸âƒ£ é…ç½®å¹¶ç¼–è¯‘ï¼ˆImmortalWrt ä¸»çº¿ SDK â†’ apkï¼‰"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          cd "$SDK_DIR_APK"
          echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -r "$SRC_DIR" package/luci-app-tailscale
          
          cat > .config <<EOF
          CONFIG_TARGET_PACKAGING_APK=y
          CONFIG_PACKAGE_luci-app-tailscale=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=m
          # CONFIG_ALL_KMODS is not set
          EOF
          
          make defconfig
          make package/luci-app-tailscale/{clean,compile} V=s -j2 IGNORE_ERRORS=m
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/{clean,compile} V=s -j2 IGNORE_ERRORS=m || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/{clean,compile} V=s -j2 IGNORE_ERRORS=m || true
          
          mkdir -p ../out-apk
          find bin/packages -type f -name "luci-app-tailscale*.apk" -exec cp -v {} ../out-apk/ \;
          find bin/packages -type f -name "luci-i18n-tailscale*.apk" -exec cp -v {} ../out-apk/ \;
          
      - name: "6ï¸âƒ£ æ‰“å° APK SDK äº§ç‰©"
        if: steps.version.outputs.skip != 'true'
        run: |
          echo "=== APK SDK ç¼–è¯‘äº§ç‰© ==="
          ls -lh out-apk || true
          
      # =========================
      # ImmortalWrt 24.10 SDK (ipk)
      # =========================
      - name: "7ï¸âƒ£ ä¸‹è½½ ImmortalWrt 24.10 SDK (ipk)"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          SDK_URL="https://downloads.immortalwrt.org/releases/24.10.0/targets/x86/64/immortalwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          curl -LO "$SDK_URL"
          tar --use-compress-program=unzstd -xf "$(basename "$SDK_URL")"
          SDK_DIR_RAW=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" -print -quit)
          mv "$SDK_DIR_RAW" immortalwrt-sdk-ipk
          echo "SDK_DIR_IPK=$PWD/immortalwrt-sdk-ipk" >> $GITHUB_ENV
          
      - name: "8ï¸âƒ£ é…ç½®å¹¶ç¼–è¯‘ï¼ˆImmortalWrt 24.10 SDK â†’ ipkï¼‰"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          cd "$SDK_DIR_IPK"
          echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -r "$SRC_DIR" package/luci-app-tailscale
          
          cat > .config <<EOF
          CONFIG_PACKAGE_luci-app-tailscale=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=m
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=m
          # CONFIG_ALL_KMODS is not set
          EOF
          
          make defconfig
          make package/luci-app-tailscale/{clean,compile} V=s -j2 IGNORE_ERRORS=m
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/{clean,compile} V=s -j2 IGNORE_ERRORS=m || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/{clean,compile} V=s -j2 IGNORE_ERRORS=m || true
          
          mkdir -p ../out-ipk
          find bin/packages -type f -name "luci-app-tailscale*.ipk" -exec cp -v {} ../out-ipk/ \;
          find bin/packages -type f -name "luci-i18n-tailscale*.ipk" -exec cp -v {} ../out-ipk/ \;
          
      - name: "9ï¸âƒ£ æ‰“å° IPK SDK äº§ç‰©"
        if: steps.version.outputs.skip != 'true'
        run: |
          echo "=== IPK SDK ç¼–è¯‘äº§ç‰© ==="
          ls -lh out-ipk || true
          
      # =========================
      # æ±‡æ€» & å‘å¸ƒï¼ˆåŠ è¿‡æ»¤ï¼‰
      # =========================
      - name: "ğŸ”Ÿ æ±‡æ€»äº§ç‰©å¹¶è¿‡æ»¤"
        if: steps.version.outputs.skip != 'true'
        run: |
          set -e
          mkdir -p out
          
          for file in out-apk/*; do
            filename=$(basename "$file")
            if [[ "$filename" == luci-app-tailscale* ]] || [[ "$filename" == luci-i18n-tailscale* ]]; then
              cp -v "$file" out/
            fi
          done
          
          for file in out-ipk/*; do
            filename=$(basename "$file")
            if [[ "$filename" == luci-app-tailscale* ]] || [[ "$filename" == luci-i18n-tailscale* ]]; then
              cp -v "$file" out/
            fi
          done
          
          echo ""
          echo "=== æœ€ç»ˆäº§ç‰©ï¼ˆå·²è¿‡æ»¤ lib*, kmod-*, tailscale ä¸»ç¨‹åºï¼‰==="
          ls -lh out/

      # âœ… æ–°å¢ï¼šç”Ÿæˆæ„å»ºæ—¶é—´
      - name: "ğŸ“… ç”Ÿæˆæ„å»ºæ—¶é—´"
        if: steps.version.outputs.skip != 'true'
        id: build_time
        run: |
          BUILD_TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S CST")
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "æ„å»ºæ—¶é—´: $BUILD_TIME"

      - name: "1ï¸âƒ£1ï¸âƒ£ å‘å¸ƒåˆ° GitHub Release"
        if: steps.version.outputs.skip != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.version.outputs.tag }}"
          name: "luci-app-tailscale ${{ steps.version.outputs.version }}ï¼ˆImmortalWrt ä¸»çº¿ APK + 24.10 IPKï¼‰"
          files: "out/*"
          body: |
            ## ğŸ“¦ åŒ…å«æ–‡ä»¶
            - **APK æ ¼å¼**ï¼šImmortalWrt ä¸»çº¿ï¼ˆæ–°ç‰ˆ apk åŒ…ç®¡ç†å™¨ï¼‰
            - **IPK æ ¼å¼**ï¼šImmortalWrt 24.10ï¼ˆä¼ ç»Ÿ opkg åŒ…ç®¡ç†å™¨ï¼‰

            ## ğŸ”§ æŒä¹…åŒ–é…ç½®
            - æ•°æ®è·¯å¾„ï¼š`/etc/config/tailscale-data`

            ## ğŸ“¥ å®‰è£…æ–¹æ³•
            ```bash
            # APK æ–¹å¼ï¼ˆImmortalWrt ä¸»çº¿ï¼‰
            apk add --allow-untrusted luci-app-tailscale*.apk

            # IPK æ–¹å¼ï¼ˆImmortalWrt 24.10 åŠä»¥ä¸‹ï¼‰
            opkg install luci-app-tailscale*.ipk
            ```

            ## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯
            - ä¸Šæ¸¸ç‰ˆæœ¬: ${{ steps.version.outputs.tag }}
            - æ„å»ºæ—¶é—´: ${{ steps.build_time.outputs.time }}

            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - ä»…åŒ…å« LuCI ç•Œé¢æ’ä»¶
            - ä¸å«ä¾èµ–åº“å’Œ Tailscale ä¸»ç¨‹åº
            - ä¾èµ–è¯·ä»ç³»ç»Ÿæºå®‰è£…

      - name: "1ï¸âƒ£2ï¸âƒ£ åŒæ­¥åˆ° Gitee Release"
        if: steps.version.outputs.skip != 'true'
        continue-on-error: true
        run: |
          chmod +x .github/scripts/release-gitee.sh
          .github/scripts/release-gitee.sh \
            "whzhni/luci-app-tailscale" \
            "${{ secrets.GITEE_TOKEN }}" \
            "${{ steps.version.outputs.tag }}" \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.build_time.outputs.time }}" \
            "${{ github.repository }}" \
            "luci-app-lucky"
