name: "è‡ªåŠ¨æ„å»º Tailscaleï¼ˆæŒä¹…åŒ–é…ç½®ç‰ˆï¼‰"

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹è‡ªåŠ¨æ£€æŸ¥
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.check.outputs.need_build }}
      latest_version: ${{ steps.check.outputs.latest_version }}

    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°"
        id: check
        run: |
          echo "å¼€å§‹æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°..."
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/releases/latest" \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "è·å–å¤±è´¥")
          current=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>/dev/null \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "v0.0.0")

          echo "=== ç‰ˆæœ¬å¯¹æ¯”ç»“æœ ==="
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $upstream"
          echo "æˆ‘ä»¬çš„ç‰ˆæœ¬: $current"

          if [ "$upstream" != "$current" ] && [ "$upstream" != "è·å–å¤±è´¥" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "latest_version=$upstream" >> $GITHUB_OUTPUT
            echo "ç»“è®º: éœ€è¦æ„å»º"
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
            echo "ç»“è®º: ä¸éœ€è¦æ„å»º"
          fi

      - name: "ğŸ” è¾“å‡ºæ£€æŸ¥ç»“æœ"
        run: |
          echo "need_build = ${{ steps.check.outputs.need_build }}"
          echo "latest_version = ${{ steps.check.outputs.latest_version }}"

      - name: "3ï¸âƒ£ å…‹éš†å¹¶ä¿®æ”¹æºç "
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          echo "æ­£åœ¨å…‹éš†ä¸Šæ¸¸æºç ..."
          git clone https://github.com/asvow/luci-app-tailscale

          echo "æ­£åœ¨ä¿®æ”¹é…ç½®è·¯å¾„ (Lua åç«¯)..."
          sed -i "s|/etc/tailscale|/etc/config/tailscale-data|g" \
            luci-app-tailscale/files/luasrc/model/cbi/tailscale.lua

          echo "æ­£åœ¨ä¿®æ”¹é…ç½®è·¯å¾„ (JS å‰ç«¯)..."
          sed -i "s|/etc/tailscale|/etc/config/tailscale-data|g" \
            luci-app-tailscale/htdocs/luci-static/resources/view/tailscale/setting.js

          echo "é…ç½®è·¯å¾„ä¿®æ”¹å®Œæˆ"

      - name: "4ï¸âƒ£ æ„å»ºIPKåŒ…"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          echo "å¼€å§‹æ„å»ºIPKåŒ…..."
          mkdir -p ipk-build/control ipk-build/data
          cp -r luci-app-tailscale/files/* ipk-build/data/
          cp -r luci-app-tailscale/htdocs ipk-build/data/

          {
            echo "Package: luci-app-tailscale"
            echo "Version: ${{ steps.check.outputs.latest_version }}-persistent1"
            echo "Depends: libc, tailscale"
            echo "Source: luci-app-tailscale"
            echo "Section: luci"
            echo "Architecture: all"
            echo "Installed-Size: 1024"
            echo "Description: Tailscale LuCI app with persistent config"
            echo " æŒä¹…åŒ–é…ç½®ç‰ˆæœ¬ï¼Œè§£å†³å›ºä»¶å‡çº§é…ç½®ä¸¢å¤±é—®é¢˜"
            echo " é…ç½®è·¯å¾„: /etc/config/tailscale-data"
          } > ipk-build/control/control

          cd ipk-build
          tar -czf control.tar.gz -C control .
          tar -czf data.tar.gz -C data .
          echo "2.0" > debian-binary
          ar r ../luci-app-tailscale-persistent.ipk debian-binary control.tar.gz data.tar.gz
          cd ..
          echo "IPKåŒ…æ„å»ºå®Œæˆ âœ…"

      - name: "5ï¸âƒ£ å‘å¸ƒåˆ°Releases"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.check.outputs.latest_version }}-persistent"
          name: "luci-app-tailscale ${{ steps.check.outputs.latest_version }} (æŒä¹…åŒ–é…ç½®ç‰ˆ)"
          files: "luci-app-tailscale-persistent.ipk"
          body: |
            luci-app-tailscale æŒä¹…åŒ–é…ç½®ç‰ˆæœ¬ï¼Œè§£å†³å›ºä»¶å‡çº§é…ç½®ä¸¢å¤±é—®é¢˜
            é…ç½®è·¯å¾„: /etc/config/tailscale-data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
