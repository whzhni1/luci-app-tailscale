name: "æž„å»º Tailscale + LuCIï¼ˆå®Œæ•´ç‰ˆï¼‰"

on:
  workflow_dispatch:
    inputs:
      enable_compression:
        description: 'å¯ç”¨ UPX åŽ‹ç¼©'
        required: true
        type: boolean
        default: true
  schedule:
    - cron: '0 16 * * *'

permissions:
  contents: write

env:
  TAILSCALE_REPO: "tailscale/tailscale"
  IMM_PACKAGES_REPO: "immortalwrt/packages"
  LUCI_REPO: "asvow/luci-app-tailscale"
  ENABLE_COMPRESSION: ${{ github.event_name == 'schedule' || inputs.enable_compression == true }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      version: ${{ steps.check.outputs.version }}
      current_version: ${{ steps.check.outputs.current_version }}
      build_time: ${{ steps.time.outputs.time }}
      luci_version: ${{ steps.luci.outputs.version }}
    steps:
      - name: "æ£€æŸ¥ç‰ˆæœ¬"
        id: check
        run: |
          upstream=$(curl -s "https://api.github.com/repos/${{ env.TAILSCALE_REPO }}/releases/latest" | jq -r '.tag_name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          echo "ä¸Šæ¸¸: $upstream, å½“å‰: $current"
          echo "version=$upstream" >> $GITHUB_OUTPUT
          echo "current_version=$current" >> $GITHUB_OUTPUT
          echo "skip=$( [ "$upstream" = "$current" ] && echo true || echo false )" >> $GITHUB_OUTPUT

      - name: "èŽ·å– LuCI ç‰ˆæœ¬"
        id: luci
        run: echo "version=$(curl -s "https://api.github.com/repos/${{ env.LUCI_REPO }}/releases/latest" | jq -r '.tag_name // "none"')" >> $GITHUB_OUTPUT

      - name: "ç”Ÿæˆæž„å»ºæ—¶é—´"
        id: time
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  build-tailscale:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - {id: arm, goarch: arm, targets: '["arm_arm1176jzf-s_vfp","arm_arm926ej-s","arm_cortex-a15_neon-vfpv4","arm_cortex-a5_vfpv4","arm_cortex-a7","arm_cortex-a7_neon-vfpv4","arm_cortex-a7_vfpv4","arm_cortex-a8_vfpv3","arm_cortex-a9","arm_cortex-a9_neon","arm_cortex-a9_vfpv3-d16","arm_fa526","arm_xscale","arm_mpcore"]'}
          - {id: arm64, goarch: arm64, targets: '["aarch64_cortex-a53","aarch64_cortex-a72","aarch64_cortex-a76","aarch64_generic"]'}
          - {id: mips, goarch: mips, gomips: softfloat, targets: '["mips_24kc","mips_4kec","mips_mips32"]'}
          - {id: mipsle, goarch: mipsle, gomips: softfloat, targets: '["mipsel_24kc","mipsel_24kc_24kf","mipsel_74kc","mipsel_mips32"]'}
          - {id: mips64, goarch: mips64, gomips: softfloat, targets: '["mips64_mips64r2","mips64_octeonplus"]'}
          - {id: mips64le, goarch: mips64le, gomips: softfloat, targets: '["mips64el_mips64r2"]'}
          - {id: "386", goarch: "386", targets: '["i386_pentium-mmx","i386_pentium4"]'}
          - {id: amd64, goarch: amd64, cgo: "1", cc: musl-gcc, setup: "sudo apt-get update && sudo apt-get install -y musl-tools", targets: '["x86_64"]'}
          - {id: geode, goarch: "386", go386: softfloat, targets: '["i386_geode"]'}
    name: "Tailscale-${{ matrix.id }}"
    steps:
      - name: "çŽ¯å¢ƒå‡†å¤‡"
        if: matrix.setup
        run: ${{ matrix.setup }}

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.TAILSCALE_REPO }}
          ref: ${{ needs.check-version.outputs.version }}
          path: src

      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: "å®‰è£… UPX"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          UPX_VERSION=$(curl -s https://api.github.com/repos/upx/upx/releases/latest | jq -r '.tag_name')
          wget -q "https://github.com/upx/upx/releases/download/${UPX_VERSION}/upx-${UPX_VERSION#v}-amd64_linux.tar.xz"
          tar -xf upx-*.tar.xz && sudo mv upx-*/upx /usr/local/bin/ && upx --version

      - name: "ç¼–è¯‘äºŒè¿›åˆ¶"
        working-directory: src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips || '' }}
          GO386: ${{ matrix.go386 || '' }}
          CGO_ENABLED: ${{ matrix.cgo || '0' }}
          CC: ${{ matrix.cc || '' }}
        run: |
          eval `CGO_ENABLED=0 GOOS=$(go env GOHOSTOS) GOARCH=$(go env GOHOSTARCH) go run ./cmd/mkversion`
          mkdir -p ../build
          go build \
            -tags "ts_include_cli,ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_completion,ts_omit_ssh,ts_omit_wakeonlan,ts_omit_capture,ts_omit_relayserver,ts_omit_systray,ts_omit_taildrop,ts_omit_tpm,ts_omit_syspolicy,ts_omit_debugeventbus,ts_omit_webclient" \
            -ldflags "-X tailscale.com/version.longStamp=${VERSION_LONG} -X tailscale.com/version.shortStamp=${VERSION_SHORT} -s -w" \
            -trimpath -o "../build/tailscaled-linux-${{ matrix.id }}" ./cmd/tailscaled
          chmod +x "../build/tailscaled-linux-${{ matrix.id }}"
          ls -lh ../build/

      - name: "åŽ‹ç¼©äºŒè¿›åˆ¶"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          binary="build/tailscaled-linux-${{ matrix.id }}"
          ls -lh "${binary}"
          [[ "${{ matrix.id }}" =~ ^(mips64|mips64le)$ ]] && echo "âš ï¸ è·³è¿‡ UPXï¼ˆæž¶æž„ä¸æ”¯æŒï¼‰" || \
          (upx --lzma --best "${binary}" && echo "âœ… UPX åŽ‹ç¼©æˆåŠŸ" && ls -lh "${binary}") || echo "âš ï¸ UPX å¤±è´¥"

      - name: "ä¸‹è½½é…ç½®æ–‡ä»¶"
        run: |
          mkdir -p config_files
          git clone --depth=1 https://github.com/${{ env.LUCI_REPO }} /tmp/luci-source
          [ -f /tmp/luci-source/root/etc/init.d/tailscale ] || exit 1
          sed 's|/usr/bin/tailscale|/usr/sbin/tailscale|g' /tmp/luci-source/root/etc/init.d/tailscale > config_files/tailscale.init
          curl -fsSL -o config_files/tailscale.conf https://raw.githubusercontent.com/${{ env.IMM_PACKAGES_REPO }}/master/net/tailscale/files/tailscale.conf
          chmod +x config_files/tailscale.init
          ls -lh config_files/

      - name: "æ‰“åŒ… IPK å’Œ APK"
        run: |
          VERSION=$(echo "${{ needs.check-version.outputs.version }}" | sed 's/^v//')
          mkdir -p ipk/usr/{sbin,bin} ipk/etc/{config,init.d} ipk/CONTROL output
          binary="build/tailscaled-linux-${{ matrix.id }}"
          [ -f "${binary}" ] || exit 1
          install -m 0755 "${binary}" ipk/usr/sbin/tailscaled
          ln -sf tailscaled ipk/usr/sbin/tailscale
          ln -sf ../sbin/tailscaled ipk/usr/bin/tailscaled
          ln -sf ../sbin/tailscale ipk/usr/bin/tailscale
          install -m 0644 config_files/tailscale.conf ipk/etc/config/tailscale
          install -m 0755 config_files/tailscale.init ipk/etc/init.d/tailscale
          SIZE=$(du -b ipk/usr/sbin/tailscaled | awk '{print $1}')
          echo '2.0' > debian-binary
          
          echo '${{ matrix.targets }}' | jq -r '.[]' | while read ARCH; do
            cat > ipk/CONTROL/control <<EOF
          Package: tailscale
          Version: ${VERSION}
          Depends: ca-bundle, kmod-tun
          Provides: tailscaled
          Source: https://github.com/tailscale/tailscale
          License: BSD-3-Clause
          Section: net
          Architecture: ${ARCH}
          Installed-Size: ${SIZE}
          Maintainer: Automated Build <https://github.com/${{ github.repository }}>
          Description: Tailscale VPN client (LuCI compatible build)
          EOF
            echo "/etc/config/tailscale" > ipk/CONTROL/conffiles
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/tailscale_${VERSION}_${ARCH}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            mkdir -p apk-build && cp -r ipk/* apk-build/
            cat > apk-build/.PKGINFO <<APKEOF
          pkgname = tailscale
          pkgver = ${VERSION}
          pkgdesc = Tailscale VPN client (LuCI compatible)
          url = https://tailscale.com
          arch = ${ARCH}
          license = BSD-3-Clause
          size = ${SIZE}
          depend = ca-bundle
          depend = kmod-tun
          provides = tailscaled
          APKEOF
            tar -czf "output/tailscale-${VERSION}-r1.${ARCH}.apk" -C apk-build .
            rm -rf apk-build control.tar.gz data.tar.gz
          done
          ls -lh output/

      - uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.id }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  build-luci:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - {sdk: SNAPSHOT, pkg_type: apk}
          - {sdk: openwrt-24.10, pkg_type: ipk}
    name: "LuCI-${{ matrix.pkg_type }}"
    steps:
      - uses: actions/checkout@v4

      - name: "å‡†å¤‡ LuCI æºç "
        run: |
          git clone https://github.com/${{ env.LUCI_REPO }} luci-app-tailscale
          cd luci-app-tailscale
          rm -rf root/etc/init.d root/usr/{bin,sbin} root/etc/config/tailscale 2>/dev/null || true
          grep -q "conffiles" Makefile || sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale_data/\nendef' Makefile
          find . -type f \( -name "*.js" -o -name "*.lua" -o -name "*.sh" \) -exec sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" {} \;
          
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          D="/etc/config/tailscale_data"
          [ -f "$D/.luci_initialized" ] && exit 0
          mkdir -p "$D" && touch "$D/.luci_initialized"
          rm -f /etc/config/tailscale-opkg
          if [ -f /etc/config/tailscale ]; then
            sed -i "s|^config settings|config tailscale|g; /option state_file/d; s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
          fi
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null
          rm -f /tmp/luci-indexcache /tmp/luci-modulecache
          [ -x /etc/init.d/tailscale ] && /etc/init.d/tailscale enable && /etc/init.d/tailscale restart
          exit 0
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: x86_64-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "æ”¶é›†äº§ç‰©"
        run: |
          mkdir -p output
          find bin/packages -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp -v {} output/ \;
          [ -z "$(ls -A output/)" ] && exit 1
          ls -lh output/

      - uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.pkg_type }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  release:
    needs: [check-version, build-tailscale, build-luci]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: "æ•´ç†æ–‡ä»¶"
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.apk" -o -name "*.ipk" \) -exec cp -v {} release/ \;
          [ -z "$(ls -A release/)" ] && exit 1
          ls -lh release/

      - name: "ç”Ÿæˆ Release è¯´æ˜Ž"
        run: |
          cat > release.md <<'EOF'
          ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
          
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} |
          | æž„å»ºæ—¶é—´ | ${{ needs.check-version.outputs.build_time }} CST |
          | UPX åŽ‹ç¼© | ${{ env.ENABLE_COMPRESSION == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} |
          
          ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
          
          âš ï¸ **å¿…é¡»å…ˆå®‰è£… Tailscaleï¼Œå†å®‰è£… LuCI**
          
          **APK:** `apk add --allow-untrusted tailscale-*.apk luci-app-tailscale-*.apk`
          **IPK:** `opkg install tailscale_*_æž¶æž„.ipk luci-app-tailscale_*_all.ipk`
          
          åˆ·æ–° LuCI: `rm -f /tmp/luci-indexcache && /etc/init.d/uhttpd restart`
          
          ## ðŸ“‹ æ”¯æŒçš„æž¶æž„
          
          ARM (14), ARM64 (4), MIPS (3), MIPSle (4), MIPS64 (2), MIPS64le (1), x86 (2), x86_64 (1), Geode (1)
          
          æŸ¥çœ‹æž¶æž„: `opkg print-architecture`
          
          ## ðŸ”§ é…ç½®
          
          - **äºŒè¿›åˆ¶:** `/usr/sbin/tailscaled` + `/usr/bin/tailscaled` (è½¯é“¾æŽ¥)
          - **é…ç½®:** `/etc/config/tailscale`
          - **æ•°æ®:** `/etc/config/tailscale_data/`
          - **æœåŠ¡:** `/etc/init.d/tailscale`
          
          ---
          **ä¸Šæ¸¸:** [tailscale](${{ github.server_url }}/${{ env.TAILSCALE_REPO }}) | [immortalwrt](${{ github.server_url }}/${{ env.IMM_PACKAGES_REPO }}) | [luci](${{ github.server_url }}/${{ env.LUCI_REPO }})
          EOF

      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.version }}
          name: "Tailscale + LuCI ${{ needs.check-version.outputs.version }}"
          bodyFile: release.md
          artifacts: "release/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  report:
    needs: [check-version, build-tailscale, build-luci]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "ç”ŸæˆæŠ¥å‘Š"
        run: |
          if [ "${{ needs.check-version.outputs.skip }}" = "true" ]; then
            cat > $GITHUB_STEP_SUMMARY <<'EOF'
          # â­ï¸ æž„å»ºè·³è¿‡
          ç‰ˆæœ¬ ${{ needs.check-version.outputs.version }} å·²å­˜åœ¨
          EOF
          else
            cat > $GITHUB_STEP_SUMMARY <<EOF
          # ðŸŽ¯ æž„å»ºæŠ¥å‘Š
          
          | ç»„ä»¶ | ç‰ˆæœ¬ | çŠ¶æ€ |
          |------|------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} | ${{ needs.build-tailscale.result == 'success' && 'âœ…' || 'âŒ' }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} | ${{ needs.build-luci.result == 'success' && 'âœ…' || 'âŒ' }} |
          
          **æ—¶é—´:** ${{ needs.check-version.outputs.build_time }} | **åŽ‹ç¼©:** ${{ env.ENABLE_COMPRESSION == 'true' && 'âœ…' || 'âŒ' }}
          **Release:** [${{ needs.check-version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.version }})
          EOF
          fi
