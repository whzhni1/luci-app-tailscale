name: "æž„å»º Tailscale + LuCIï¼ˆå®Œæ•´ç‰ˆï¼‰"

on:
  workflow_dispatch:
    inputs:
      enable_compression:
        description: 'å¯ç”¨ UPX åŽ‹ç¼©'
        required: true
        type: boolean
        default: true
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

env:
  TAILSCALE_REPO: "tailscale/tailscale"
  UPSTREAM_REPO: "GuNanOvO/openwrt-tailscale"
  LUCI_REPO: "asvow/luci-app-tailscale"
  ENABLE_COMPRESSION: ${{ github.event_name == 'schedule' || inputs.enable_compression == true }}

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      version: ${{ steps.check.outputs.version }}
      current_version: ${{ steps.check.outputs.current_version }}
      build_time: ${{ steps.time.outputs.time }}
      luci_version: ${{ steps.luci.outputs.version }}
    steps:
      - name: "æ£€æŸ¥ç‰ˆæœ¬"
        id: check
        run: |
          upstream=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/tags" | jq -r '.[0].name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"
          
          echo "version=$upstream" >> $GITHUB_OUTPUT
          echo "current_version=$current" >> $GITHUB_OUTPUT
          
          if [ "$upstream" = "$current" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: "èŽ·å– LuCI ç‰ˆæœ¬"
        id: luci
        run: |
          version=$(curl -s "https://api.github.com/repos/${{ env.LUCI_REPO }}/tags" | jq -r '.[0].name // "v1.0.0"')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: "ç”Ÿæˆæž„å»ºæ—¶é—´"
        id: time
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  build-tailscale:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - id: 'arm'
            goarch: 'arm'
            targets: [
              'arm_arm1176jzf-s_vfp', 'arm_arm926ej-s', 'arm_cortex-a15_neon-vfpv4',
              'arm_cortex-a5_vfpv4', 'arm_cortex-a7', 'arm_cortex-a7_neon-vfpv4',
              'arm_cortex-a7_vfpv4', 'arm_cortex-a8_vfpv3', 'arm_cortex-a9',
              'arm_cortex-a9_neon', 'arm_cortex-a9_vfpv3-d16', 'arm_fa526',
              'arm_xscale', 'arm_mpcore'
            ]
          
          - id: 'arm64'
            goarch: 'arm64'
            targets: ['aarch64_cortex-a53', 'aarch64_cortex-a72', 'aarch64_cortex-a76', 'aarch64_generic']
          
          - id: 'mips'
            goarch: 'mips'
            gomips: 'softfloat'
            targets: ['mips_24kc', 'mips_4kec', 'mips_mips32']
          
          - id: 'mipsle'
            goarch: 'mipsle'
            gomips: 'softfloat'
            targets: ['mipsel_24kc', 'mipsel_24kc_24kf', 'mipsel_74kc', 'mipsel_mips32']
          
          - id: 'mips64'
            goarch: 'mips64'
            gomips: 'softfloat'
            targets: ['mips64_mips64r2', 'mips64_octeonplus']
          
          - id: 'mips64le'
            goarch: 'mips64le'
            gomips: 'softfloat'
            targets: ['mips64el_mips64r2']
          
          - id: '386'
            goarch: '386'
            targets: ['i386_pentium-mmx', 'i386_pentium4']
          
          - id: 'amd64'
            goarch: 'amd64'
            cgo: '1'
            cc: 'musl-gcc'
            setup: 'sudo apt-get update && sudo apt-get install -y musl-tools'
            targets: ['x86_64']
          
          - id: 'geode'
            goarch: '386'
            go386: 'softfloat'
            targets: ['i386_geode']

    name: "Tailscale-${{ matrix.platform.id }}"

    steps:
      - name: "çŽ¯å¢ƒå‡†å¤‡"
        if: matrix.platform.setup
        run: ${{ matrix.platform.setup }}

      - name: "æ£€å‡º Tailscale æºç "
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAILSCALE_REPO }}
          ref: ${{ needs.check-version.outputs.version }}
          path: src

      - name: "ä¸‹è½½æ‰“åŒ…æ–‡ä»¶"
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          path: packaging

      - name: "è®¾ç½® Go"
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: "å®‰è£… UPX"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          echo "ðŸ”½ ä¸‹è½½ UPX..."
          UPX_VERSION=$(curl -s https://api.github.com/repos/upx/upx/releases/latest | jq -r '.tag_name')
          wget -q "https://github.com/upx/upx/releases/download/${UPX_VERSION}/upx-${UPX_VERSION#v}-amd64_linux.tar.xz"
          tar -xf upx-*.tar.xz
          sudo mv upx-*/upx /usr/local/bin/
          upx --version

      - name: "ç¼–è¯‘äºŒè¿›åˆ¶"
        working-directory: src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.platform.goarch }}
          GOMIPS: ${{ matrix.platform.gomips || '' }}
          GO386: ${{ matrix.platform.go386 || '' }}
          CGO_ENABLED: ${{ matrix.platform.cgo || '0' }}
          CC: ${{ matrix.platform.cc || '' }}
        run: |
          output="tailscaled-linux-${{ matrix.platform.id }}"
          
          eval `CGO_ENABLED=0 GOOS=$(go env GOHOSTOS) GOARCH=$(go env GOHOSTARCH) go run ./cmd/mkversion`
          
          tags="ts_include_cli,ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_completion,ts_omit_ssh,ts_omit_wakeonlan,ts_omit_capture,ts_omit_relayserver,ts_omit_systray,ts_omit_taildrop,ts_omit_tpm,ts_omit_syspolicy,ts_omit_debugeventbus,ts_omit_webclient"
          ldflags="-X tailscale.com/version.longStamp=${VERSION_LONG} -X tailscale.com/version.shortStamp=${VERSION_SHORT} -s -w"
          
          mkdir -p ../build
          go build -tags "${tags}" -ldflags "${ldflags}" -trimpath -o "../build/${output}" ./cmd/tailscaled
          
          chmod +x "../build/${output}"
          echo "âœ… ç¼–è¯‘å®Œæˆï¼š"
          ls -lh ../build/

      - name: "åŽ‹ç¼©äºŒè¿›åˆ¶"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          binary="build/tailscaled-linux-${{ matrix.platform.id }}"
          
          echo "ðŸ“Š åŽ‹ç¼©å‰å¤§å°ï¼š"
          ls -lh "${binary}"
          
          if [[ "${{ matrix.platform.id }}" =~ ^(mips64|mips64le)$ ]]; then
            echo "âš ï¸ è·³è¿‡ UPX åŽ‹ç¼©ï¼ˆæž¶æž„ä¸æ”¯æŒï¼‰"
          else
            echo "ðŸ—œï¸ å¼€å§‹ UPX åŽ‹ç¼©..."
            if upx --lzma --best "${binary}"; then
              echo "âœ… UPX åŽ‹ç¼©æˆåŠŸ"
              echo "ðŸ“Š åŽ‹ç¼©åŽå¤§å°ï¼š"
              ls -lh "${binary}"
            else
              echo "âš ï¸ UPX åŽ‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŽŸå§‹æ–‡ä»¶"
            fi
          fi

      - name: "æ‰“åŒ… IPK å’Œ APK"
        run: |
          set -e
          
          VERSION=$(echo "${{ needs.check-version.outputs.version }}" | sed 's/^v//')
          EPOCH=$(date +%s)
          
          mkdir -p ipk/usr/bin ipk/etc ipk/lib ipk/CONTROL
          mkdir -p output
          
          binary="build/tailscaled-linux-${{ matrix.platform.id }}"
          
          if [ ! -f "${binary}" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ ${binary}"
            exit 1
          fi
          
          install -m 0755 "${binary}" ipk/usr/bin/tailscaled
          ln -sf tailscaled ipk/usr/bin/tailscale
          
          SIZE=$(du -sb ipk/usr/bin | awk '{print $1}')
          
          cp -a packaging/etc/* ipk/etc/
          cp -a packaging/lib/* ipk/lib/
          cp -a packaging/CONTROL/* ipk/CONTROL/
          chmod +x ipk/etc/init.d/tailscale
          
          echo '2.0' > debian-binary
          
          echo '${{ toJson(matrix.platform.targets) }}' | jq -r '.[]' | while read ARCH; do
            echo "ðŸ“¦ æ‰“åŒ… ${ARCH}..."
            
            # ç”Ÿæˆ IPK
            sed -e "s/__VERSION__/${VERSION}/" \
                -e "s/__ARCH__/${ARCH}/" \
                -e "s/__SIZE__/${SIZE}/" \
                -e "s/__EPOCH__/${EPOCH}/" \
                packaging/CONTROL/control > ipk/CONTROL/control
            
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc ./lib
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/tailscale_${VERSION}_${ARCH}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            # ç”Ÿæˆ APK
            mkdir -p apk-build
            cp -r ipk/* apk-build/
            
            cat > apk-build/.PKGINFO <<EOF
          pkgname = tailscale
          pkgver = ${VERSION}
          pkgdesc = Tailscale VPN client
          url = https://tailscale.com
          arch = ${ARCH}
          license = BSD
          size = ${SIZE}
          EOF
            
            cd apk-build
            tar -czf "../output/tailscale-${VERSION}-r1.${ARCH}.apk" .
            cd ..
            rm -rf apk-build
            
            rm -f control.tar.gz data.tar.gz
          done
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼š"
          ls -lh output/

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.platform.id }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  build-luci:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - sdk: SNAPSHOT
            pkg_type: apk
          - sdk: openwrt-24.10
            pkg_type: ipk

    name: "LuCI-${{ matrix.pkg_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: "æ‹‰å– LuCI æºç "
        run: |
          git clone https://github.com/${{ env.LUCI_REPO }} luci-app-tailscale
          cd luci-app-tailscale
          
          sed -i '/LUCI_DEPENDS:=/d' Makefile
          
          if ! grep -q "conffiles" Makefile; then
            sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
          fi
          
          find . -type f \( -name "*.js" -o -name "tailscale" -o -name "*.sh" \) -exec sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" {} \;
          sed -i 's|/var/lib/tailscale|/var/run/tailscale|g' root/etc/init.d/tailscale 2>/dev/null || true
          
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          D="/etc/config/tailscale_data"
          [ -f "$D/.initialized" ] && exit 0
          mkdir -p "$D" && touch "$D/.initialized"
          rm -f /etc/config/tailscale-opkg
          [ -f /etc/config/tailscale ] && {
            sed -i "s|^config settings|config tailscale|g;/option state_file/d;s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
          }
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null
          rm -f /tmp/luci-indexcache
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - name: "ç¼–è¯‘"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: x86_64-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "æ”¶é›†äº§ç‰©"
        run: |
          mkdir -p output
          find bin/packages -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp -v {} output/ \;
          
          if [ -z "$(ls -A output/)" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          
          echo "âœ… æ”¶é›†å®Œæˆï¼š"
          ls -lh output/

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.pkg_type }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  release:
    needs: [check-version, build-tailscale, build-luci]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è½½æ‰€æœ‰äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: "æ•´ç†æ–‡ä»¶"
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.apk" -o -name "*.ipk" \) -exec cp -v {} release/ \;
          
          if [ -z "$(ls -A release/)" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          
          echo "ðŸ“¦ Release æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh release/
          echo ""
          echo "ðŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "IPK æ–‡ä»¶æ•°: $(ls release/*.ipk 2>/dev/null | wc -l)"
          echo "APK æ–‡ä»¶æ•°: $(ls release/*.apk 2>/dev/null | wc -l)"

      - name: "ç”Ÿæˆ Release è¯´æ˜Ž"
        run: |
          cat > release.md <<'EOF'
          ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
          
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} |
          | æž„å»ºæ—¶é—´ | ${{ needs.check-version.outputs.build_time }} CST |
          | UPX åŽ‹ç¼© | ${{ env.ENABLE_COMPRESSION == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} |
          
          ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
          
          ### 1. å®‰è£… Tailscaleï¼ˆå¿…éœ€ï¼‰
          
          æ ¹æ®ä½ çš„æž¶æž„é€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          **APK (OpenWrt ä¸»çº¿):**
          ```bash
          apk add --allow-untrusted tailscale-*.apk
          ```
          
          **IPK (OpenWrt 24.10):**
          ```bash
          opkg install tailscale_*_æž¶æž„.ipk
          ```
          
          ### 2. å®‰è£… LuCI ç•Œé¢ï¼ˆå¯é€‰ï¼‰
          
          **APK:**
          ```bash
          apk add --allow-untrusted luci-app-tailscale-*.apk
          apk add --allow-untrusted luci-i18n-tailscale-zh-cn-*.apk  # ä¸­æ–‡
          ```
          
          **IPK:**
          ```bash
          opkg install luci-app-tailscale_*_all.ipk
          opkg install luci-i18n-tailscale-zh-cn_*_all.ipk  # ä¸­æ–‡
          ```
          
          ## ðŸ“‹ æ”¯æŒçš„æž¶æž„
          
          - **ARM:** arm_cortex-a7, arm_cortex-a9, arm_cortex-a15, ç­‰ 14 ä¸ªå˜ä½“
          - **ARM64:** aarch64_cortex-a53, aarch64_cortex-a72, aarch64_generic, ç­‰
          - **MIPS:** mips_24kc, mips_mips32, ç­‰
          - **MIPS64:** mips64_mips64r2, mips64_octeonplus
          - **x86:** i386_pentium-mmx, i386_pentium4, i386_geode
          - **x86_64:** x86_64
          
          æŸ¥çœ‹è®¾å¤‡æž¶æž„ï¼š
          ```bash
          opkg print-architecture
          ```
          
          ## ðŸ”§ é…ç½®è¯´æ˜Ž
          
          - é…ç½®æ–‡ä»¶ï¼š`/etc/config/tailscale`
          - æ•°æ®ç›®å½•ï¼š`/etc/config/tailscale_data/`
          - æŽˆæƒæ–‡ä»¶ï¼š`/etc/config/tailscale_data/tailscaled.state`
          
          **ç‰¹æ€§ï¼š**
          - âœ… é‡æ–°å®‰è£…ä¿ç•™é…ç½®
          - âœ… å›ºä»¶å‡çº§ä¿ç•™æ•°æ®
          - âœ… æ— éœ€æ‰‹åŠ¨å®‰è£…ä¾èµ–
          
          ---
          
          **ä¸Šæ¸¸é¡¹ç›®ï¼š**
          - [tailscale/tailscale](https://github.com/${{ env.TAILSCALE_REPO }})
          - [GuNanOvO/openwrt-tailscale](https://github.com/${{ env.UPSTREAM_REPO }})
          - [asvow/luci-app-tailscale](https://github.com/${{ env.LUCI_REPO }})
          EOF

      - name: "å‘å¸ƒåˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.version }}
          name: "Tailscale + LuCI ${{ needs.check-version.outputs.version }}"
          bodyFile: release.md
          artifacts: "release/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  report:
    needs: [check-version, build-tailscale, build-luci]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "ç”ŸæˆæŠ¥å‘Š"
        run: |
          if [ "${{ needs.check-version.outputs.skip }}" = "true" ]; then
            cat > $GITHUB_STEP_SUMMARY <<'EOF'
          # â­ï¸ æž„å»ºè·³è¿‡
          
          **ä¸Šæ¸¸ç‰ˆæœ¬ ${{ needs.check-version.outputs.version }} ä¸Žæœ¬åœ°ç‰ˆæœ¬ ${{ needs.check-version.outputs.current_version }} ç›¸åŒï¼Œæ— éœ€ç¼–è¯‘**
          
          ---
          
          æ£€æŸ¥æ—¶é—´ï¼š${{ needs.check-version.outputs.build_time }} CST
          EOF
          else
            TS_STATUS="${{ needs.build-tailscale.result == 'success' && 'âœ… æˆåŠŸ' || needs.build-tailscale.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}"
            LUCI_STATUS="${{ needs.build-luci.result == 'success' && 'âœ… æˆåŠŸ' || needs.build-luci.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}"
            COMPRESSION="${{ env.ENABLE_COMPRESSION == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}"
            
            cat > $GITHUB_STEP_SUMMARY <<EOF
          # ðŸŽ¯ æž„å»ºæŠ¥å‘Š
          
          | åç§° | ä¸Šæ¸¸ç‰ˆæœ¬ | åŽ‹ç¼©çŠ¶æ€ | ç¼–è¯‘çŠ¶æ€ |
          |------|---------|---------|---------|
          | Tailscale | ${{ needs.check-version.outputs.version }} | ${COMPRESSION} | ${TS_STATUS} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} | æ— éœ€åŽ‹ç¼© | ${LUCI_STATUS} |
          
          ---
          
          **æž„å»ºæ—¶é—´ï¼š** ${{ needs.check-version.outputs.build_time }} CST
          
          **Releaseï¼š** [${{ needs.check-version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.version }})
          
          **æ”¯æŒæž¶æž„ï¼š** arm (14), arm64 (4), mips (3), mipsle (4), mips64 (2), mips64le (1), 386 (2), amd64 (1), geode (1)
          EOF
          fi
