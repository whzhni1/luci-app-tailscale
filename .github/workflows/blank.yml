name: "è‡ªåŠ¨æ„å»º Tailscaleï¼ˆæŒä¹…åŒ–ç‰ˆï¼Œæ ‡å‡†å‘½å IPK/APK ä¸è¯­è¨€åŒ…ï¼‰"

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹è‡ªåŠ¨æ£€æŸ¥
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.check.outputs.need_build }}
      latest_version: ${{ steps.check.outputs.latest_version }}

    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°"
        id: check
        run: |
          set -e
          echo "å¼€å§‹æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°..."
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/releases/latest" \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "è·å–å¤±è´¥")
          current=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>/dev/null \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "v0.0.0")

          echo "=== ç‰ˆæœ¬å¯¹æ¯”ç»“æœ ==="
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $upstream"
          echo "æˆ‘ä»¬çš„ç‰ˆæœ¬: $current"

          if [ "$upstream" != "$current" ] && [ "$upstream" != "è·å–å¤±è´¥" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "latest_version=$upstream" >> $GITHUB_OUTPUT
            echo "ç»“è®º: éœ€è¦æ„å»º"
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
            echo "ç»“è®º: ä¸éœ€è¦æ„å»º"
          fi

      - name: "ğŸ” è¾“å‡ºæ£€æŸ¥ç»“æœ"
        run: |
          echo "need_build = ${{ steps.check.outputs.need_build }}"
          echo "latest_version = ${{ steps.check.outputs.latest_version }}"

      - name: "3ï¸âƒ£ å‡†å¤‡ OpenWrt SDK ç¯å¢ƒï¼ˆx86_64-genericï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          echo "ä¸‹è½½å¹¶è§£å‹ OpenWrt SDKï¼ˆé€‰æ‹© x86_64 generic ä½œä¸ºé€šç”¨æ„å»ºç¯å¢ƒï¼‰"
          SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          curl -LO "$SDK_URL"
          tar -xJf $(basename "$SDK_URL")
          SDK_DIR=$(echo openwrt-sdk-22.03.5-x86-64_*)
          echo "SDK_DIR=${SDK_DIR}"

          cd "$SDK_DIR"

          # åˆå§‹åŒ– feeds
          echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
          echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
          echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
          echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # è·å– luci-app-tailscale æºç åˆ° package/
          echo "å…‹éš† luci-app-tailscale åˆ° package/luci-app-tailscale"
          git clone https://github.com/asvow/luci-app-tailscale package/luci-app-tailscale

          # æ ¹æ®ä¸Šæ¸¸ç¼–è¯‘è¯´æ˜æ›¿æ¢ tailscale é»˜è®¤å¯åŠ¨è„šæœ¬/é…ç½®ï¼ˆé¿å…å†²çªï¼‰
          echo "æŒ‰ä¸Šæ¸¸è¯´æ˜ç§»é™¤é»˜è®¤ tailscale init/config å¼•ç”¨"
          sed -i '/\/etc\/init\.d\/tailscale/d;/\/etc\/config\/tailscale/d;' feeds/packages/net/tailscale/Makefile

          # æ‰“å°åˆå§‹é¡¹ç›®æ–‡ä»¶æ ‘
          echo "=== luci-app-tailscale æ–‡ä»¶åˆ—è¡¨ï¼ˆåˆå§‹ï¼‰ ==="
          (cd package/luci-app-tailscale && find . -type f | sort)

      - name: "4ï¸âƒ£ æŒä¹…åŒ–è·¯å¾„æ›¿æ¢ä¸æ ¡éªŒï¼ˆå…¨å±€ï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$SDK_DIR"

          SOURCE="/etc/tailscale"
          TARGET="/etc/config/tailscale-data"

          echo "å¼€å§‹å…¨å±€æ›¿æ¢ ${SOURCE} -> ${TARGET}ï¼ˆéå†æ•´ä¸ªé¡¹ç›®ï¼‰"
          cd package/luci-app-tailscale

          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œé€ä¸ªæ›¿æ¢å¹¶æ‰“å°ä¿®æ”¹æ–‡ä»¶
          while IFS= read -r f; do
            if [ -f "$f" ] && grep -q "${SOURCE}" "$f"; then
              echo "ä¿®æ”¹æ–‡ä»¶: $f"
              sed -i "s|${SOURCE}|${TARGET}|g" "$f"
            fi
          done < <(find . -type f)

          echo "=== æ›¿æ¢å®Œæˆåå†æ¬¡æ£€æŸ¥ ==="
          echo "åŒ…å«æ–°è·¯å¾„çš„æ–‡ä»¶ï¼š"
          grep -RIl "${TARGET}" . || echo "è­¦å‘Šï¼šæœªå‘ç°æ–°è·¯å¾„ï¼ˆè¯·ç¡®è®¤æ˜¯å¦å­˜åœ¨å¼•ç”¨ï¼‰"

          echo "å±•ç¤ºå…³é”®æ–‡ä»¶ç‰‡æ®µï¼ˆsetting.js / UCI æ¨¡æ¿ï¼‰"
          [ -f htdocs/luci-static/resources/view/tailscale/setting.js ] && sed -n '1,140p' htdocs/luci-static/resources/view/tailscale/setting.js | sed -n '1,40p'
          [ -f root/etc/config/tailscale ] && sed -n '1,140p' root/etc/config/tailscale | sed -n '1,40p'

      - name: "5ï¸âƒ£ éäº¤äº’å¼é…ç½®ï¼ˆå¯ç”¨ apk ä¸åŒ…é€‰æ‹©ï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$SDK_DIR"

          # ç”Ÿæˆ .configï¼ˆå¯ç”¨ luci2 ä¸ apk åŒ…æ ¼å¼ã€ä»¥åŠè¯­è¨€åŒ…ï¼‰
          cat > .config << 'EOF'
CONFIG_ALL_KMODS=y
CONFIG_ALL=y

# ä½¿ç”¨ apk åŒ…æ ¼å¼ï¼ˆéƒ¨åˆ† SDK æ”¯æŒï¼›ä¸æ”¯æŒæ—¶ä»ä¼šç”Ÿæˆ ipkï¼‰
CONFIG_TARGET_PACKAGING_APK=y

# å¯ç”¨ LuCI 2ï¼ˆä¸Šæ¸¸è¯´æ˜è¦æ±‚ï¼‰
CONFIG_LUCI_LANG_zh-cn=y
CONFIG_LUCI_LANG_zh-tw=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_liblucihttp=y
CONFIG_PACKAGE_liblucihttp-ucode=y

# é€‰æ‹©åº”ç”¨ä¸è¯­è¨€åŒ…
CONFIG_PACKAGE_luci-app-tailscale=y
CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y
CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y
EOF

          echo "æ‰§è¡Œ defconfig"
          make defconfig

      - name: "6ï¸âƒ£ ç¼–è¯‘ luci-app-tailscale ä¸è¯­è¨€åŒ…ï¼ˆç”Ÿæˆ IPK/APKï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$SDK_DIR"

          echo "å¼€å§‹ç¼–è¯‘ luci-app-tailscaleï¼ˆå«è¯­è¨€åŒ…ï¼‰"
          make package/luci-app-tailscale/compile V=s || (echo "æ„å»ºå¤±è´¥ï¼Œå°è¯•å†æ¬¡æ„å»º" && make package/luci-app-tailscale/compile V=s)
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s || true

          echo "=== æ„å»ºäº§ç‰©ç›®å½•ç»“æ„ ==="
          find bin -type f | sort || true

      - name: "7ï¸âƒ£ æ”¶é›†äº§ç‰©å¹¶æ ‡å‡†é‡å‘½å"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        id: artifacts
        run: |
          set -e
          cd "$SDK_DIR"

          VER="${{ steps.check.outputs.latest_version }}"
          OUT_DIR="${PWD}/out"
          mkdir -p "$OUT_DIR"

          echo "æœé›† IPK/APK ä¸è¯­è¨€åŒ…ï¼ˆæ ¹æ®æ–‡ä»¶åæ¨¡å¼ï¼‰"
          # IPK
          find bin -type f -name "luci-app-tailscale_*_all.ipk" -exec cp -v {} "$OUT_DIR/" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-cn_*_all.ipk" -exec cp -v {} "$OUT_DIR/" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-tw_*_all.ipk" -exec cp -v {} "$OUT_DIR/" \; || true
          # APKï¼ˆè‹¥ SDK æ”¯æŒ APK æ‰“åŒ…ï¼Œåˆ™ä¼šç”Ÿæˆï¼›å¦åˆ™æ­¤æ­¥éª¤å¯èƒ½ä¸ºç©ºï¼‰
          find bin -type f -name "luci-app-tailscale-*_*.apk" -exec cp -v {} "$OUT_DIR/" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-cn-*_*.apk" -exec cp -v {} "$OUT_DIR/" \; || true
          find bin -type f -name "luci-i18n-tailscale-zh-tw-*_*.apk" -exec cp -v {} "$OUT_DIR/" \; || true

          echo "äº§ç‰©åˆ—è¡¨ï¼š"
          ls -lh "$OUT_DIR" || true

          # æ ‡å‡†åŒ–é‡å‘½åï¼ˆè‹¥å®é™…ç‰ˆæœ¬å·æ— æ³•ä»æ„å»ºç³»ç»Ÿç›´æ¥åæ¨ï¼Œåˆ™ç”¨ upstream tag å‘½åï¼‰
          # APK ç”¨ä¸Šæ¸¸æ¨¡å¼ï¼šluci-app-tailscale-<ver>-r1.apk
          # æ³¨æ„ï¼šè‹¥æ„å»ºå‡ºçš„ APK å·²ç¬¦åˆæ­¤å‘½åï¼Œåˆ™æ— éœ€é‡å‘½åï¼›æ­¤å¤„ä»…é’ˆå¯¹ä¸ä¸€è‡´æƒ…å†µ
          for f in "$OUT_DIR"/luci-app-tailscale-*.apk; do
            [ -f "$f" ] || continue
            mv -v "$f" "$OUT_DIR/luci-app-tailscale-${VER}-r1.apk" || true
          done

          for f in "$OUT_DIR"/luci-i18n-tailscale-zh-cn-*.apk; do
            [ -f "$f" ] || continue
            mv -v "$f" "$OUT_DIR/luci-i18n-tailscale-zh-cn-${VER}.apk" || true
          done

          for f in "$OUT_DIR"/luci-i18n-tailscale-zh-tw-*.apk; do
            [ -f "$f" ] || continue
            mv -v "$f" "$OUT_DIR/luci-i18n-tailscale-zh-tw-${VER}.apk" || true
          done

          echo "æœ€ç»ˆäº§ç‰©åˆ—è¡¨ï¼ˆé‡å‘½ååï¼‰ï¼š"
          ls -lh "$OUT_DIR" || true

          # æš´éœ²äº§ç‰©è·¯å¾„ç”¨äºåç»­ä¸Šä¼ 
          echo "OUT_DIR=${OUT_DIR}" >> $GITHUB_OUTPUT

      - name: "8ï¸âƒ£ å‘å¸ƒå‰çš„æ£€æŸ¥ï¼ˆé¿å… Too many retriesï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          echo "æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨ï¼š"
          ls -lh "${{ steps.artifacts.outputs.OUT_DIR }}" || (echo "äº§ç‰©ç›®å½•ä¸å­˜åœ¨" && exit 1)
          cnt=$(ls "${{ steps.artifacts.outputs.OUT_DIR }}" | wc -l)
          echo "äº§ç‰©æ•°é‡: $cnt"
          if [ "$cnt" -eq 0 ]; then
            echo "æœªæ‰¾åˆ°ä»»ä½•äº§ç‰©ï¼Œå–æ¶ˆå‘å¸ƒã€‚"
            exit 1
          fi

      - name: "9ï¸âƒ£ å‘å¸ƒåˆ° Releasesï¼ˆæ ‡å‡†å‘½åï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.check.outputs.latest_version }}-persistent"
          name: "luci-app-tailscale ${{ steps.check.outputs.latest_version }} (æŒä¹…åŒ–é…ç½®ç‰ˆ)"
          files: "${{ steps.artifacts.outputs.OUT_DIR }}/*"
          body: |
            - æ„å»ºæ–¹å¼ï¼šOpenWrt SDKï¼ŒæŒ‰ä¸Šæ¸¸è¯´æ˜å¹¶å¯ç”¨ APK æ‰“åŒ…é€‰é¡¹
            - æŒä¹…åŒ–è·¯å¾„ï¼š/etc/config/tailscale-dataï¼ˆå‰ç«¯/åç«¯/é…ç½®æ¨¡æ¿ä¸€è‡´ï¼‰
            - äº§ç‰©åŒ…å«ï¼š
              * luci-app-tailscale_<ver>_all.ipk
              * luci-app-tailscale-<ver>-r1.apkï¼ˆè‹¥ SDK æ”¯æŒ APKï¼‰
              * luci-i18n-tailscale-zh-cn_<ver>_all.ipk / .apkï¼ˆè‹¥ç”Ÿæˆï¼‰
              * luci-i18n-tailscale-zh-tw_<ver>_all.ipk / .apkï¼ˆè‹¥ç”Ÿæˆï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
