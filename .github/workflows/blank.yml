name: "è‡ªåŠ¨æ„å»º Tailscaleï¼ˆæŒä¹…åŒ–é…ç½®ç‰ˆï¼Œè‡ªåŠ¨è¯†åˆ«å‰åç«¯æ–‡ä»¶ï¼‰"

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹è‡ªåŠ¨æ£€æŸ¥
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.check.outputs.need_build }}
      latest_version: ${{ steps.check.outputs.latest_version }}

    steps:
      - name: "1ï¸âƒ£ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°"
        id: check
        run: |
          echo "å¼€å§‹æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°..."
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/releases/latest" \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "è·å–å¤±è´¥")
          current=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>/dev/null \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "v0.0.0")

          echo "=== ç‰ˆæœ¬å¯¹æ¯”ç»“æœ ==="
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $upstream"
          echo "æˆ‘ä»¬çš„ç‰ˆæœ¬: $current"

          if [ "$upstream" != "$current" ] && [ "$upstream" != "è·å–å¤±è´¥" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "latest_version=$upstream" >> $GITHUB_OUTPUT
            echo "ç»“è®º: éœ€è¦æ„å»º"
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
            echo "ç»“è®º: ä¸éœ€è¦æ„å»º"
          fi

      - name: "ğŸ” è¾“å‡ºæ£€æŸ¥ç»“æœ"
        run: |
          echo "need_build = ${{ steps.check.outputs.need_build }}"
          echo "latest_version = ${{ steps.check.outputs.latest_version }}"

      - name: "3ï¸âƒ£ å…‹éš†å¹¶æ‰«ææºç "
        if: ${{ steps.check.outputs.need_build == 'true' }}
        id: scan
        run: |
          set -e
          echo "æ­£åœ¨å…‹éš†ä¸Šæ¸¸æºç ..."
          git clone https://github.com/asvow/luci-app-tailscale
          cd luci-app-tailscale

          echo "å…¨å±€æ‰«æåŒ…å« /etc/tailscale çš„æ–‡ä»¶..."
          matches=$(grep -RIl "/etc/tailscale" . || true)

          if [ -z "$matches" ]; then
            echo "æœªå‘ç°ä»»ä½•åŒ…å« /etc/tailscale çš„æ–‡ä»¶ï¼Œå¯èƒ½ä¸Šæ¸¸å·²æ”¹ç”¨å…¶ä»–è·¯å¾„"
            exit 1
          fi

          echo "å‘ç°ä»¥ä¸‹æ–‡ä»¶:"
          echo "$matches"

          # åˆ†ç±»
          frontend=$(echo "$matches" | grep "htdocs" || true)
          backend=$(echo "$matches" | grep -E "files|luasrc" || true)
          others=$(echo "$matches" | grep -vE "htdocs|files|luasrc" || true)

          echo "å‰ç«¯æ–‡ä»¶:"
          echo "${frontend:-<æ— >}"
          echo "åç«¯æ–‡ä»¶:"
          echo "${backend:-<æ— >}"
          echo "å…¶ä»–æ–‡ä»¶:"
          echo "${others:-<æ— >}"

          # è¾“å‡ºåˆ° GITHUB_OUTPUT
          echo "frontend<<EOF" >> $GITHUB_OUTPUT
          echo "$frontend" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "backend<<EOF" >> $GITHUB_OUTPUT
          echo "$backend" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "others<<EOF" >> $GITHUB_OUTPUT
          echo "$others" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          cd ..

      - name: "4ï¸âƒ£ æ›¿æ¢è·¯å¾„å¹¶æ ¡éªŒ"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd luci-app-tailscale

          SOURCE="/etc/tailscale"
          TARGET="/etc/config/tailscale-data"

          echo "å¼€å§‹æ›¿æ¢ ${SOURCE} -> ${TARGET}"

          all_files="${{ steps.scan.outputs.frontend }} ${{ steps.scan.outputs.backend }} ${{ steps.scan.outputs.others }}"
          for f in $all_files; do
            if [ -f "$f" ]; then
              echo "æ›¿æ¢æ–‡ä»¶: $f"
              sed -i "s|${SOURCE}|${TARGET}|g" "$f"
            fi
          done

          echo "æ›¿æ¢å®Œæˆï¼Œæ ¡éªŒç»“æœ:"
          grep -RIl "${TARGET}" . || echo "è­¦å‘Šï¼šæœªå‘ç°æ–°è·¯å¾„"

          cd ..


      - name: "4ï¸âƒ£ æ‰§è¡Œè·¯å¾„æ›¿æ¢å¹¶æ ¡éªŒ"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd luci-app-tailscale

          TARGET="/etc/config/tailscale-data"
          SOURCE="/etc/tailscale"

          echo "å¼€å§‹æ›¿æ¢è·¯å¾„: ${SOURCE} -> ${TARGET}"

          # å¯¹å‰ç«¯æ–‡ä»¶æ‰§è¡Œæ›¿æ¢
          if [ -n "${{ steps.scan.outputs.frontend_files }}" ]; then
            echo "æ›¿æ¢å‰ç«¯æ–‡ä»¶:"
            printf "%s\n" "${{ steps.scan.outputs.frontend_files }}"
            printf "%s\n" "${{ steps.scan.outputs.frontend_files }}" | while read -r f; do
              [ -n "$f" ] && sed -i "s|${SOURCE}|${TARGET}|g" "$f"
            done
          else
            echo "è­¦å‘Šï¼šæœªè‡ªåŠ¨è¯†åˆ«åˆ°å‰ç«¯æ–‡ä»¶ï¼Œå°è¯•å¸¸è§é»˜è®¤è·¯å¾„å›é€€..."
            if [ -f "htdocs/luci-static/resources/view/tailscale/setting.js" ]; then
              sed -i "s|${SOURCE}|${TARGET}|g" htdocs/luci-static/resources/view/tailscale/setting.js
              echo "å·²å›é€€æ›¿æ¢: htdocs/luci-static/resources/view/tailscale/setting.js"
            fi
          fi

          # å¯¹åç«¯æ–‡ä»¶æ‰§è¡Œæ›¿æ¢
          if [ -n "${{ steps.scan.outputs.backend_files }}" ]; then
            echo "æ›¿æ¢åç«¯æ–‡ä»¶:"
            printf "%s\n" "${{ steps.scan.outputs.backend_files }}"
            printf "%s\n" "${{ steps.scan.outputs.backend_files }}" | while read -r f; do
              [ -n "$f" ] && sed -i "s|${SOURCE}|${TARGET}|g" "$f"
            done
          else
            echo "è­¦å‘Šï¼šæœªè‡ªåŠ¨è¯†åˆ«åˆ°åç«¯æ–‡ä»¶ï¼Œå°è¯•å¸¸è§é»˜è®¤è·¯å¾„å›é€€..."
            if [ -f "files/luasrc/model/cbi/tailscale.lua" ]; then
              sed -i "s|${SOURCE}|${TARGET}|g" files/luasrc/model/cbi/tailscale.lua
              echo "å·²å›é€€æ›¿æ¢: files/luasrc/model/cbi/tailscale.lua"
            fi
          fi

          echo "æ›¿æ¢å®Œæˆï¼Œå¼€å§‹è¿›è¡Œæ ¡éªŒ..."
          # æ ¡éªŒè‡³å°‘æœ‰ä¸€å¤„æ›¿æ¢ç”Ÿæ•ˆ
          count_new=$(grep -RIl "${TARGET}" htdocs files luasrc 2>/dev/null | wc -l || true)
          count_old=$(grep -RIl "${SOURCE}" htdocs files luasrc 2>/dev/null | wc -l || true)
          echo "åŒ…å«æ–°è·¯å¾„çš„æ–‡ä»¶æ•°: ${count_new}"
          echo "ä»åŒ…å«æ—§è·¯å¾„çš„æ–‡ä»¶æ•°: ${count_old}"

          if [ "${count_new}" -eq 0 ]; then
            echo "é”™è¯¯ï¼šæœªå‘ç°ä»»ä½•æ–‡ä»¶åŒ…å«æ–°è·¯å¾„ ${TARGET}ï¼Œæ›¿æ¢å¯èƒ½å¤±è´¥"
            exit 1
          fi

          echo "æ ¡éªŒé€šè¿‡ï¼šå‘ç° ${count_new} ä¸ªæ–‡ä»¶å·²ä½¿ç”¨æŒä¹…åŒ–è·¯å¾„ã€‚"
          if [ "${count_old}" -gt 0 ]; then
            echo "æç¤ºï¼šä»æœ‰ ${count_old} ä¸ªæ–‡ä»¶åŒ…å«æ—§è·¯å¾„ ${SOURCE}ï¼Œè¯·æ³¨æ„æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ›¿æ¢ã€‚"
          fi

          cd ..

      - name: "5ï¸âƒ£ æ„å»º IPK åŒ…"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          echo "å¼€å§‹æ„å»º IPK åŒ…..."
          mkdir -p ipk-build/control ipk-build/data

          # æ‹·è´æ–‡ä»¶å†…å®¹
          cp -r luci-app-tailscale/files/* ipk-build/data/ 2>/dev/null || true
          cp -r luci-app-tailscale/htdocs ipk-build/data/ 2>/dev/null || true
          cp -r luci-app-tailscale/luasrc ipk-build/data/ 2>/dev/null || true

          # ç”Ÿæˆ control æ–‡ä»¶ï¼ˆé¿å… heredocï¼Œç”¨ echo æ‹¼æ¥ï¼‰
          {
            echo "Package: luci-app-tailscale"
            echo "Version: ${{ steps.check.outputs.latest_version }}-persistent1"
            echo "Depends: libc, tailscale"
            echo "Source: luci-app-tailscale"
            echo "Section: luci"
            echo "Architecture: all"
            echo "Installed-Size: 1024"
            echo "Description: Tailscale LuCI app with persistent config"
            echo " æŒä¹…åŒ–é…ç½®ç‰ˆæœ¬ï¼Œè§£å†³å›ºä»¶å‡çº§é…ç½®ä¸¢å¤±é—®é¢˜"
            echo " é…ç½®è·¯å¾„: /etc/config/tailscale-data"
          } > ipk-build/control/control

          # æ‰“åŒ… IPK
          cd ipk-build
          tar -czf control.tar.gz -C control .
          tar -czf data.tar.gz -C data .
          echo "2.0" > debian-binary
          ar r ../luci-app-tailscale-persistent.ipk debian-binary control.tar.gz data.tar.gz
          cd ..
          echo "IPK åŒ…æ„å»ºå®Œæˆ âœ…"

      - name: "6ï¸âƒ£ æ„å»ºåéªŒè¯ï¼ˆæ‰“å°å·®å¼‚ä¸å…³é”®æ–‡ä»¶æ‘˜è¦ï¼‰"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          echo "æ‰“å°åŒ…å«æŒä¹…åŒ–è·¯å¾„çš„æ–‡ä»¶åˆ—è¡¨ä¸æ‘˜è¦ï¼š"
          grep -RIl "/etc/config/tailscale-data" luci-app-tailscale | xargs -r -n1 sh -c 'echo "---- $1 ----"; sed -n "1,120p" "$1" | sed -n "1,15p"' sh

          echo "å±•ç¤º control æ–‡ä»¶ï¼š"
          sed -n '1,80p' ipk-build/control/control

      - name: "7ï¸âƒ£ å‘å¸ƒåˆ° Releases"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.check.outputs.latest_version }}-persistent"
          name: "luci-app-tailscale ${{ steps.check.outputs.latest_version }} (æŒä¹…åŒ–é…ç½®ç‰ˆ)"
          files: "luci-app-tailscale-persistent.ipk"
          body: |
            luci-app-tailscale æŒä¹…åŒ–é…ç½®ç‰ˆæœ¬ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶æ›¿æ¢å‰ç«¯/åç«¯è·¯å¾„ï¼Œè§£å†³å›ºä»¶å‡çº§é…ç½®ä¸¢å¤±é—®é¢˜
            é…ç½®è·¯å¾„: /etc/config/tailscale-data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
