name: "自动构建 Tailscale（IPK + APK 双格式）"

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      need_build: ${{ steps.check.outputs.need_build }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      release_tag: ${{ steps.tag.outputs.release_tag }}

    steps:
      - name: "1️⃣ 检出代码"
        uses: actions/checkout@v4

      - name: "2️⃣ 检查上游版本"
        id: check
        run: |
          set -e
          upstream=$(curl -s "https://api.github.com/repos/asvow/luci-app-tailscale/releases/latest" \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "获取失败")
          current=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>/dev/null \
            | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "none")

          echo "上游版本: $upstream"
          echo "当前版本: $current"

          if [ "$upstream" != "$current" ] && [ "$upstream" != "获取失败" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            echo "latest_version=$upstream" >> $GITHUB_OUTPUT
          else
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "latest_version=$current" >> $GITHUB_OUTPUT
          fi

      - name: "3️⃣ 生成唯一 tag"
        id: tag
        run: |
          set -e
          base="${{ steps.check.outputs.latest_version }}-persistent"
          echo "拟用 tag: $base"

          resp=$(curl -s -o /tmp/tag.json -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$base")

          if [ "$resp" = "200" ]; then
            echo "tag 已存在，追加时间戳"
            suffix=$(date -u +%Y%m%d-%H%M%S)
            base="${base}-${suffix}"
          else
            echo "tag 不存在，可以直接使用"
          fi

          echo "release_tag=$base" >> $GITHUB_OUTPUT

      # =========================
      # IPK 构建（OpenWrt 22.03）
      # =========================
      - name: "4️⃣ 下载并准备 OpenWrt 22.03 SDK（IPK）"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          curl -LO "$SDK_URL"
          tar -xJf "$(basename "$SDK_URL")"
          SDK_DIR=$(realpath $(find . -maxdepth 1 -type d -name "openwrt-sdk-22.03.5-*"))
          echo "IPK_SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

          cd "$SDK_DIR"
          echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
          echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install luci liblucihttp liblucihttp-ucode
          git clone https://github.com/asvow/luci-app-tailscale package/luci-app-tailscale

      - name: "5️⃣ IPK：替换路径并编译"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$IPK_SDK_DIR/package/luci-app-tailscale"
          sed -i "s|/etc/tailscale|/etc/config/tailscale-data|g" $(grep -rl "/etc/tailscale" .)

          cd "$IPK_SDK_DIR"
          cat > .config <<EOF
          CONFIG_ALL_KMODS=y
          CONFIG_ALL=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_liblucihttp=y
          CONFIG_PACKAGE_liblucihttp-ucode=y
          CONFIG_LUCI_LANG_zh-cn=y
          CONFIG_LUCI_LANG_zh-tw=y
          CONFIG_PACKAGE_luci-app-tailscale=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y
          EOF
          make defconfig
          make package/luci-app-tailscale/compile V=s
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s || true
          make package/feeds/luci/luci-i18n-tailscale-zh-tw/compile V=s || true

          mkdir -p out-ipk
          cp bin/packages/*/*/luci-app-tailscale_*_all.ipk out-ipk/ || true
          cp bin/packages/*/*/luci-i18n-tailscale-zh-*_all.ipk out-ipk/ || true
          echo "IPK_OUT=$PWD/out-ipk" >> $GITHUB_ENV

      # =========================
      # APK 构建（OpenWrt 24.10）
      # =========================
      - name: "6️⃣ 下载并准备 OpenWrt 24.10 SDK（APK）"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          SDK_URL="https://downloads.openwrt.org/releases/24.10.0-rc1/targets/x86/64/openwrt-sdk-24.10.0-rc1-x86-64_gcc-13.2.0_musl.Linux-x86_64.tar.xz"
          curl -LO "$SDK_URL"
          tar -xJf "$(basename "$SDK_URL")"
          SDK_DIR=$(realpath $(find . -maxdepth 1 -type d -name "openwrt-sdk-24.*-x86-64*"))
          echo "APK_SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

          cd "$SDK_DIR"
          echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
          echo "src-git luci https://git.openwrt.org/project/luci.git" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install luci liblucihttp liblucihttp-ucode
          git clone https://github.com/asvow/luci-app-tailscale package/luci-app-tailscale

      - name: "7️⃣ APK：替换路径并编译"
        if: ${{ steps.check.outputs.need_build == 'true' }}
        run: |
          set -e
          cd "$APK_SDK_DIR/package/luci-app-tailscale"
          sed -i "s|/etc/tailscale|/etc/config/tailscale-data|g" $(grep -rl "/etc/tailscale" .)

          cd "$APK_SDK_DIR"
          cat > .config <<EOF
          CONFIG_ALL_KMODS=y
          CONFIG_ALL=y
          CONFIG_TARGET_PACKAGING_APK=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_liblucihttp=y
          CONFIG_PACKAGE_liblucihttp-ucode=y
          CONFIG_LUCI_LANG_zh-cn=y
          CONFIG_LUCI_LANG_zh-tw=y
          CONFIG_PACKAGE_luci-app-tailscale=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-tailscale-zh-tw=y
          EOF
          make defconfig
          make package/luci-app-tailscale/compile V=s
          make package/feeds/luci/luci-i18n-tailscale-zh-cn/compile V=s || true
          make package/feeds/luci/luci-i18n-tailscale-zh-t
