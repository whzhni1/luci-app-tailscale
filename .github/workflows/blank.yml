name: "æž„å»º Tailscale + LuCIï¼ˆå®Œæ•´ç‰ˆï¼‰"

on:
  workflow_dispatch:
    inputs:
      enable_compression:
        description: 'å¯ç”¨ UPX åŽ‹ç¼©'
        required: true
        type: boolean
        default: true
  schedule:
    - cron: '0 16 * * *'

permissions:
  contents: write

env:
  TAILSCALE_REPO: "tailscale/tailscale"
  IMM_PACKAGES_REPO: "immortalwrt/packages"
  LUCI_REPO: "asvow/luci-app-tailscale"
  ENABLE_COMPRESSION: ${{ github.event_name == 'schedule' || inputs.enable_compression == true }}

jobs:
  # ========================================
  # ä»»åŠ¡ 1: æ£€æŸ¥ç‰ˆæœ¬
  # ========================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      version: ${{ steps.check.outputs.version }}
      current_version: ${{ steps.check.outputs.current_version }}
      build_time: ${{ steps.time.outputs.time }}
      luci_version: ${{ steps.luci.outputs.version }}
    steps:
      - name: "æ£€æŸ¥ Tailscale ç‰ˆæœ¬"
        id: check
        run: |
          upstream=$(curl -s "https://api.github.com/repos/${{ env.TAILSCALE_REPO }}/releases/latest" | jq -r '.tag_name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"
          
          echo "version=$upstream" >> $GITHUB_OUTPUT
          echo "current_version=$current" >> $GITHUB_OUTPUT
          
          if [ "$upstream" = "$current" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: "èŽ·å– LuCI ç‰ˆæœ¬"
        id: luci
        run: |
          version=$(curl -s "https://api.github.com/repos/${{ env.LUCI_REPO }}/releases/latest" | jq -r '.tag_name // "none"')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: "ç”Ÿæˆæž„å»ºæ—¶é—´"
        id: time
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  # ========================================
  # ä»»åŠ¡ 2: ç¼–è¯‘ Tailscaleï¼ˆLuCI å…¼å®¹ç‰ˆï¼‰
  # ========================================
  build-tailscale:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM 32-bit
          - id: arm
            goarch: arm
            targets: '["arm_arm1176jzf-s_vfp","arm_arm926ej-s","arm_cortex-a15_neon-vfpv4","arm_cortex-a5_vfpv4","arm_cortex-a7","arm_cortex-a7_neon-vfpv4","arm_cortex-a7_vfpv4","arm_cortex-a8_vfpv3","arm_cortex-a9","arm_cortex-a9_neon","arm_cortex-a9_vfpv3-d16","arm_fa526","arm_xscale","arm_mpcore"]'
          
          # ARM 64-bit
          - id: arm64
            goarch: arm64
            targets: '["aarch64_cortex-a53","aarch64_cortex-a72","aarch64_cortex-a76","aarch64_generic"]'
          
          # MIPS 32-bit Big Endian
          - id: mips
            goarch: mips
            gomips: softfloat
            targets: '["mips_24kc","mips_4kec","mips_mips32"]'
          
          # MIPS 32-bit Little Endian
          - id: mipsle
            goarch: mipsle
            gomips: softfloat
            targets: '["mipsel_24kc","mipsel_24kc_24kf","mipsel_74kc","mipsel_mips32"]'
          
          # MIPS 64-bit Big Endian
          - id: mips64
            goarch: mips64
            gomips: softfloat
            targets: '["mips64_mips64r2","mips64_octeonplus"]'
          
          # MIPS 64-bit Little Endian
          - id: mips64le
            goarch: mips64le
            gomips: softfloat
            targets: '["mips64el_mips64r2"]'
          
          # x86 32-bit
          - id: "386"
            goarch: "386"
            targets: '["i386_pentium-mmx","i386_pentium4"]'
          
          # x86 64-bit (with musl)
          - id: amd64
            goarch: amd64
            cgo: "1"
            cc: musl-gcc
            setup: sudo apt-get update && sudo apt-get install -y musl-tools
            targets: '["x86_64"]'
          
          # Geode (x86 with soft float)
          - id: geode
            goarch: "386"
            go386: softfloat
            targets: '["i386_geode"]'

    name: "Tailscale-${{ matrix.id }}"

    steps:
      - name: "çŽ¯å¢ƒå‡†å¤‡"
        if: matrix.setup
        run: ${{ matrix.setup }}

      - name: "æ£€å‡º Tailscale æºç "
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAILSCALE_REPO }}
          ref: ${{ needs.check-version.outputs.version }}
          path: src

      - name: "è®¾ç½® Go"
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: "å®‰è£… UPX"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          echo "ðŸ”½ ä¸‹è½½ UPX..."
          UPX_VERSION=$(curl -s https://api.github.com/repos/upx/upx/releases/latest | jq -r '.tag_name')
          wget -q "https://github.com/upx/upx/releases/download/${UPX_VERSION}/upx-${UPX_VERSION#v}-amd64_linux.tar.xz"
          tar -xf upx-*.tar.xz
          sudo mv upx-*/upx /usr/local/bin/
          upx --version

      - name: "ç¼–è¯‘äºŒè¿›åˆ¶"
        working-directory: src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips || '' }}
          GO386: ${{ matrix.go386 || '' }}
          CGO_ENABLED: ${{ matrix.cgo || '0' }}
          CC: ${{ matrix.cc || '' }}
        run: |
          output="tailscaled-linux-${{ matrix.id }}"
          
          eval `CGO_ENABLED=0 GOOS=$(go env GOHOSTOS) GOARCH=$(go env GOHOSTARCH) go run ./cmd/mkversion`
          
          tags="ts_include_cli,ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_completion,ts_omit_ssh,ts_omit_wakeonlan,ts_omit_capture,ts_omit_relayserver,ts_omit_systray,ts_omit_taildrop,ts_omit_tpm,ts_omit_syspolicy,ts_omit_debugeventbus,ts_omit_webclient"
          ldflags="-X tailscale.com/version.longStamp=${VERSION_LONG} -X tailscale.com/version.shortStamp=${VERSION_SHORT} -s -w"
          
          mkdir -p ../build
          go build -tags "${tags}" -ldflags "${ldflags}" -trimpath -o "../build/${output}" ./cmd/tailscaled
          
          chmod +x "../build/${output}"
          echo "âœ… ç¼–è¯‘å®Œæˆï¼š"
          ls -lh ../build/

      - name: "åŽ‹ç¼©äºŒè¿›åˆ¶"
        if: env.ENABLE_COMPRESSION == 'true'
        run: |
          binary="build/tailscaled-linux-${{ matrix.id }}"
          
          echo "ðŸ“Š åŽ‹ç¼©å‰å¤§å°ï¼š"
          ls -lh "${binary}"
          
          if [[ "${{ matrix.id }}" =~ ^(mips64|mips64le)$ ]]; then
            echo "âš ï¸ è·³è¿‡ UPX åŽ‹ç¼©ï¼ˆæž¶æž„ä¸æ”¯æŒï¼‰"
          else
            echo "ðŸ—œï¸ å¼€å§‹ UPX åŽ‹ç¼©..."
            if upx --lzma --best "${binary}"; then
              echo "âœ… UPX åŽ‹ç¼©æˆåŠŸ"
              echo "ðŸ“Š åŽ‹ç¼©åŽå¤§å°ï¼š"
              ls -lh "${binary}"
            else
              echo "âš ï¸ UPX åŽ‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŽŸå§‹æ–‡ä»¶"
            fi
          fi

      - name: "ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆLuCI å…¼å®¹ç‰ˆï¼‰"
        run: |
          echo "ðŸ“¥ ä¸‹è½½é…ç½®æ–‡ä»¶..."
          mkdir -p config_files
          
          # ========================================
          # ðŸ”¥ ä»Ž LuCI æºç èŽ·å– init.dï¼ˆä¿è¯ LuCI å®Œç¾ŽæŽ§åˆ¶ï¼‰
          # ========================================
          echo "ðŸ“¥ å…‹éš† LuCI æºç èŽ·å– init.d..."
          git clone --depth=1 https://github.com/${{ env.LUCI_REPO }} /tmp/luci-source
          
          if [ -f /tmp/luci-source/root/etc/init.d/tailscale ]; then
            echo "âœ… æ‰¾åˆ° LuCI çš„ init.d è„šæœ¬"
            cp /tmp/luci-source/root/etc/init.d/tailscale config_files/tailscale.init
            
            # ðŸ”¥ ä¿®æ”¹è·¯å¾„ä»¥å…¼å®¹ /usr/sbinï¼ˆLuCI æ˜¾ç¤ºéœ€è¦ï¼‰
            echo "ðŸ”§ ä¿®æ”¹ init.d è·¯å¾„ï¼š/usr/bin â†’ /usr/sbin..."
            sed -i 's|/usr/bin/tailscaled|/usr/sbin/tailscaled|g' config_files/tailscale.init
            sed -i 's|/usr/bin/tailscale|/usr/sbin/tailscale|g' config_files/tailscale.init
            
            # éªŒè¯ä¿®æ”¹
            if grep -q "/usr/sbin/tailscale" config_files/tailscale.init; then
              echo "âœ… init.d è·¯å¾„å·²ä¿®æ”¹ä¸º /usr/sbin"
            else
              echo "âš ï¸ è­¦å‘Šï¼šinit.d ä¸­æœªæ‰¾åˆ° tailscale è·¯å¾„"
            fi
          else
            echo "âŒ é”™è¯¯ï¼šLuCI æºç ä¸­æœªæ‰¾åˆ° init.d"
            exit 1
          fi
          
          # ========================================
          # ä»Ž IMM ä¸‹è½½é…ç½®æ–‡ä»¶
          # ========================================
          echo "ðŸ“¥ ä¸‹è½½ IMM å®˜æ–¹é…ç½®æ–‡ä»¶..."
          curl -fsSL -o config_files/tailscale.conf \
            https://raw.githubusercontent.com/${{ env.IMM_PACKAGES_REPO }}/master/net/tailscale/files/tailscale.conf
          
          chmod +x config_files/tailscale.init
          
          echo "âœ… é…ç½®æ–‡ä»¶å‡†å¤‡å®Œæˆï¼š"
          ls -lh config_files/
          
          echo ""
          echo "ðŸ“„ init.d è„šæœ¬å†…å®¹ï¼ˆå‰ 30 è¡Œï¼‰ï¼š"
          head -30 config_files/tailscale.init

      - name: "æ‰“åŒ… IPK å’Œ APK"
        run: |
          set -e
          
          VERSION=$(echo "${{ needs.check-version.outputs.version }}" | sed 's/^v//')
          
          # ========================================
          # åˆ›å»ºç›®å½•ç»“æž„ï¼ˆIMM é£Žæ ¼ + LuCI å…¼å®¹ï¼‰
          # ========================================
          mkdir -p ipk/usr/sbin ipk/usr/bin ipk/etc/config ipk/etc/init.d ipk/CONTROL
          mkdir -p output
          
          binary="build/tailscaled-linux-${{ matrix.id }}"
          
          if [ ! -f "${binary}" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ ${binary}"
            exit 1
          fi
          
          # ========================================
          # ðŸ”¥ å®‰è£…åˆ° /usr/sbinï¼ˆLuCI æ˜¾ç¤ºéœ€è¦ï¼‰
          # ========================================
          echo "ðŸ“¦ å®‰è£…åˆ° /usr/sbin (LuCI å…¼å®¹)..."
          install -m 0755 "${binary}" ipk/usr/sbin/tailscaled
          ln -sf tailscaled ipk/usr/sbin/tailscale
          
          # ðŸ”¥ åœ¨ /usr/bin åˆ›å»ºè½¯é“¾æŽ¥ï¼ˆå‘½ä»¤è¡Œä½¿ç”¨ï¼‰
          ln -sf ../sbin/tailscaled ipk/usr/bin/tailscaled
          ln -sf ../sbin/tailscale ipk/usr/bin/tailscale
          
          SIZE=$(du -b ipk/usr/sbin/tailscaled | awk '{print $1}')
          
          # ========================================
          # ðŸ”¥ å®‰è£…é…ç½®æ–‡ä»¶ï¼ˆLuCI init.d + IMM configï¼‰
          # ========================================
          echo "ðŸ“ å®‰è£…é…ç½®æ–‡ä»¶..."
          install -m 0644 config_files/tailscale.conf ipk/etc/config/tailscale
          install -m 0755 config_files/tailscale.init ipk/etc/init.d/tailscale
          
          # ========================================
          # éªŒè¯æ–‡ä»¶ç»“æž„
          # ========================================
          echo "âœ… æ–‡ä»¶ç»“æž„ï¼š"
          find ipk -type f -o -type l | sort
          
          echo '2.0' > debian-binary
          
          # ========================================
          # è§£æž targets å¹¶æ‰“åŒ…
          # ========================================
          echo '${{ matrix.targets }}' | jq -r '.[]' | while read ARCH; do
            echo "ðŸ“¦ æ‰“åŒ… ${ARCH}..."
            
            # ========================================
            # ç”Ÿæˆ control æ–‡ä»¶
            # ========================================
            cat > ipk/CONTROL/control <<EOF
          Package: tailscale
          Version: ${VERSION}
          Depends: ca-bundle, kmod-tun
          Provides: tailscaled
          Source: https://github.com/tailscale/tailscale
          License: BSD-3-Clause
          Section: net
          Architecture: ${ARCH}
          Installed-Size: ${SIZE}
          Maintainer: Automated Build <https://github.com/${{ github.repository }}>
          Description: Tailscale VPN client (LuCI compatible build)
           It creates a secure network between your servers, computers,
           and cloud instances. Even when separated by firewalls or subnets.
           .
           Features: UPX compressed, LuCI compatible init.d, /usr/sbin location.
          EOF
            
            # ========================================
            # ç”Ÿæˆ conffilesï¼ˆå›ºä»¶å‡çº§ä¿ç•™é…ç½®ï¼‰
            # ========================================
            cat > ipk/CONTROL/conffiles <<'CONFEOF'
          /etc/config/tailscale
          CONFEOF
            
            # ========================================
            # ç”Ÿæˆ IPK
            # ========================================
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/tailscale_${VERSION}_${ARCH}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            # ========================================
            # ç”Ÿæˆ APK
            # ========================================
            mkdir -p apk-build
            cp -r ipk/* apk-build/
            
            cat > apk-build/.PKGINFO <<APKEOF
          pkgname = tailscale
          pkgver = ${VERSION}
          pkgdesc = Tailscale VPN client (LuCI compatible)
          url = https://tailscale.com
          arch = ${ARCH}
          license = BSD-3-Clause
          size = ${SIZE}
          depend = ca-bundle
          depend = kmod-tun
          provides = tailscaled
          APKEOF
            
            cd apk-build
            tar -czf "../output/tailscale-${VERSION}-r1.${ARCH}.apk" .
            cd ..
            rm -rf apk-build
            
            rm -f control.tar.gz data.tar.gz
          done
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼š"
          ls -lh output/

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.id }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  # ========================================
  # ä»»åŠ¡ 3: ç¼–è¯‘ LuCIï¼ˆç§»é™¤å†²çªæ–‡ä»¶ï¼‰
  # ========================================
  build-luci:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - sdk: SNAPSHOT
            pkg_type: apk
          - sdk: openwrt-24.10
            pkg_type: ipk

    name: "LuCI-${{ matrix.pkg_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: "æ‹‰å– LuCI æºç "
        run: |
          git clone https://github.com/${{ env.LUCI_REPO }} luci-app-tailscale
          cd luci-app-tailscale
          
          # ========================================
          # ðŸ”¥ ç§»é™¤ä¸Ž tailscale åŒ…å†²çªçš„æ–‡ä»¶
          # ========================================
          echo "ðŸ—‘ï¸ ç§»é™¤å†²çªæ–‡ä»¶ï¼ˆç”± tailscale åŒ…æä¾›ï¼‰..."
          
          # ç§»é™¤ init.d è„šæœ¬ï¼ˆç”± tailscale åŒ…æä¾› LuCI ç‰ˆæœ¬ï¼‰
          rm -rf root/etc/init.d
          
          # ç§»é™¤äºŒè¿›åˆ¶æ–‡ä»¶
          rm -rf root/usr/bin 2>/dev/null || true
          rm -rf root/usr/sbin 2>/dev/null || true
          
          # ç§»é™¤é…ç½®æ–‡ä»¶ï¼ˆç”± tailscale åŒ…æä¾›ï¼‰
          rm -rf root/etc/config/tailscale 2>/dev/null || true
          
          echo "âœ… ä¿ç•™çš„æ–‡ä»¶ï¼ˆä»… LuCI Web ç•Œé¢ï¼‰ï¼š"
          find root -type f 2>/dev/null | head -20 || echo "root ç›®å½•ä¸ºç©º"
          
          # ========================================
          # åˆ é™¤ Tailscale ä¾èµ–ï¼ˆç‹¬ç«‹å®‰è£…ï¼‰
          # ========================================
          # sed -i '/LUCI_DEPENDS:=/d' Makefile
          
          # ========================================
          # æ·»åŠ é…ç½®æ–‡ä»¶ä¿æŠ¤
          # ========================================
          if ! grep -q "conffiles" Makefile; then
            sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale_data/\nendef' Makefile
          fi
          
          # ========================================
          # ä¿®æ”¹è·¯å¾„é…ç½®
          # ========================================
          find . -type f \( -name "*.js" -o -name "*.lua" -o -name "*.sh" \) \
            -exec sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" {} \;
          
          # ========================================
          # æ·»åŠ  uci-defaults åˆå§‹åŒ–è„šæœ¬
          # ========================================
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          
          # æ•°æ®ç›®å½•
          D="/etc/config/tailscale_data"
          
          # é¿å…é‡å¤æ‰§è¡Œ
          [ -f "$D/.luci_initialized" ] && exit 0
          
          # åˆ›å»ºæ•°æ®ç›®å½•
          mkdir -p "$D"
          touch "$D/.luci_initialized"
          
          # æ¸…ç†æ—§é…ç½®
          rm -f /etc/config/tailscale-opkg
          
          # è¿ç§»æ—§é…ç½®
          if [ -f /etc/config/tailscale ]; then
            # ä¿®æ­£é…ç½®æ ¼å¼
            sed -i "s|^config settings|config tailscale|g" /etc/config/tailscale
            sed -i "/option state_file/d" /etc/config/tailscale
            sed -i "s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            
            # æ·»åŠ  config_path é…ç½®
            if ! grep -q "option config_path" /etc/config/tailscale; then
              sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
            fi
          fi
          
          # æ¸…ç† ucitrack
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null
          
          # é‡å»º LuCI ç¼“å­˜
          rm -f /tmp/luci-indexcache /tmp/luci-modulecache
          
          # é‡å¯æœåŠ¡ï¼ˆå¦‚æžœå·²å®‰è£… tailscaleï¼‰
          if [ -x /etc/init.d/tailscale ]; then
            /etc/init.d/tailscale restart 2>/dev/null || true
          fi
          
          exit 0
          EOF
          
          chmod +x root/etc/uci-defaults/40_luci-tailscale
          
          echo "âœ… LuCI æºç å‡†å¤‡å®Œæˆ"

      - name: "ç¼–è¯‘"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: x86_64-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "æ”¶é›†äº§ç‰©"
        run: |
          mkdir -p output
          find bin/packages -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp -v {} output/ \;
          
          if [ -z "$(ls -A output/)" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          
          echo "âœ… æ”¶é›†å®Œæˆï¼š"
          ls -lh output/

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.pkg_type }}
          path: output/*
          if-no-files-found: error
          retention-days: 7

  # ========================================
  # ä»»åŠ¡ 4: å‘å¸ƒ Release
  # ========================================
  release:
    needs: [check-version, build-tailscale, build-luci]
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è½½æ‰€æœ‰äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: "æ•´ç†æ–‡ä»¶"
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.apk" -o -name "*.ipk" \) -exec cp -v {} release/ \;
          
          if [ -z "$(ls -A release/)" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•äº§ç‰©æ–‡ä»¶"
            exit 1
          fi
          
          echo "ðŸ“¦ Release æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh release/
          echo ""
          echo "ðŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "IPK æ–‡ä»¶æ•°: $(ls release/*.ipk 2>/dev/null | wc -l)"
          echo "APK æ–‡ä»¶æ•°: $(ls release/*.apk 2>/dev/null | wc -l)"

      - name: "ç”Ÿæˆ Release è¯´æ˜Ž"
        run: |
          cat > release.md <<'EOF'
          ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
          
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} |
          | æž„å»ºæ—¶é—´ | ${{ needs.check-version.outputs.build_time }} CST |
          | UPX åŽ‹ç¼© | ${{ env.ENABLE_COMPRESSION == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} |
          | init.d æ¥æº | LuCI å®˜æ–¹ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰ |
          
          ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
          
          âš ï¸ **é‡è¦ï¼šå¿…é¡»å…ˆå®‰è£… Tailscaleï¼Œå†å®‰è£… LuCI**
          
          ### 1. å®‰è£… Tailscaleï¼ˆå¿…éœ€ï¼‰
          
          æ ¹æ®ä½ çš„æž¶æž„é€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          **APK (OpenWrt ä¸»çº¿):**
          ```bash
          apk add --allow-untrusted tailscale-*.apk
          ```
          
          **IPK (OpenWrt 24.10):**
          ```bash
          opkg install tailscale_*_æž¶æž„.ipk
          ```
          
          ### 2. å®‰è£… LuCI ç•Œé¢ï¼ˆå¯é€‰ï¼‰
          
          **APK:**
          ```bash
          apk add --allow-untrusted luci-app-tailscale-*.apk
          apk add --allow-untrusted luci-i18n-tailscale-zh-cn-*.apk  # ä¸­æ–‡
          ```
          
          **IPK:**
          ```bash
          opkg install luci-app-tailscale_*_all.ipk
          opkg install luci-i18n-tailscale-zh-cn_*_all.ipk  # ä¸­æ–‡
          ```
          
          ### 3. åˆ·æ–° LuCIï¼ˆå¿…éœ€ï¼‰
          
          ```bash
          rm -f /tmp/luci-indexcache
          /etc/init.d/uhttpd restart
          ```
          
          ç„¶åŽè®¿é—® **æœåŠ¡ â†’ Tailscale** å³å¯ã€‚
          
          ## ðŸ“‹ æ”¯æŒçš„æž¶æž„
          
          - **ARM:** arm_cortex-a7, arm_cortex-a9, arm_cortex-a15, ç­‰ 14 ä¸ªå˜ä½“
          - **ARM64:** aarch64_cortex-a53, aarch64_cortex-a72, aarch64_generic, ç­‰
          - **MIPS:** mips_24kc, mips_mips32, ç­‰
          - **MIPS64:** mips64_mips64r2, mips64_octeonplus
          - **x86:** i386_pentium-mmx, i386_pentium4, i386_geode
          - **x86_64:** x86_64
          
          **æŸ¥çœ‹è®¾å¤‡æž¶æž„ï¼š**
          ```bash
          opkg print-architecture
          ```
          
          ## ðŸ”§ é…ç½®è¯´æ˜Ž
          
          - **äºŒè¿›åˆ¶æ–‡ä»¶ï¼š** `/usr/sbin/tailscaled` (ä¸»ç¨‹åº) + `/usr/bin/tailscaled` (è½¯é“¾æŽ¥)
          - **é…ç½®æ–‡ä»¶ï¼š** `/etc/config/tailscale` (IMM æ ¼å¼)
          - **æœåŠ¡è„šæœ¬ï¼š** `/etc/init.d/tailscale` (LuCI å®˜æ–¹ç‰ˆæœ¬ï¼Œè‡ªåŠ¨åŒæ­¥)
          - **æ•°æ®ç›®å½•ï¼š** `/etc/config/tailscale_data/`
          - **æŽˆæƒæ–‡ä»¶ï¼š** `/etc/config/tailscale_data/tailscaled.state`
          
          **ç‰¹æ€§ï¼š**
          - âœ… **LuCI å®Œç¾Žæ”¯æŒ**ï¼ˆæ˜¾ç¤º + æŽ§åˆ¶ï¼‰
          - âœ… **init.d è‡ªåŠ¨åŒæ­¥ LuCI å®˜æ–¹æœ€æ–°ç‰ˆ**
          - âœ… å›ºä»¶å‡çº§ä¿ç•™é…ç½®
          - âœ… é‡æ–°å®‰è£…ä¿ç•™æ•°æ®
          - âœ… UPX åŽ‹ç¼©å‡å°ä½“ç§¯ 50-70%
          - âœ… æ— æ–‡ä»¶å†²çª
          
          ## ðŸ†š ä¸Žå…¶ä»–æž„å»ºå¯¹æ¯”
          
          | ç‰¹æ€§ | IMM å®˜æ–¹åŒ… | GuNanOvO åŒ… | æœ¬æž„å»º |
          |------|-----------|------------|--------|
          | äºŒè¿›åˆ¶ä½ç½® | /usr/sbin | /usr/bin | âœ… /usr/sbin |
          | init.d æ¥æº | IMM å®˜æ–¹ | GuNanOvO | âœ… LuCI å®˜æ–¹ |
          | LuCI æ˜¾ç¤º | âœ… æ­£å¸¸ | âŒ å¼‚å¸¸ | âœ… æ­£å¸¸ |
          | LuCI æŽ§åˆ¶ | âš ï¸ éœ€é…åˆ LuCI åŒ… | âŒ ä¸å¯ç”¨ | âœ… å®Œç¾Ž |
          | UPX åŽ‹ç¼© | âŒ æœªåŽ‹ç¼© | âœ… å·²åŽ‹ç¼© | âœ… å·²åŽ‹ç¼© |
          | åŒ…å¤§å° | ~20MB | ~5-10MB | ~5-10MB |
          | è‡ªåŠ¨æ›´æ–° init.d | âŒ | âŒ | âœ… è·Ÿéš LuCI |
          
          ---
          
          **ä¸Šæ¸¸é¡¹ç›®ï¼š**
          - [tailscale/tailscale](https://github.com/${{ env.TAILSCALE_REPO }})
          - [immortalwrt/packages](https://github.com/${{ env.IMM_PACKAGES_REPO }})
          - [asvow/luci-app-tailscale](https://github.com/${{ env.LUCI_REPO }})
          EOF

      - name: "å‘å¸ƒåˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.version }}
          name: "Tailscale + LuCI ${{ needs.check-version.outputs.version }}"
          bodyFile: release.md
          artifacts: "release/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # ä»»åŠ¡ 5: ç”ŸæˆæŠ¥å‘Š
  # ========================================
  report:
    needs: [check-version, build-tailscale, build-luci]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "ç”ŸæˆæŠ¥å‘Š"
        run: |
          if [ "${{ needs.check-version.outputs.skip }}" = "true" ]; then
            cat > $GITHUB_STEP_SUMMARY <<'EOF'
          # â­ï¸ æž„å»ºè·³è¿‡
          
          **ä¸Šæ¸¸ç‰ˆæœ¬ ${{ needs.check-version.outputs.version }} ä¸Žæœ¬åœ°ç‰ˆæœ¬ ${{ needs.check-version.outputs.current_version }} ç›¸åŒï¼Œæ— éœ€ç¼–è¯‘**
          
          ---
          
          æ£€æŸ¥æ—¶é—´ï¼š${{ needs.check-version.outputs.build_time }} CST
          EOF
          else
            TS_STATUS="${{ needs.build-tailscale.result == 'success' && 'âœ… æˆåŠŸ' || needs.build-tailscale.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}"
            LUCI_STATUS="${{ needs.build-luci.result == 'success' && 'âœ… æˆåŠŸ' || needs.build-luci.result == 'failure' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡' }}"
            COMPRESSION="${{ env.ENABLE_COMPRESSION == 'true' && 'âœ… å·²å¯ç”¨' || 'âŒ æœªå¯ç”¨' }}"
            
            cat > $GITHUB_STEP_SUMMARY <<EOF
          # ðŸŽ¯ æž„å»ºæŠ¥å‘Š
          
          | åç§° | ä¸Šæ¸¸ç‰ˆæœ¬ | åŽ‹ç¼©çŠ¶æ€ | ç¼–è¯‘çŠ¶æ€ |
          |------|---------|---------|---------|
          | Tailscale | ${{ needs.check-version.outputs.version }} | ${COMPRESSION} | ${TS_STATUS} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} | æ— éœ€åŽ‹ç¼© | ${LUCI_STATUS} |
          
          ---
          
          **æž„å»ºæ—¶é—´ï¼š** ${{ needs.check-version.outputs.build_time }} CST
          
          **Releaseï¼š** [${{ needs.check-version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.version }})
          
          **å…³é”®ç‰¹æ€§ï¼š**
          - ðŸ”§ äºŒè¿›åˆ¶ä½ç½®ï¼š/usr/sbin (LuCI å…¼å®¹)
          - ðŸ“ init.d æ¥æºï¼šLuCI å®˜æ–¹ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰
          - ðŸŽ¨ LuCI æŽ§åˆ¶ï¼šå®Œç¾Žæ”¯æŒ
          - ðŸ—œï¸ UPX åŽ‹ç¼©ï¼šå·²å¯ç”¨
          
          **æ”¯æŒæž¶æž„ï¼š** arm (14), arm64 (4), mips (3), mipsle (4), mips64 (2), mips64le (1), 386 (2), amd64 (1), geode (1)
          EOF
          fi
