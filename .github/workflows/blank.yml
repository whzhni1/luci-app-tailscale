name: "æž„å»º Tailscale + LuCIï¼ˆå®Œæ•´ç‰ˆï¼‰"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

env:
  TAILSCALE_REPO: "tailscale/tailscale"
  UPSTREAM_REPO: "GuNanOvO/openwrt-tailscale"
  LUCI_REPO: "asvow/luci-app-tailscale"

jobs:
  # ========================================
  # ä»»åŠ¡ 1: æ£€æŸ¥ç‰ˆæœ¬
  # ========================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      version: ${{ steps.check.outputs.version }}
      build_time: ${{ steps.time.outputs.time }}
      luci_version: ${{ steps.luci.outputs.version }}
    steps:
      - name: "æ£€æŸ¥ç‰ˆæœ¬"
        id: check
        run: |
          upstream=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/tags" | jq -r '.[0].name // "none"')
          current=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[0].name // "none"')
          
          echo "ä¸Šæ¸¸: $upstream"
          echo "å½“å‰: $current"
          
          if [ "$upstream" = "$current" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "version=$upstream" >> $GITHUB_OUTPUT
          fi

      - name: "èŽ·å– LuCI ç‰ˆæœ¬"
        id: luci
        if: steps.check.outputs.skip == 'false'
        run: |
          version=$(curl -s "https://api.github.com/repos/${{ env.LUCI_REPO }}/tags" | jq -r '.[0].name // "v1.0.0"')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: "ç”Ÿæˆæž„å»ºæ—¶é—´"
        id: time
        if: steps.check.outputs.skip == 'false'
        run: echo "time=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  # ========================================
  # ä»»åŠ¡ 2: ç¼–è¯‘ Tailscaleï¼ˆAPK + IPKï¼‰
  # ========================================
  build-tailscale:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { id: 'arm', goarch: 'arm', targets: ['arm_cortex-a7', 'arm_cortex-a9', 'arm_cortex-a5_vfpv4'] }
          - { id: 'arm64', goarch: 'arm64', targets: ['aarch64_cortex-a53', 'aarch64_cortex-a72', 'aarch64_generic'] }
          - { id: 'mips', goarch: 'mips', gomips: 'softfloat', targets: ['mips_24kc', 'mips_mips32'] }
          - { id: 'mipsle', goarch: 'mipsle', gomips: 'softfloat', targets: ['mipsel_24kc', 'mipsel_74kc'] }
          - { id: 'amd64', goarch: 'amd64', cgo: '1', cc: 'musl-gcc', setup: 'sudo apt-get update && sudo apt-get install -y musl-tools', targets: ['x86_64'] }

    name: "Tailscale-${{ matrix.platform.id }}"

    steps:
      - name: "çŽ¯å¢ƒå‡†å¤‡"
        run: ${{ matrix.platform.setup || 'echo "è·³è¿‡"' }}

      - name: "æ£€å‡º Tailscale æºç "
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAILSCALE_REPO }}
          ref: ${{ needs.check-version.outputs.version }}
          path: src

      - name: "ä¸‹è½½æ‰“åŒ…æ–‡ä»¶"
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          path: packaging

      - name: "è®¾ç½® Go"
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: "ç¼–è¯‘äºŒè¿›åˆ¶"
        working-directory: src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.platform.goarch }}
          GOMIPS: ${{ matrix.platform.gomips || '' }}
          CGO_ENABLED: ${{ matrix.platform.cgo || '0' }}
          CC: ${{ matrix.platform.cc || '' }}
        run: |
          output="tailscaled-linux-${{ matrix.platform.id }}"
          go="go"
          
          eval `CGO_ENABLED=0 GOOS=$(go env GOHOSTOS) GOARCH=$(go env GOHOSTARCH) go run ./cmd/mkversion`
          
          tags="ts_include_cli,ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_completion,ts_omit_ssh,ts_omit_wakeonlan,ts_omit_capture,ts_omit_relayserver,ts_omit_systray,ts_omit_taildrop,ts_omit_tpm,ts_omit_syspolicy,ts_omit_debugeventbus,ts_omit_webclient"
          ldflags="-X tailscale.com/version.longStamp=${VERSION_LONG} -X tailscale.com/version.shortStamp=${VERSION_SHORT} -s -w"
          
          mkdir -p ../build
          go build -tags "${tags}" -ldflags "${ldflags}" -trimpath -o "../build/${output}" ./cmd/tailscaled
          
          chmod +x "../build/${output}"

      - name: "æ‰“åŒ… IPK å’Œ APK"
        run: |
          VERSION=$(echo "${{ needs.check-version.outputs.version }}" | sed 's/^v//')
          EPOCH=$(date +%s)
          
          mkdir -p ipk/usr/bin ipk/etc ipk/lib ipk/CONTROL
          mkdir -p output
          
          binary="build/tailscaled-linux-${{ matrix.platform.id }}"
          install -m 0755 "${binary}" ipk/usr/bin/tailscaled
          ln -sf tailscaled ipk/usr/bin/tailscale
          
          SIZE=$(du -sb ipk/usr/bin | awk '{print $1}')
          
          cp -a packaging/etc/* ipk/etc/
          cp -a packaging/lib/* ipk/lib/
          cp -a packaging/CONTROL/* ipk/CONTROL/
          chmod +x ipk/etc/init.d/tailscale
          
          echo '2.0' > debian-binary
          
          targets='${{ toJson(matrix.platform.targets) }}'
          echo "$targets" | jq -r '.[]' | while read ARCH; do
            # ç”Ÿæˆ IPK
            sed -e "s/__VERSION__/${VERSION}/" \
                -e "s/__ARCH__/${ARCH}/" \
                -e "s/__SIZE__/${SIZE}/" \
                -e "s/__EPOCH__/${EPOCH}/" \
                packaging/CONTROL/control > ipk/CONTROL/control
            
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc ./lib
            tar --format=gnu --numeric-owner --group=0 --owner=0 -czf "output/tailscale_${VERSION}_${ARCH}.ipk" ./control.tar.gz ./data.tar.gz ./debian-binary
            
            # ç”Ÿæˆ APK
            mkdir -p apk-build
            cp -r ipk/* apk-build/
            
            cat > apk-build/.PKGINFO <<EOF
          pkgname = tailscale
          pkgver = ${VERSION}
          pkgdesc = Tailscale VPN client
          url = https://tailscale.com
          arch = ${ARCH}
          license = BSD
          size = ${SIZE}
          EOF
            
            cd apk-build
            tar -czf "../output/tailscale-${VERSION}-r1.${ARCH}.apk" .
            cd ..
            rm -rf apk-build
            
            rm -f control.tar.gz data.tar.gz
          done

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.platform.id }}
          path: output/*

  # ========================================
  # ä»»åŠ¡ 3: ç¼–è¯‘ LuCI
  # ========================================
  build-luci:
    needs: check-version
    if: needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - sdk: SNAPSHOT
            pkg_type: apk
          - sdk: openwrt-24.10
            pkg_type: ipk

    name: "LuCI-${{ matrix.pkg_type }}"

    steps:
      - uses: actions/checkout@v4

      - name: "æ‹‰å– LuCI æºç "
        run: |
          git clone https://github.com/${{ env.LUCI_REPO }} luci-app-tailscale
          cd luci-app-tailscale
          
          # åˆ é™¤ Tailscale ä¾èµ–
          sed -i '/LUCI_DEPENDS:=/d' Makefile
          
          # æ·»åŠ é…ç½®ä¿æŠ¤
          if ! grep -q "conffiles" Makefile; then
            sed -i '/^PKG_VERSION:=/a\\ndefine Package/luci-app-tailscale/conffiles\n/etc/config/tailscale\n/etc/config/tailscale_data/\nendef' Makefile
          fi
          
          # ä¿®æ”¹è·¯å¾„
          find . -type f \( -name "*.js" -o -name "tailscale" -o -name "*.sh" \) -exec sed -i "s|'/etc/tailscale'|'/etc/config/tailscale_data'|g" {} \;
          sed -i 's|/var/lib/tailscale|/var/run/tailscale|g' root/etc/init.d/tailscale 2>/dev/null || true
          
          # uci-defaults
          mkdir -p root/etc/uci-defaults
          cat > root/etc/uci-defaults/40_luci-tailscale <<'EOF'
          #!/bin/sh
          D="/etc/config/tailscale_data"
          [ -f "$D/.initialized" ] && exit 0
          mkdir -p "$D" && touch "$D/.initialized"
          rm -f /etc/config/tailscale-opkg
          [ -f /etc/config/tailscale ] && {
            sed -i "s|^config settings|config tailscale|g;/option state_file/d;s|'/etc/tailscale'|'$D'|g" /etc/config/tailscale
            grep -q "option config_path" /etc/config/tailscale || sed -i "/option port/a\\	option config_path '$D'" /etc/config/tailscale
          }
          uci -q delete ucitrack.@tailscale[-1] 2>/dev/null
          rm -f /tmp/luci-indexcache
          EOF
          chmod +x root/etc/uci-defaults/40_luci-tailscale

      - name: "ç¼–è¯‘"
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: x86_64-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-tailscale
          NO_REFRESH_CHECK: true

      - name: "æ”¶é›†äº§ç‰©"
        run: |
          mkdir -p output
          find bin/packages -name "*luci*tailscale*.${{ matrix.pkg_type }}" -exec cp -v {} output/ \;

      - name: "ä¸Šä¼ äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: luci-${{ matrix.pkg_type }}
          path: output/*

  # ========================================
  # ä»»åŠ¡ 4: å‘å¸ƒ Release
  # ========================================
  release:
    needs: [check-version, build-tailscale, build-luci]
    runs-on: ubuntu-latest
    steps:
      - name: "ä¸‹è½½æ‰€æœ‰äº§ç‰©"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "æ•´ç†æ–‡ä»¶"
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.apk" -o -name "*.ipk" \) -exec cp -v {} release/ \;
          ls -lh release/

      - name: "ç”Ÿæˆ Release è¯´æ˜Ž"
        id: release_body
        run: |
          cat > release.md <<'EOF'
          ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
          
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | Tailscale | ${{ needs.check-version.outputs.version }} |
          | LuCI | ${{ needs.check-version.outputs.luci_version }} |
          | æž„å»ºæ—¶é—´ | ${{ needs.check-version.outputs.build_time }} CST |
          
          ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
          
          ### 1. å®‰è£… Tailscaleï¼ˆå¿…éœ€ï¼‰
          
          æ ¹æ®ä½ çš„æž¶æž„é€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          **APK (OpenWrt ä¸»çº¿):**
          ```bash
          apk add --allow-untrusted tailscale-*.apk
          ```
          
          **IPK (OpenWrt 24.10):**
          ```bash
          opkg install tailscale_*_æž¶æž„.ipk
          ```
          
          ### 2. å®‰è£… LuCI ç•Œé¢ï¼ˆå¯é€‰ï¼‰
          
          **APK:**
          ```bash
          apk add --allow-untrusted luci-app-tailscale-*.apk
          apk add --allow-untrusted luci-i18n-tailscale-zh-cn-*.apk  # ä¸­æ–‡
          ```
          
          **IPK:**
          ```bash
          opkg install luci-app-tailscale_*_all.ipk
          opkg install luci-i18n-tailscale-zh-cn_*_all.ipk  # ä¸­æ–‡
          ```
          
          ## ðŸ“‹ å¦‚ä½•æŸ¥çœ‹è®¾å¤‡æž¶æž„
          
          ```bash
          opkg print-architecture
          ```
          
          ## ðŸ”§ é…ç½®è¯´æ˜Ž
          
          - é…ç½®æ–‡ä»¶ï¼š`/etc/config/tailscale`
          - æ•°æ®ç›®å½•ï¼š`/etc/config/tailscale_data/`
          - æŽˆæƒæ–‡ä»¶ï¼š`/etc/config/tailscale_data/tailscaled.state`
          
          **ç‰¹æ€§ï¼š**
          - âœ… é‡æ–°å®‰è£…ä¿ç•™é…ç½®
          - âœ… å›ºä»¶å‡çº§ä¿ç•™æ•°æ®
          - âœ… æ— éœ€æ‰‹åŠ¨å®‰è£…ä¾èµ–
          
          ---
          
          **ä¸Šæ¸¸é¡¹ç›®ï¼š**
          - [tailscale/tailscale](https://github.com/${{ env.TAILSCALE_REPO }})
          - [GuNanOvO/openwrt-tailscale](https://github.com/${{ env.UPSTREAM_REPO }})
          - [asvow/luci-app-tailscale](https://github.com/${{ env.LUCI_REPO }})
          EOF

      - name: "å‘å¸ƒåˆ° Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.check-version.outputs.version }}
          name: "Tailscale + LuCI ${{ needs.check-version.outputs.version }}"
          bodyFile: release.md
          artifacts: "release/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # ä»»åŠ¡ 5: ç”ŸæˆæŠ¥å‘Š
  # ========================================
  report:
    needs: [check-version, build-tailscale, build-luci, release]
    if: always() && needs.check-version.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: "ç”ŸæˆæŠ¥å‘Š"
        run: |
          cat > $GITHUB_STEP_SUMMARY <<'EOF'
          # æž„å»ºæŠ¥å‘Š
          
          | é¡¹ç›® | å€¼ |
          |------|-----|
          | Tailscale ç‰ˆæœ¬ | `${{ needs.check-version.outputs.version }}` |
          | LuCI ç‰ˆæœ¬ | `${{ needs.check-version.outputs.luci_version }}` |
          | æž„å»ºæ—¶é—´ | ${{ needs.check-version.outputs.build_time }} CST |
          | Release | [${{ needs.check-version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.version }}) |
          
          ## ç¼–è¯‘çŠ¶æ€
          
          | ç»„ä»¶ | çŠ¶æ€ |
          |------|------|
          | Tailscale APK+IPK | ${{ needs.build-tailscale.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | LuCI APK+IPK | ${{ needs.build-luci.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | Release | ${{ needs.release.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          EOF
