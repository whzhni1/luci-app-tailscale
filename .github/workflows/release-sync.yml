name: åŒæ­¥ GitHub ä»“åº“åˆ° Gitee

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - github_owner: "gdy666"
            github_repo: "luci-app-lucky"
            gitee_owner: "whzhni"
            gitee_repo: "lucky"
          - github_owner: "eamonxg"
            github_repo: "luci-theme-aurora"
            gitee_owner: "whzhni"
            gitee_repo: "luci-theme-aurora"
      fail-fast: false
    
    name: åŒæ­¥ ${{ matrix.repo.github_repo }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ” è·å– GitHub æœ€æ–°æ ‡ç­¾
        id: github_tag
        run: |
          GH_TAG=$(curl -s https://api.github.com/repos/${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}/tags | jq -r '.[0].name // empty')
          if [ -z "$GH_TAG" ] || [ "$GH_TAG" = "null" ]; then
            echo "::warning::æœªæ‰¾åˆ° GitHub æ ‡ç­¾ï¼Œè·³è¿‡ ${{ matrix.repo.github_repo }}"
            echo "github_tag=" >> $GITHUB_OUTPUT
          else
            echo "github_tag=$GH_TAG" >> $GITHUB_OUTPUT
            echo "âœ… GitHub æœ€æ–°æ ‡ç­¾: $GH_TAG"
          fi

      - name: ğŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å­˜åœ¨
        id: check_gitee
        if: steps.github_tag.outputs.github_tag != ''
        run: |
          GITHUB_TAG="${{ steps.github_tag.outputs.github_tag }}"
          
          # ä½¿ç”¨ Gitee API è·å–æŒ‡å®š tag çš„ release
          response=$(curl -s -w "\n%{http_code}" \
            "https://gitee.com/api/v5/repos/${{ matrix.repo.gitee_owner }}/${{ matrix.repo.gitee_repo }}/releases/tags/${GITHUB_TAG}?access_token=${{ secrets.GITEE_TOKEN }}")
          
          HTTP_CODE=$(echo "$response" | tail -n1)
          BODY=$(echo "$response" | sed '$d')
          
          echo "ğŸ“ API URL: https://gitee.com/api/v5/repos/${{ matrix.repo.gitee_owner }}/${{ matrix.repo.gitee_repo }}/releases/tags/${GITHUB_TAG}"
          echo "ğŸ“ HTTP çŠ¶æ€ç : $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "::notice::[${{ matrix.repo.gitee_repo }}] Gitee å·²å­˜åœ¨ Release $GITHUB_TAGï¼Œæ— éœ€åŒæ­¥"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "::notice::[${{ matrix.repo.gitee_repo }}] Gitee ä¸å­˜åœ¨ Release $GITHUB_TAGï¼Œéœ€è¦åŒæ­¥"
          else
            # å…¶ä»–é”™è¯¯æƒ…å†µ
            echo "::warning::æ— æ³•ç¡®å®š Release çŠ¶æ€ (HTTP $HTTP_CODE)ï¼Œè·³è¿‡åŒæ­¥"
            echo "$BODY" | jq '.' || echo "$BODY"
            echo "new_version=false" >> $GITHUB_OUTPUT
          fi
      - name: â¬‡ï¸ ä¸‹è½½ GitHub Release èµ„æº
        if: steps.check_gitee.outputs.new_version == 'true'
        run: |
          TAG=${{ steps.github_tag.outputs.github_tag }}
          GITHUB_REPO="${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}"
          
          mkdir -p out
          echo "ğŸ“¦ è·å– $GITHUB_REPO Release ä¿¡æ¯ (Tag: $TAG)..."
          
          release_info=$(curl -s https://api.github.com/repos/$GITHUB_REPO/releases/tags/$TAG)
          
          # ä¸‹è½½ Release é™„ä»¶
          assets_count=$(echo "$release_info" | jq '.assets | length')
          if [ "$assets_count" -gt 0 ]; then
            echo "ğŸ“¥ ä¸‹è½½ $assets_count ä¸ª Release é™„ä»¶..."
            echo "$release_info" | jq -r '.assets[].browser_download_url' | while read url; do
              echo "  â†“ $(basename $url)"
              curl -L -o "out/$(basename $url)" "$url"
            done
          else
            echo "âš ï¸  æœªæ‰¾åˆ° Release é™„ä»¶"
          fi
          
          # ä¸‹è½½æºç åŒ…
          echo "ğŸ“¥ ä¸‹è½½æºç åŒ…..."
          curl -L -o "out/source-$TAG.zip" "https://github.com/$GITHUB_REPO/archive/refs/tags/$TAG.zip"
          curl -L -o "out/source-$TAG.tar.gz" "https://github.com/$GITHUB_REPO/archive/refs/tags/$TAG.tar.gz"
          
          echo "âœ… ä¸‹è½½å®Œæˆ:"
          ls -lh out

      - name: ğŸ“¤ å‘å¸ƒåˆ° Gitee
        if: steps.check_gitee.outputs.new_version == 'true'
        run: |
          chmod +x .github/scripts/release-gitee.sh
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          VERSION=${{ steps.github_tag.outputs.github_tag }}
          
          .github/scripts/release-gitee.sh \
            "${{ matrix.repo.gitee_owner }}/${{ matrix.repo.gitee_repo }}" \
            "${{ secrets.GITEE_TOKEN }}" \
            "$VERSION" \
            "$VERSION" \
            "$BUILD_TIME" \
            "${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}" \
            "${{ matrix.repo.github_repo }}"
