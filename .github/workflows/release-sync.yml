name: åŒæ­¥ luci-app-lucky åˆ° Gitee

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 23 * * *'   # æ¯å¤© UTC 23:00 = åŒ—äº¬æ—¶é—´ 07:00

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ” è·å– GitHub æœ€æ–°æ ‡ç­¾
        id: github_tag
        run: |
          GH_TAG=$(curl -s https://api.github.com/repos/gdy666/luci-app-lucky/tags | jq -r '.[0].name')
          echo "github_tag=$GH_TAG" >> $GITHUB_OUTPUT
          echo "GitHub æœ€æ–°ç‰ˆæœ¬: $GH_TAG"

      - name: ğŸ” è·å– Gitee æœ€æ–°æ ‡ç­¾
        id: gitee_tag
        run: |
          GITEE_TAG=$(curl -s "https://gitee.com/api/v5/repos/whzhni/luci-app-lucky/tags?access_token=${{ secrets.GITEE_TOKEN }}" | jq -r '.[0].name')
          echo "gitee_tag=$GITEE_TAG" >> $GITHUB_OUTPUT
          echo "Gitee æœ€æ–°ç‰ˆæœ¬: $GITEE_TAG"

      - name: ğŸ”„ æ¯”è¾ƒç‰ˆæœ¬
        id: compare
        run: |
          if [ "${{ steps.github_tag.outputs.github_tag }}" != "${{ steps.gitee_tag.outputs.gitee_tag }}" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "::notice::æ£€æµ‹åˆ° GitHub æœ‰æ–°ç‰ˆæœ¬: ${{ steps.github_tag.outputs.github_tag }}"
          else
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "::notice::GitHub ä¸ Gitee ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥ï¼Œä»Šå¤©è·³è¿‡ä¸‹è½½å’Œä¸Šä¼ "
          fi

      - name: â¬‡ï¸ ä¸‹è½½ GitHub Release èµ„æº
        if: steps.compare.outputs.new_version == 'true'
        run: |
          TAG=${{ steps.github_tag.outputs.github_tag }}
          mkdir -p out
          echo "è·å– GitHub Release ä¿¡æ¯..."
          release_info=$(curl -s https://api.github.com/repos/gdy666/luci-app-lucky/releases/tags/$TAG)
          echo "ä¸‹è½½ Release é™„ä»¶..."
          echo "$release_info" | jq -r '.assets[].browser_download_url' | while read url; do
            echo "ä¸‹è½½: $url"
            curl -L -o "out/$(basename $url)" "$url"
          done
          echo "ä¸‹è½½æºç åŒ…..."
          curl -L -o "out/source-$TAG.zip" "https://github.com/gdy666/luci-app-lucky/archive/refs/tags/$TAG.zip"
          curl -L -o "out/source-$TAG.tar.gz" "https://github.com/gdy666/luci-app-lucky/archive/refs/tags/$TAG.tar.gz"
          ls -lh out

      - name: ğŸ“¤ å‘å¸ƒåˆ° Gitee
        if: steps.compare.outputs.new_version == 'true'
        run: |
          chmod +x .github/scripts/release-gitee.sh
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          VERSION=${{ steps.github_tag.outputs.github_tag }}
          .github/scripts/release-gitee.sh \
            "whzhni/luci-app-lucky" \
            "${{ secrets.GITEE_TOKEN }}" \
            "$VERSION" \
            "$VERSION" \
            "$BUILD_TIME" \
            "gdy666/luci-app-lucky"
