name: åŒæ­¥ GitHub ä»“åº“åˆ° Gitee

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - github_owner: "gdy666"
            github_repo: "luci-app-lucky"
            gitee_owner: "whzhni"
            gitee_repo: "lucky"
          - github_owner: "eamonxg"
            github_repo: "luci-theme-aurora"
            gitee_owner: "whzhni"
            gitee_repo: "luci-theme-aurora"
      fail-fast: false
    
    name: åŒæ­¥ ${{ matrix.repo.github_repo }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ğŸ” è·å– GitHub æœ€æ–°æ ‡ç­¾
        id: github_tag
        run: |
          GH_TAG=$(curl -s https://api.github.com/repos/${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}/tags | jq -r '.[0].name // empty')
          if [ -z "$GH_TAG" ]; then
            echo "::warning::æœªæ‰¾åˆ° GitHub æ ‡ç­¾ï¼Œè·³è¿‡ ${{ matrix.repo.github_repo }}"
            echo "github_tag=" >> $GITHUB_OUTPUT
          else
            echo "github_tag=$GH_TAG" >> $GITHUB_OUTPUT
            echo "âœ… GitHub æœ€æ–°æ ‡ç­¾: $GH_TAG"
          fi

      - name: ğŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å­˜åœ¨
        id: check_gitee
        if: steps.github_tag.outputs.github_tag != ''
        run: |
          GITHUB_TAG="${{ steps.github_tag.outputs.github_tag }}"
          
          echo "ğŸ“ æ£€æŸ¥æ ‡ç­¾: $GITHUB_TAG"
          
          # è°ƒç”¨ Gitee API è·å–æŒ‡å®šæ ‡ç­¾çš„ Release
          response=$(curl -s -w "\n%{http_code}" \
            "https://gitee.com/api/v5/repos/${{ matrix.repo.gitee_owner }}/${{ matrix.repo.gitee_repo }}/releases/tags/${GITHUB_TAG}?access_token=${{ secrets.GITEE_TOKEN }}")
          
          # åˆ†ç¦» HTTP çŠ¶æ€ç å’Œå“åº”ä½“
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“ HTTP çŠ¶æ€ç : $http_code"
          
          # æ£€æŸ¥ HTTP çŠ¶æ€ç 
          if [ "$http_code" != "200" ]; then
            echo "::notice::API è¿”å›çŠ¶æ€ç  $http_codeï¼Œåˆ¤æ–­ä¸ºä¸å­˜åœ¨"
            echo "new_version=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
          if ! echo "$body" | jq empty > /dev/null 2>&1; then
            echo "::warning::API è¿”å›é JSON æ ¼å¼ï¼Œå“åº”å†…å®¹:"
            echo "$body" | head -n 5
            echo "::notice::æ— æ³•è§£æå“åº”ï¼Œä¸ºå®‰å…¨èµ·è§åˆ¤æ–­ä¸ºéœ€è¦åŒæ­¥"
            echo "new_version=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå– tag_name
          GITEE_TAG=$(echo "$body" | jq -r '.tag_name // empty')
          
          if [ -n "$GITEE_TAG" ]; then
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "::notice::[${{ matrix.repo.gitee_repo }}] âœ… Gitee å·²å­˜åœ¨ Release $GITEE_TAGï¼Œæ— éœ€åŒæ­¥"
          else
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "::notice::[${{ matrix.repo.gitee_repo }}] ğŸ†• Gitee ä¸å­˜åœ¨ Release $GITHUB_TAGï¼Œéœ€è¦åŒæ­¥"
          fi

      - name: â¬‡ï¸ ä¸‹è½½ GitHub Release èµ„æº
        if: steps.check_gitee.outputs.new_version == 'true'
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œä¸ç«‹å³é€€å‡º
          
          TAG=${{ steps.github_tag.outputs.github_tag }}
          GITHUB_REPO="${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}"
          
          mkdir -p out
          echo "ğŸ“¦ è·å– $GITHUB_REPO Release ä¿¡æ¯ (Tag: $TAG)..."
          
          release_info=$(curl -s https://api.github.com/repos/$GITHUB_REPO/releases/tags/$TAG)
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å– Release ä¿¡æ¯
          if ! echo "$release_info" | jq -e '.tag_name' > /dev/null 2>&1; then
            echo "::warning::æœªæ‰¾åˆ° Release $TAGï¼Œå°è¯•ç»§ç»­..."
          fi
          
          # ä¸‹è½½ Release é™„ä»¶
          assets_count=$(echo "$release_info" | jq '.assets | length' 2>/dev/null || echo "0")
          if [ "$assets_count" -gt 0 ]; then
            echo "ğŸ“¥ ä¸‹è½½ $assets_count ä¸ª Release é™„ä»¶..."
            echo "$release_info" | jq -r '.assets[].browser_download_url' | while read url; do
              if [ -n "$url" ]; then
                filename=$(basename "$url")
                echo "  â†“ ä¸‹è½½: $filename"
                # æ·»åŠ é‡è¯•å’Œé”™è¯¯å¤„ç†
                if curl -fsSL --retry 3 --retry-delay 2 --connect-timeout 30 -o "out/$filename" "$url"; then
                  echo "    âœ… æˆåŠŸ: $filename"
                else
                  echo "    âš ï¸  å¤±è´¥: $filename (è·³è¿‡)"
                fi
              fi
            done
          else
            echo "âš ï¸  æœªæ‰¾åˆ° Release é™„ä»¶"
          fi
          
          # ä¸‹è½½æºç åŒ…
          echo "ğŸ“¥ ä¸‹è½½æºç åŒ…..."
          
          # ZIP æ ¼å¼
          if curl -fsSL --retry 3 --retry-delay 2 --connect-timeout 30 \
            -o "out/source-$TAG.zip" \
            "https://github.com/$GITHUB_REPO/archive/refs/tags/$TAG.zip"; then
            echo "  âœ… ZIP: source-$TAG.zip"
          else
            echo "  âš ï¸  ZIP ä¸‹è½½å¤±è´¥ (è·³è¿‡)"
          fi
          
          # TAR.GZ æ ¼å¼
          if curl -fsSL --retry 3 --retry-delay 2 --connect-timeout 30 \
            -o "out/source-$TAG.tar.gz" \
            "https://github.com/$GITHUB_REPO/archive/refs/tags/$TAG.tar.gz"; then
            echo "  âœ… TAR.GZ: source-$TAG.tar.gz"
          else
            echo "  âš ï¸  TAR.GZ ä¸‹è½½å¤±è´¥ (è·³è¿‡)"
          fi
          
          echo ""
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨:"
          ls -lh out/ 2>/dev/null || echo "  (æ— æ–‡ä»¶)"
          
          # æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªæ–‡ä»¶
          file_count=$(ls -1 out/ 2>/dev/null | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "::warning::æœªæˆåŠŸä¸‹è½½ä»»ä½•æ–‡ä»¶"
            exit 0  # ä¸ç®—å¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
          fi
          
          set -e  # æ¢å¤é”™è¯¯æ—¶é€€å‡º

      - name: ğŸ§¹ è¿‡æ»¤ luci-app-lucky æ—§ç‰ˆæœ¬æ–‡ä»¶
        if: steps.check_gitee.outputs.new_version == 'true' && matrix.repo.github_repo == 'luci-app-lucky'
        run: |
          TAG=${{ steps.github_tag.outputs.github_tag }}
          # å»æ‰ç‰ˆæœ¬å·çš„ v å‰ç¼€
          VERSION=${TAG#v}
          
          echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $VERSION"
          echo ""
          echo "ğŸ“‚ è¿‡æ»¤å‰çš„æ–‡ä»¶:"
          ls -1 out/ 2>/dev/null || true
          echo ""
          
          cd out
          
          # æ ‡è®°æ˜¯å¦å·²ä¿ç•™ luci-app å’Œ luci-i18n æ–‡ä»¶
          luci_app_kept=false
          luci_i18n_kept=false
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾ä¿ç•™çš„æ–‡ä»¶
          mkdir -p ../keep
          
          for file in *; do
            # è·³è¿‡æºç åŒ…
            if [[ "$file" == source-* ]]; then
              echo "  âœ… ä¿ç•™æºç åŒ…: $file"
              mv "$file" ../keep/
              continue
            fi
            
            # è§„åˆ™1: luci-app- å¼€å¤´çš„æ–‡ä»¶ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ª
            if [[ "$file" == luci-app-* ]]; then
              if [ "$luci_app_kept" = false ]; then
                echo "  âœ… ä¿ç•™ luci-app: $file"
                mv "$file" ../keep/
                luci_app_kept=true
              else
                echo "  âŒ åˆ é™¤å¤šä½™ luci-app: $file"
                rm -f "$file"
              fi
              continue
            fi
            
            # è§„åˆ™2: luci-i18n å¼€å¤´çš„æ–‡ä»¶ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ª
            if [[ "$file" == luci-i18n* ]]; then
              if [ "$luci_i18n_kept" = false ]; then
                echo "  âœ… ä¿ç•™ luci-i18n: $file"
                mv "$file" ../keep/
                luci_i18n_kept=true
              else
                echo "  âŒ åˆ é™¤å¤šä½™ luci-i18n: $file"
                rm -f "$file"
              fi
              continue
            fi
            
            # è§„åˆ™3: åŒ…å«å½“å‰ç‰ˆæœ¬å·ä¸”åŒ…å« wanji çš„æ–‡ä»¶
            if [[ "$file" == *"$VERSION"* ]] && [[ "$file" == *wanji* ]]; then
              echo "  âœ… ä¿ç•™ç‰ˆæœ¬+wanji: $file"
              mv "$file" ../keep/
              continue
            fi
            
            # å…¶ä»–æ–‡ä»¶åˆ é™¤
            echo "  âŒ åˆ é™¤æ—§ç‰ˆæœ¬: $file"
            rm -f "$file"
          done
          
          # å°†ä¿ç•™çš„æ–‡ä»¶ç§»å› out ç›®å½•
          cd ..
          rm -rf out
          mv keep out
          
          echo ""
          echo "ğŸ¯ è¿‡æ»¤åçš„æ–‡ä»¶:"
          ls -lh out/ 2>/dev/null || echo "  (æ— æ–‡ä»¶)"

      - name: ğŸ“¤ å‘å¸ƒåˆ° Gitee
        if: steps.check_gitee.outputs.new_version == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦å‘å¸ƒ
          if [ ! -d "out" ] || [ -z "$(ls -A out 2>/dev/null)" ]; then
            echo "::warning::æ²¡æœ‰æ–‡ä»¶å¯å‘å¸ƒï¼Œè·³è¿‡"
            exit 0
          fi
          
          chmod +x .github/scripts/release-gitee.sh
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          VERSION=${{ steps.github_tag.outputs.github_tag }}
          
          .github/scripts/release-gitee.sh \
            "${{ matrix.repo.gitee_owner }}/${{ matrix.repo.gitee_repo }}" \
            "${{ secrets.GITEE_TOKEN }}" \
            "$VERSION" \
            "$VERSION" \
            "$BUILD_TIME" \
            "${{ matrix.repo.github_owner }}/${{ matrix.repo.github_repo }}" \
            "${{ matrix.repo.github_repo }}"
